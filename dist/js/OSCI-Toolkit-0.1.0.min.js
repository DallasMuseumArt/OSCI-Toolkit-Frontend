/*
 * OSCI Toolkit - v0.1.0 - 2013-01-20
 * http://oscitoolkit.org/
 * Copyright (c) 2010-2013 The Art Institute of Chicago and the Indianapolis Museum of Art
 * GNU General Public License
 */
function loadXMLDoc(e){return xhttp=new XMLHttpRequest,xhttp.overrideMimeType("text/xml"),xhttp.open("GET",e,!1),xhttp.send(),xhttp.responseXML}function xmlToJson(e,t){var n=!0,r=0;if(!t){t=["xml:"];for(r=0;r<e.documentElement.attributes.length;r++)e.documentElement.attributes.item(r).nodeName.indexOf("xmlns")!=-1&&t.push(e.documentElement.attributes.item(r).nodeName.replace("xmlns:","")+":")}var i=!0;if(e.attributes&&e.attributes.length>0){var s;i={};for(var o=0;o<e.attributes.length;o++)s=e.attributes.item(o),i[s.nodeName.replaceArray(t,"").toCamel()]=s.nodeValue}if(e.hasChildNodes()){var u,a,f;i===!0&&(i={});for(var l=0;l<e.childNodes.length;l++){f=e.childNodes.item(l);if((f.nodeType&7)===1)u=f.nodeName.replaceArray(t,"").toCamel(),a=xmlToJson(f,t),i.hasOwnProperty(u)?(i[u].constructor!==Array&&(i[u]=[i[u]]),i[u].push(a)):i[u]=a;else if((f.nodeType-1|1)===3){u="value",a=f.nodeType===3?f.nodeValue.replace(/^\s+|\s+$/g,""):f.nodeValue;if(i.hasOwnProperty(u))i[u]+=a;else if(f.nodeType===4||a!=="")i[u]=a}}}return i}function objectToArray(e){if(e===undefined)return;return Object.prototype.toString.call(e)!=="[object Array]"?[e]:e}function outerHTML(e){return e.outerHTML||function(e){var t=document.createElement("div"),n;return t.appendChild(e.cloneNode(!0)),n=t.innerHTML,t=null,n}(e)}function liMousemove(e){if(window.liCollection&&liCollection.userIsDraggingAsset){var t=liCollection.find(liCollection.userIsDraggingAsset);if(t){if(!t.settings.dragging)return;t.refreshViewfinderViewport(),e.conservationDraggingRemove&&(t.settings.dragging=undefined,liCollection.userIsDraggingAsset=!1)}}}function liMouseup(e){window.liCollection&&liCollection.userIsDraggingAsset&&(e.conservationDraggingRemove=!0,liMousemove(e))}OsciTk={},OsciTk.collections={},OsciTk.models={},OsciTk.templates={},OsciTk.views={figureTypeRegistry:{}},String.prototype.replaceArray=function(e,t){var n=this;for(var r=0;r<e.length;r++)n=n.replace(e[r],t);return n},String.prototype.toCamel=function(){return this.replace(/\s(.)/g,function(e){return e.toUpperCase()}).replace(/\s/g,"").replace(/^(.)/,function(e){return e.toLowerCase()})},OsciTk.router=Backbone.Router.extend({routes:{"":"routeToSection","section/:section_id":"routeToSection","section/:section_id/:identifier":"routeToSection"},routeToSection:function(e,t){Backbone.trigger("routedToSection",{section_id:e,identifier:t})}}),OsciTk.templateManager={get:function(e){return function(t){return OsciTk.templateManager.useTemplate(e,t)}},useTemplate:function(e,t){if(OsciTk.templates[e]===undefined){var n=app.config.get("templateUrls"),r=!1,i=n.length;for(var s=0;s<i;s++){$.ajax({async:!1,dataType:"html",url:n[s]+e+".tpl.html",success:function(t,n,i){OsciTk.templates[e]=_.template(t),r=!0}});if(r)break}}return OsciTk.templates[e](t)}},OsciTk.collections.BaseCollection=Backbone.Collection.extend(),OsciTk.models.BaseModel=Backbone.Model.extend(),OsciTk.views.BaseView=Backbone.View.extend({getChildViews:function(){return this.childViews||(this.childViews=[]),this.childViews},addView:function(e,t){return e.parent=this,typeof t=="undefined"?this.$el.append(e.el):this.$el.find(t).append(e.el),this._addViewReference(e),this},removeAllChildViews:function(){if(this.childViews){for(var e=0,t=this.childViews.length;e<t;e++)this.childViews[e].close();this.childViews=[]}return this},removeView:function(e,t){if(this.childViews)for(var n=0,r=this.childViews.length;n<r;n++)if(e.cid===this.childViews[n].cid){this.childViews.splice(n,1),e.$el.detach(),(t||t===undefined)&&e.close();break}return this},getChildViewById:function(e){var t;if(this.childViews)for(var n=0,r=this.childViews.length;n<r;n++)if(e===this.childViews[n].cid){t=this.childViews[n];break}return t},getChildViewByIndex:function(e){var t;return this.childViews&&this.childViews[e]&&(t=this.childViews[e]),t},getChildViewsByType:function(e){return _.filter(this.childViews,function(t){return t.$el.is(e)})},replaceView:function(e,t){return e.parent=this,typeof t=="undefined"?this.$el.html(e.el):this.$el.find(t).html(e.el),this._addViewReference(e),this},changeModel:function(e){return this.model=e,this},close:function(){this.removeAllChildViews(),this.remove(),this.unbind(),this.undelegateEvents(),this.onClose&&this.onClose()},_addViewReference:function(e){this.childViews||(this.childViews=[]);var t=!1;for(var n=0,r=this.childViews.length;n<r;n++)if(e.cid===this.childViews[n].cid){t=!0;break}t||this.childViews.push(e)}}),OsciTk.templates["account-login"]=function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<h3>Login</h3>\n<div class="form-error"></div>\n<form id="account-form">\n	<label for="username">Username:</label>\n	<input type="text" id="username" placeholder="Username" />\n	<label for="password">Password:</label>\n	<input type="password" id="password" placeholder="Password" />\n	<button type="button" class="login">Log In</button>\n	<div><a href="#" class="register">Register an account</a></div>\n</form>';return __p},OsciTk.templates["account-profile"]=function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+="<h3>Profile</h3>\n<h4>"+((__t=username)==null?"":__t)+"</h4>\n<h5>"+((__t=email)==null?"":__t)+'</h5>\n<div><a href="#" class="logout">Log out</a></div>';return __p},OsciTk.templates["account-register"]=function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<h2>Register</h2>\n<div class="form-error"></div>\n<form id="account-form">\n	<label for="username">Username:</label>\n	<input type="text" id="username" placeholder="Username" />\n	<label for="password">Password:</label>\n	<input type="password" id="password" placeholder="Password" />\n	<label for="email">Email:</label>\n	<input type="text" id="email" placeholder="Email" />\n	<button type="button" class="register">Register</button>\n	<div><a href="#" class="login">Already have an account?</a></div>\n</form>';return __p},OsciTk.templates.citation=function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<div class="citations">\n	<span>Format</span>\n	<ul class="formats">\n		<li class="active"><a href="#citation-format-chicago">Chicago</a></li>\n		<li><a href="#citation-format-mla">MLA</a></li>\n	</ul>\n	<div id="citation-format-chicago" class="citation">\n		'+((__t=creator)==null?"":__t)+', "<em>'+((__t=title)==null?"":__t)+'</em>," in <em>'+((__t=publicationTitle)==null?"":__t)+"</em>, ed. "+((__t=editor)==null?"":__t)+" "+((__t=publisher)==null?"":__t)+" "+((__t=formattedDate)==null?"":__t)+", para "+((__t=paragraphNumber)==null?"":__t)+'.\n	</div>\n	<div id="citation-format-mla" style="display: none;" class="citation">\n		'+((__t=creator)==null?"":__t)+', "<em>'+((__t=title)==null?"":__t)+'</em>," in <span style="text-decoration:underline;">'+((__t=publicationTitle)==null?"":__t)+"</span>, ed. "+((__t=editor)==null?"":__t)+" ("+((__t=publisher)==null?"":__t)+"), "+((__t=formattedDate)==null?"":__t)+", "+((__t=paragraphNumber)==null?"":__t)+'.\n	</div>\n</div>\n<div class="citation_url">\n	<span>Citation URL</span>\n	<input disabled="disabled" value="'+((__t=url)==null?"":__t)+'" />\n</div>\n<div class="reference_text">\n	<span>Reference Text</span>\n	<textarea disabled="disabled">'+((__t=referenceText)==null?"":__t)+"</textarea>\n</div>";return __p},OsciTk.templates["figure-reference"]=function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<a href="#'+((__t=id)==null?"":__t)+'" class="figure_reference">'+((__t=title)==null?"":__t)+"</a>";return __p},OsciTk.templates.figures=function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+="<div class='figure-browser'>\n	<h3>Figures</h3>\n	<div class='figure-tray'>\n		<div class='figure-reel'>\n			",_.each(figures,function(e){__p+="\n				<figure class='thumbnail' data-figure-id=\""+((__t=e.id)==null?"":__t)+'">\n					',e.thumbnail_url!=undefined?__p+="\n						<img class='figure-thumbnail' src='"+((__t=e.thumbnail_url)==null?"":__t)+"'/>\n					":__p+="\n						<div class='figure-thumbnail'>&nbsp;</div>\n					",__p+="\n					<figcaption>"+((__t=e.title)==null?"":__t)+"</figcaption>\n				</figure>\n			"}),__p+="\n		</div>\n	</div>\n</div>\n<div class='figure-previews'>\n	<div class='figure-nav prev' title='Previous figure'>&lt;</div>\n	<div class='figure-nav next' title='Next Figure'>&gt;</div>\n\n	<h3><span class='back-to-grid'>&laquo; Figures</span> | <span class='title'>TITLE</span></h3>\n	<div class='figure-tray'>\n		<div class='figure-reel'>\n			",_.each(figures,function(e){__p+="\n				<figure class='preview' data-figure-id=\""+((__t=e.id)==null?"":__t)+'">\n					',e.thumbnail_url!=undefined?__p+="\n						<img class='figure-preview' src='"+((__t=e.thumbnail_url)==null?"":__t)+"'/>\n					":__p+="\n						<div class='figure-preview'>&nbsp;</div>\n					",__p+="\n					<div class='figure-info'>\n						<!--<h3 class='title'>Figure Title?</h3>-->\n						<!--<p class='meta-info'>meta info | more meta</p>-->\n						<div class='caption'>\n							"+((__t=e.caption)==null?"":__t)+"\n						</div>\n					</div>\n					<a class='view-fullscreen'>View fullscreen</a>\n					<a class='view-in-context'>View in context</a>\n				</figure>\n			"}),__p+="\n		</div>\n	</div>\n</div>";return __p},OsciTk.templates.font=function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<h3>Reading Settings</h3>\n<div class="font-control">\n	<h3>Font Size</h3>\n	<a href="#font-larger" class="larger font-button">A</a>\n	<a href="#font-smaller" class="smaller font-button">A</a>\n</div>\n<div class="theme-control">\n	<h3>Theme</h3>\n	<a href="#normal" class="theme-button">Normal</a>\n	<a href="#sepia" class="theme-button">Sepia</a>\n	<a href="#night" class="theme-button">Night</a>\n</div>';return __p},OsciTk.templates.glossary=function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<h3>Glossary</h3>\n<div id="glossary-container">\n	<div id="glossary-sidebar">\n		<input type="text" id="glossary-filter" placeholder="Search Glossary" />\n		<div id="glossary-filter-search-icon"></div>\n		<div id="glossary-filter-clear"></div>\n		',_.isEmpty(glossary)?__p+="\n			No terms found.\n		":(__p+='\n		<ul id="glossary-term-listing">\n		',_.each(glossary,function(e){__p+='\n			<li data-tid="'+((__t=e.get("id"))==null?"":__t)+'">'+((__t=e.get("term"))==null?"":__t)+"</li>\n		"}),__p+="\n		</ul>\n		"),__p+='\n	</div>\n	<div id="glossary-content">\n		<h4></h4>\n		<p></p>\n	</div>\n</div>';return __p},OsciTk.templates["multi-column-column"]=function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<div class="column"></div>';return __p},OsciTk.templates["multi-column-figure"]=function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<div class="figure_content"></div>\n<figcaption>'+((__t=caption)==null?"":__t)+"</figcaption>";return __p},OsciTk.templates["multi-column-section"]=function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<div id="pages"></div>';return __p},OsciTk.templates.navigation=function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+="<div class='header'>"+((__t=chapter)==null?"":__t)+"</div>\n<div class='prev-page side'><div class='indicator'>&lt;</div></div>\n<div class='next-page side'><div class='indicator'>&gt;</div></div>\n<div class='prev-page corner'>\n	<div class='label'>Previous</div>\n	<div class='button'>&nbsp;</div>\n</div>\n<div class='pager'><div class='head'>&nbsp;</div></div>\n<div class='next-page corner'>\n	<div class='label'>Next</div>\n	<div class='button'>&nbsp;</div>\n</div>";return __p},OsciTk.templates["note-popup"]=function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<form class="noteForm">\n	<textarea>'+((__t=note)==null?"":__t)+'</textarea>\n	<div class="status">Saved</div>\n</form>\n<div class="reference-text">\n	<span class="reference-text-label">Reference Text</span>\n	<div class="reference-text-content">'+((__t=referenceContent)==null?"":__t)+"</div>\n</div>";return __p},OsciTk.templates.notes=function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<h3>Notes</h3>\n<div class="notesReel">\n	<ul class="notesList">\n		',_.each(notes,function(e){__p+='\n			<li class="notesListItem">\n				<div class="the-note">\n					<span class="note-content">'+((__t=e.get("note"))==null?"":__t)+"</span>\n				</div>\n				",e.get("tags").length>0&&(__p+='\n					<div class="note-tags">\n	                	<span class="tags-label">tags:</span> ',_.each(e.get("tags"),function(e){__p+=""+((__t=e)==null?"":__t)+" "}),__p+="\n	                </div>\n				"),__p+='\n				<div class="note-buttons">\n					<a href="#" class="noteLink" data-content_id="'+((__t=e.get("content_id"))==null?"":__t)+'">Link</a>\n					<!-- <a href="#" class="noteEdit" data-content_id="'+((__t=e.get("content_id"))==null?"":__t)+'">Edit</a> -->\n				</div>\n			</li>\n		'}),__p+="\n	</ul>\n</div>";return __p},OsciTk.templates.page=function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+=""+((__t=content)==null?"":__t)+"";return __p},OsciTk.templates["search-results"]=function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+="",query.keyword&&(__p+='\n<div id="search-results-header">\n	<div id="search-summary">\n		Result(s) for <span id="search-query">"'+((__t=query.keyword)==null?"":__t)+'"</span> ('+((__t=response.numFound)==null?"":__t)+')\n		<a id="reset-search" href="#">RESET</a>\n	</div>\n	<div id="results-sort">\n		Sort By:\n		<ul>\n			<li><a href="#" class="sort-button '+((__t=query.sort==="score"?"active":"")==null?"":__t)+'" data-sort="score">Relevance</a></li>\n			<li><a href="#" class="sort-button '+((__t=query.sort==="content"?"active":"")==null?"":__t)+'" data-sort="content">Type</a></li>\n		</ul>\n	</div>\n</div>\n<div id="search-results-container">\n	',response.numFound!==0?(__p+='\n	<div id="search-results">\n		<div id="search-results-content">\n			',_.each(results,function(e){var t=!0;__p+='\n				<div class="result-section">\n					',_.each(e,function(e){__p+="\n					",t&&(__p+='\n					<div class="result-title">'+((__t=e.get("label"))==null?"":__t)+"</div>\n					",t=!1),__p+='\n					<div class="search-result" data-id="'+((__t=e.get("id"))==null?"":__t)+'">\n						<div class="result-content">\n							<div class="result-type '+((__t=e.get("bundle"))==null?"":__t)+'">'+((__t=e.get("bundle"))==null?"":__t)+'</div>\n							<div class="result-body">\n							',_.isEmpty(e.get("teaser"))?__p+="\n								&nbsp;\n							":__p+="\n							"+((__t=e.get("teaser"))==null?"":__t)+"\n							",__p+="\n							</div>\n						</div>\n					</div>\n					"}),__p+="\n				</div>\n			"}),__p+="\n		</div>\n	</div>\n	"):__p+="\n	No results found.\n	",__p+='\n	<div id="filter-by-section">\n		<div class="section-title">Filter by section</div>\n		<div id="section-list-container">\n			<ul>\n				',_.each(response.facets,function(e){__p+='\n					<li>\n						<a href="#" data-filter="section:'+((__t=e.section_id)==null?"":__t)+'" class="facet">'+((__t=e.section)==null?"":__t)+"</a> \n						("+((__t=e.count)==null?"":__t)+")\n					</li>\n				"}),__p+='\n			</ul>\n		<div style="clear:both;">&nbsp;</div>\n	</div>\n	</div>\n</div>\n'),__p+="";return __p},OsciTk.templates.search=function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<div id="search-header">\n	<h3>Search</h3>\n	<div id="search-box">\n		<form id="search-form" name="search-form" method="POST">\n			<input type="text" name="keyword" id="search-keyword" placeholder="Search" value="'+((__t=query.keyword)==null?"":__t)+'"/>\n			<div id="search-submit"></div>\n			<input type="hidden" name="page" id="search-page" />\n		</form>\n	</div>\n	<div id="search-filters-container">\n		<div class="label">Filter |</div>\n		<ul class="search-filters">\n			<li class="filter" data-filter="type:content" id="search-filter-content"><div class="dot">&nbsp;</div><div class="label">Content</div></li>\n			<li class="filter" data-filter="type:notes" id="search-filter-notes"><div class="dot">&nbsp;</div><div class="label">My Notes</div></li>\n			<li class="filter" data-filter="type:footnotes" id="search-filter-footnotes"><div class="dot">&nbsp;</div><div class="label">Footnotes</div></li>\n			<li class="filter" data-filter="type:figures" id="search-filter-figures"><div class="dot">&nbsp;</div><div class="label">Figures</div></li>\n		</ul>\n		<div class="search-filter-select">\n		<select class="search-filters">\n			<option>Select a filter</option>\n			<option value="content">Content</option>\n			<option value="notes">My Notes</option>\n			<option value="footnotes">Footnotes</option>\n			<option value="figures">Figures</option>\n		</select>\n	</div>\n	</div>\n</div>\n<div id="search-results-wrapper"></div>';return __p},OsciTk.templates.title=function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<h1 id="publication-title"></h1>';return __p},OsciTk.templates.toc=function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+="<h3>Table of Contents</h3>\n<ul>\n	",_.each(items,function(e){__p+='\n		<li class="toc-item',e.id===app.views.navigationView.currentNavigationItem.id&&print(" active"),__p+='">\n			<a data-section-id="'+((__t=e.id)==null?"":__t)+'" href="#">\n				<div class="toc-item-thumbnail">\n					',e.get("thumbnail")&&(__p+='\n						<img src="'+((__t=e.get("thumbnail"))==null?"":__t)+'">\n					'),__p+='\n				</div>\n				<div class="toc-item-text">\n					<h4>'+((__t=e.get("title"))==null?"":__t)+"</h4>\n					",e.get("subtitle")&&(__p+="\n						<h5>"+((__t=e.get("subtitle"))==null?"":__t)+"</h5>\n					"),__p+="\n				</div>\n			</a>\n			<hr>\n		</li>\n	"}),__p+="\n</ul>";return __p},OsciTk.templates["toolbar-item"]=function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+=""+((__t=text)==null?"":__t)+"";return __p},OsciTk.templates.toolbar=function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<div id="toolbar-close">Close</div>\n<div id="toolbar-title-container">\n	<h2 id="toolbar-title"></h2>\n</div>\n<div id="toolbar-content-container">\n	<div id="toolbar-content"></div>\n</div>\n<div id="toolbar-handle"></div>';return __p},OsciTk.models.Account=OsciTk.models.BaseModel.extend({defaults:{username:"anonymous",id:0},initialize:function(){this.getSessionState()},sync:function(e,t,n){console.log(e,"account sync")},getSessionState:function(){var e=this;$.ajax({url:app.config.get("endpoints").OsciTkAccount,data:{action:"status"},type:"POST",dataType:"json",success:function(t){t.success===!0&&e.set(t.user)}})}}),OsciTk.models.Config=OsciTk.models.BaseModel.extend({}),OsciTk.models.Figure=OsciTk.models.BaseModel.extend({defaults:function(){return{section_id:null,delta:null,caption:null,position:null,columns:null,aspect:1,body:null,options:{},plate:!1}},initialize:function(){this.parsePositionData()},parsePositionData:function(){var e=this.get("position"),t;return e==="plate"&&(this.set("plate",!0),e="p"),e.length==2?t={vertical:e[0],horizontal:e[1]}:e==="n"||e==="p"?t={vertical:e,horizontal:e}:t={vertical:e,horizontal:"na"},this.set("position",t),this}}),OsciTk.models.Footnote=OsciTk.models.BaseModel.extend({defaults:function(){return{body:"",section_id:"",delta:""}},sync:function(e,t,n){console.log("Footnote.sync: "+e)}}),OsciTk.models.GlossaryTerm=OsciTk.models.BaseModel.extend({defaults:function(){return{term:"",definition:""}}}),OsciTk.models.NavigationItem=OsciTk.models.BaseModel.extend({defaults:function(){return{title:null,subtitle:null,uri:null,parent:null,next:null,previous:null,depth:0,thumbnail:null,timestamp:null}},initialize:function(){}}),OsciTk.models.Note=OsciTk.models.BaseModel.extend({defaults:function(){return{id:null,content_id:null,section_id:null,note:null,tags:[]}},initialize:function(e,t){this.on("error",function(e,t){console.log([e,t],"error fired")})},sync:function(e,t,n){var r=app.config.get("endpoints").OsciTkNote;console.log("Note.sync: "+e),console.log(t,"model"),console.log(n,"options");switch(e){case"create":n.data=t.toJSON(),delete n.data.id,n.success=function(e,r,i){var s=JSON.parse(e);console.log(s,"response"),s.success?(t.set("id",s.note.id),t.trigger("change")):n.error(t,i)},n.type="POST",$.ajax(r,n);break;case"update":n.data=t.toJSON(),n.success=function(e,r,i){var s=JSON.parse(e);console.log(s,"update response"),s.success?t.trigger("change"):n.error(t,i)},n.type="POST",$.ajax(r,n);break;case"delete":n.data=t.toJSON(),n.data["delete"]=1,n.type="POST",n.success=function(e,r,i){var s=JSON.parse(e);console.log(s,"delete response"),s.success?t.trigger("change"):n.error(t,i)},$.ajax(r,n)}}}),OsciTk.models.Package=OsciTk.models.BaseModel.extend({defaults:function(){return{url:null,lang:null,spine:null,manifest:null,metadata:null,id:null,version:null,xmlns:null}},initialize:function(){var e=xmlToJson(loadXMLDoc(this.get("url")));this.set("lang",e["package"].lang),this.set("spine",e["package"].spine),this.set("manifest",e["package"].manifest),this.set("metadata",e["package"].metadata);var t=e["package"].metadata["dc:identifier"];_.isArray(t)||(t=[t]);var n=t.length;for(var r=0;r<n;r++){var i=t[r];if(i.value.indexOf("urn:osci_tk_identifier:")!==!1){this.set("id",i.value.substr(23));break}}this.set("version",e["package"].version),this.set("xmlns",e["package"].xmlns),Backbone.trigger("packageLoaded",this)},sync:function(e,t,n){console.log("Package.sync: "+e)},getTitle:function(){var e,t=this.get("metadata");return t["dc:title"]&&t["dc:title"].value&&(e=t["dc:title"].value),e}}),OsciTk.models.Page=OsciTk.models.BaseModel.extend({defaults:function(){return{content:[],pageNumber:0}},addContent:function(e){var t=this.get("content");return t.push(e),this},removeContentAt:function(e){var t=this.get("content");return t.splice(e,1),this},removeAllContent:function(){this.set("content",[])},contentLength:function(){return this.get("content").length}}),OsciTk.models.SearchResult=OsciTk.models.BaseModel.extend({get:function(e){if(!this.attributes[e])return this.attributes[e];var t=this.attributes[e];switch(e){case"bundle":return t==="footnote"||t==="note"||t==="figure"?t:"content";case"url":break;default:return this.attributes[e]}}}),OsciTk.models.Section=OsciTk.models.BaseModel.extend({defaults:function(){return{title:null,content:null,uri:null,media_type:"application/xhtml+xml",contentLoaded:!1,pages:new OsciTk.collections.Pages}},loadContent:function(){var e=null;if(this.get("contentLoaded")===!1){var t=loadXMLDoc(this.get("uri"));e=$(t),this.set("title",t.title),this.set("content",e),this.set("contentLoaded",!0)}e===null&&(e=$(this.get("content")));var n=e.find("section#footnotes"),r=e.find("figure");Backbone.trigger("footnotesAvailable",n),Backbone.trigger("figuresAvailable",r),Backbone.trigger("sectionLoaded",this)},removeAllPages:function(){this.set("pages",new OsciTk.collections.Pages)}}),OsciTk.collections.Figures=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.Figure,initialize:function(){this.listenTo(Backbone,"figuresAvailable",function(e){this.populateFromMarkup(e),Backbone.trigger("figuresLoaded",this)})},comparator:function(e){return e.get("delta")},populateFromMarkup:function(e){var t=[];_.each(e,function(e){var n=e.id.match(/\w+-(\d+)-(\d+)/),r=$(e),i={id:e.id,rawData:e,body:e.innerHTML,section_id:n[1],delta:n[2],title:r.attr("title"),caption:r.find("figcaption").html(),content:r.find(".figure_content").html(),position:r.data("position"),columns:r.data("columns"),options:r.data("options"),thumbnail_url:undefined,type:r.data("figure_type"),aspect:r.data("aspect")},s=r.children("img.thumbnail").remove();if(s.length)i.thumbnail_url=s.attr("src"),i.preview_url=s.attr("src");else{var o=$(".figure_content img",e);o.length&&(i.thumbnail_url=o.attr("src"),i.preview_url=o.attr("src"))}t.push(i)},this),this.reset(t)}}),OsciTk.collections.Footnotes=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.Footnote,initialize:function(){this.listenTo(Backbone,"footnotesAvailable",function(e){this.populateFromMarkup(e),Backbone.trigger("footnotesLoaded",this)})},populateFromMarkup:function(e){_.each($("aside",e),function(e){var t=e.id.match(/\w+-(\d+)-(\d+)/),n={id:e.id,rawData:e,body:e.innerHTML,section_id:t[1],delta:t[2]};this.add(n)},this)}}),OsciTk.collections.GlossaryTerms=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.GlossaryTerm,initialize:function(){this.listenTo(Backbone,"packageLoaded",this.parseGlossary)},parseGlossary:function(e){var t=_.find(e.get("manifest").item,function(e){return e.id==="glossary"});if(t){var n=xmlToJson(loadXMLDoc(t.href));if(!_.isUndefined(n.dl.td)&&!_.isUndefined(n.dl.dd)){n.dl.td=objectToArray(n.dl.td),n.dl.dd=objectToArray(n.dl.dd);for(var r=0,i=n.dl.td.length;r<i;r++){var s={id:n.dl.td[r]["data-tid"],term:n.dl.td[r].dfn.value,definition:n.dl.dd[r].value};this.add(s)}}}Backbone.trigger("osci.glossary.loaded",this)},filterByKeyword:function(e){var t=new RegExp("\\b"+e,"gi");return _.filter(this.models,function(e){return e.get("term").search(t)!==-1})},comparator:function(e){return e.get("term")}}),OsciTk.collections.NavigationItems=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.NavigationItem,currentNavigationItem:null,initialize:function(){this.listenTo(Backbone,"packageLoaded",function(e){var t=_.find(e.get("manifest").item,function(e){return e.properties=="nav"});if(t){var n=xmlToJson(loadXMLDoc(t.href)),r=n.html.body.nav;for(var i=0,s=r.length;i<s;i++)if(r[i].type=="toc"){var o=r[i].ol;this.parseChildren(o,null,0);break}Backbone.trigger("navigationLoaded",this)}})},parseChildren:function(e,t,n){_.isArray(e)===!1&&(e=[e]);for(var r=0,i=e.length;r<i;r++){var s=e[r];if(s.a){var o={id:s.a["data-section_id"],parent:t,depth:n,previous:this.at(this.length-1)||null,next:null,length:s.a["data-length"]||null,title:s.a.value,subtitle:s.a["data-subtitle"],thumbnail:s.a["data-thumbnail"],timestamp:s.a["data-timestamp"],uri:s.a.href};this.add(o);var u=this.at(this.length-1);u.get("previous")!==null&&u.get("previous").set("next",u);if(s.ol&&s.ol.li){var a;s.ol.li.length?a=s.ol.li:a=[s.ol.li];var f=n+1;for(var l=0,c=a.length;l<c;l++)this.parseChildren(a[l],u,f)}}s.li&&this.parseChildren(s.li,t,n)}}}),OsciTk.collections.Notes=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.Note,initialize:function(){this.listenTo(Backbone,"currentNavigationItemChanged",function(e){e.id&&app.collections.notes.getNotesForSection(e.id)})},comparator:function(e){return e.get("content_id").match(/.*-(\d+)/)[1]},parse:function(e){return e.success?e.notes:!1},getNotesForSection:function(e){$.ajax({url:app.config.get("endpoints").OsciTkNotes,data:{section_id:e},type:"GET",dataType:"json",success:function(e){e.success===!0&&(app.collections.notes.reset(e.notes),Backbone.trigger("notesLoaded",app.collections.notes))}})}}),OsciTk.collections.Pages=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.Page,initialize:function(){}}),OsciTk.collections.SearchResults=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.SearchResult}),OsciTk.views.Page=OsciTk.views.BaseView.extend({template:OsciTk.templateManager.get("page"),className:"page",initialize:function(){this.processingData={complete:!1},this.$el.addClass("page-num-"+this.model.collection.length).attr("data-page_num",this.model.collection.length)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},processingComplete:function(){return this.processingData.complete=!0,this},addContent:function(e){return this.model.addContent(e),this},hasContent:function(e){return this.model.get("content").length?!0:!1},isPageComplete:function(){return this.processingData.complete},removeAllContent:function(){return this.model.removeAllContent(),this},containsElementId:function(e){return this.$el.find("#"+e).length!==0}}),OsciTk.views.Section=OsciTk.views.BaseView.extend({id:"section",initialize:function(){_.defaults(this.options,{pageView:"Page"}),this.listenTo(Backbone,"currentNavigationItemChanged",function(e){e&&(app.models.section=new OsciTk.models.Section({uri:e.get("uri"),id:e.get("id")}),app.models.section.loadContent(),this.changeModel(app.models.section),this.render())})},render:function(){return this.preRender&&this.preRender(),this.model.removeAllPages(),this.removeAllChildViews(),Backbone.trigger("layoutStart"),this.renderContent(),Backbone.trigger("layoutComplete",{numPages:this.model.get("pages").length}),this},onClose:function(){this.model.removeAllPages()},getPageForParagraphId:function(e){var t=this.getChildViews(),n=_.find(t,function(t){return t.$el.find("[data-paragraph_identifier='"+e+"']").length!==0});return n!==undefined&&n!==-1?_.indexOf(t,n)+1:null},getPageForElement:function(e){var t=$(e).parents(".page");return t?t.data("page_num"):null},getPageForElementId:function(e){var t=this.getChildViews(),n=_.find(t,function(t){return t.containsElementId(e)});return n!==undefined&&n!==-1?_.indexOf(t,n)+1:null},isElementVisible:function(e){return!0},getPageForProcessing:function(e,t){var n;if(e!==undefined)n=this.getChildViewById(e);else{n=_.filter(this.getChildViews(),function(e){return e.isPageComplete()===!1});if(n.length===0){var r=this.model.get("pages");r.add({pageNumber:this.model.get("pages").length+1}),n=new OsciTk.views[this.options.pageView]({model:r.last(),pageNumber:this.model.get("pages").length}),this.addView(n,t)}else n=n.pop()}return n},getCurrentPageView:function(){return this.getChildViewByIndex(app.views.navigationView.page-1)},renderContent:function(){var e=this.getPageForProcessing();e.addContent(this.model.get("content").find("body").html()),e.render(),e.processingComplete()}}),OsciTk.views.figureTypeRegistry["default"]="MultiColumnFigure",OsciTk.views.MultiColumnFigure=OsciTk.views.BaseView.extend({tagName:"figure",template:OsciTk.templateManager.get("multi-column-figure"),initialize:function(){this.layoutComplete=!1,this.contentRendered=!1,this.sizeCalculated=!1,this.calculatedHeight=0,this.calculatedWidth=0,this.position={x:[0,0],y:[0,0]},this.$el.attr("id",this.model.get("id"))},events:{"click .figure_content":"fullscreen"},toggleVisibility:function(e){this.parent.options.pageNumber===e.page?(this.contentRendered||this.renderContent(),this.$el.css("visibility","visible")):this.$el.css("visibility","hidden")},render:function(){this.$el.html(this.template(this.model.toJSON())),this.sizeElement();var e=this.positionElement();return e&&(this.layoutComplete=!0),this.contentRendered||this.renderContent(),this},renderContent:function(){this.$el.find(".figure_content").html(this.model.get("content")),this.contentRendered=!0},fullscreen:function(){$.fancybox.open({content:this.model.get("content")})},positionElement:function(){var e=this.model.toJSON(),t=this.options.sectionDimensions;if(e.position.vertical==="n")return this.$el.hide(),!0;var n;switch(e.position.horizontal){case"r":n=t.columnsPerPage-1;break;case"l":case"p":n=0;break;default:n=this.parent.processingData.currentColumn}var r=!1,s=this.model.get("calculatedColumns"),o=0,u=0,a=s,f=0;e:while(!r&&f<=a){f++,n+s>t.columnsPerPage&&(n-=n+s-t.columnsPerPage);var l=t.columnWidth*s+(s+1)*t.gutterWidth,c=0;this.calculatedWidth<l&&(c=Math.floor((l-this.calculatedWidth)/2)),o=n*t.columnWidth+n*t.gutterWidth+c,this.$el.css("left",o+"px");switch(e.position.vertical){case"t":case"p":u=0;break;case"b":u=t.innerSectionHeight-this.calculatedHeight}this.$el.css("top",u+"px");var h=[o,o+this.calculatedWidth],p=[u,u+this.calculatedHeight];this.position={x:h,y:p},r=!0;if(o<0||h[1]>t.innerSectionWidth)r=!1;var d=this.parent.getChildViewsByType("figure"),v=d.length;if(r&&v&&v>1)for(i=0;i<v;i++){if(d[i].cid===this.cid)continue;var m=d[i].position.x,g=d[i].position.y;if(h[0]<m[1]&&h[1]>m[0]&&p[0]<g[1]&&p[1]>g[0]){r=!1;break}}if(!r)switch(e.position.horizontal){case"r":n--;if(n<0)break e;break;case"l":case"p":n++;if(n>=t.columnsPerPage)break e;break;default:n++,n>t.columnsPerPage&&(n=0)}}return r},sizeElement:function(){var e,t,n=this.options.sectionDimensions,r=this.model.toJSON();if(r.position==="n")return this.calculatedHeight=this.$el.height(),this.calculatedWidth=this.$el.width(),this;typeof r.columns=="string"&&r.columns.indexOf("%")>0&&(r.columns=Math.ceil(parseInt(r.columns,10)/100*n.columnsPerPage)),r.columns>n.columnsPerPage||r.position==="p"?(e=n.innerSectionWidth,r.columns=n.columnsPerPage):e=r.columns*n.columnWidth+n.gutterWidth*(r.columns-1),e=Math.floor(e),this.$el.css("width",e+"px");var i=this.$el.find("figcaption").outerHeight(!0);return t=e/r.aspect+i,t>n.innerSectionHeight&&(t=n.innerSectionHeight,e=(t-i)*r.aspect,this.$el.css("width",e+"px"),i=this.$el.find("figcaption").outerHeight(!0),r.columns=Math.ceil((e+n.gutterWidth)/(n.gutterWidth+n.columnWidth))),e=Math.floor(e),t=Math.floor(t),this.$el.css({height:t+"px",width:e+"px"}),this.calculatedHeight=t,this.calculatedWidth=e,this.model.set("calculatedColumns",r.columns),this.$el.find(".figure_content").css({width:e,height:t-i}),this.sizeCalculated=!0,this}}),OsciTk.views.Account=OsciTk.views.BaseView.extend({className:"account-view",template:null,initialize:function(){this.model=app.account},render:function(){this.model.get("id")>0?this.showProfile():this.showLoginForm()},events:{"click button.login":"login","click button.register":"register","click a.register":"showRegistrationForm","click a.login":"showLoginForm","click a.logout":"logout"},login:function(){var e=this,t=this.$el.find("#username").val(),n=this.$el.find("#password").val();$.ajax({url:app.config.get("endpoints").OsciTkAccount,data:{action:"login",username:t,password:n},type:"POST",dataType:"json",success:function(t){t.success===!0?(e.model.set(t.user),e.showProfile()):e.$el.find("div.form-error").html(t.error)}})},logout:function(){var e=this;$.ajax({url:app.config.get("endpoints").OsciTkAccount,data:{action:"logout"},type:"POST",dataType:"json",success:function(t){e.model.set(t.user),e.showLoginForm()}})},register:function(){var e=this,t=this.$el.find("#username").val(),n=this.$el.find("#password").val(),r=this.$el.find("#email").val();$.ajax({url:app.config.get("endpoints").OsciTkAccount,data:{action:"register",username:t,password:n,email:r},type:"POST",dataType:"json",success:function(t){t.success===!0?(e.model.set(t.user),e.showProfile()):e.$el.find("div.form-error").html(t.error)}})},showRegistrationForm:function(){this.template=OsciTk.templateManager.get("account-register"),this.$el.html(this.template())},showLoginForm:function(){this.template=OsciTk.templateManager.get("account-login"),this.$el.html(this.template())},showProfile:function(){this.template=OsciTk.templateManager.get("account-profile"),this.$el.html(this.template(this.model.toJSON()))}}),OsciTk.views.App=OsciTk.views.BaseView.extend({id:"reader",initialize:function(){$("body").append(this.el),app.views.titleView=new OsciTk.views.Title,this.addView(app.views.titleView),app.views.toolbarView=new OsciTk.views.Toolbar,this.addView(app.views.toolbarView);var e=OsciTk.views.Section;app.config.get("sectionView")&&OsciTk.views[app.config.get("sectionView")]&&(e=OsciTk.views[app.config.get("sectionView")]);var t={};app.config.get("sectionViewOptions")&&(t=app.config.get("sectionViewOptions")),app.views.sectionView=new e(t),this.addView(app.views.sectionView),app.views.navigationView=new OsciTk.views.Navigation,this.addView(app.views.navigationView),app.views.footnotesView=new OsciTk.views.Footnotes,app.views.inlineNotesView=new OsciTk.views.InlineNotes,app.views.citationView=new OsciTk.views.Citation,app.views.glossaryTooltipView=new OsciTk.views.GlossaryTooltip}}),OsciTk.views.Citation=OsciTk.views.BaseView.extend({template:OsciTk.templateManager.get("citation"),initialize:function(){this.listenTo(Backbone,"toggleCiteDialog",function(e){var t=this,n=e.contentId,r=$("#"+n),i={section_id:app.models.section.get("id"),publication_id:app.models.docPackage.get("id"),element_id:e.contentId},s=app.views.sectionView.dimensions.columnWidth,o=$(window).width(),u=s;s*1.5<o&&(u=s*1.5),r.qtip("destroy"),r.qtip({content:{title:{text:"Citation",button:"Close"},text:"Loading...",ajax:{url:app.config.get("endpoints").OsciTkCitation,data:i,success:function(e,n){e.success&&(e.citation.referenceText=r.text(),e.citation.url=document.URL+"/p-"+app.models.section.get("id")+"-"+r.data("paragraph_number"),e.citation.paragraphNumber=r.data("paragraph_number"),e.citation.date=new Date(e.citation.date),e.citation.formattedDate=e.citation.date.getMonth()+1+"/"+e.citation.date.getDate()+"/"+e.citation.date.getFullYear(),e.citation.creator=e.citation.creator?e.citation.creator:"",e.citation.description=e.citation.description?e.citation.description:"",e.citation.editor=e.citation.editor?e.citation.editor:"",e.citation.publicationTitle=e.citation.publicationTitle?e.citation.publicationTitle:"",e.citation.publisher=e.citation.publisher?e.citation.publisher:"",e.citation.rights=e.citation.rights?e.citation.rights:"",e.citation.title=e.citation.title?e.citation.title:"",this.set("content.text",t.template(e.citation)),this.elements.content.on("click","a",function(e){e.preventDefault();var t=$(this),n=t.parents(".citations");n.find(".citation").hide(),n.find(t.attr("href")).show(),n.find("li").removeClass("active"),t.parent().addClass("active")}))}}},show:{event:"",ready:!0,modal:{on:!0,dim:!1}},hide:{fixed:!0,event:"unfocus"},position:{my:"center",at:"center",target:$(document.body)},style:{classes:"citation-tooltip",def:!1,width:u+"px"},events:{hide:function(e,t){t.destroy()}}})})}}),OsciTk.views.Figures=OsciTk.views.BaseView.extend({className:"figures-view",template:OsciTk.templateManager.get("figures"),initialize:function(){this.listenTo(app.collections.figures,"add remove reset",function(){this.render()})},events:{"click .figure-preview":"onFigurePreviewClicked","click a.view-fullscreen":"onFigurePreviewClicked","click a.view-in-context":"onViewInContextClicked","click figure.thumbnail":"onThumbnailClick","click .back-to-grid":"backToGridClick","click .figure-nav.next":"figureNextClick","click .figure-nav.prev":"figurePrevClick"},figureNextClick:function(e){var t=this.$el.find("figure.preview.active").hide().removeClass("active").next("figure.preview");t.length===0&&(t=this.$el.find("figure.preview").first()),t.show().addClass("active"),this.displayTitle()},figurePrevClick:function(e){var t=this.$el.find("figure.preview.active").hide().removeClass("active").prev("figure.preview");t.length===0&&(t=this.$el.find("figure.preview").last()),t.show().addClass("active"),this.displayTitle()},backToGridClick:function(e){this.$el.find(".figure-previews").hide(),this.$el.find(".figure-browser").show(),this.active(),app.views.toolbarView.updateHeight()},onThumbnailClick:function(e){this.$el.find(".figure-browser").hide(),this.$el.find(".figure-previews figure.active").hide().removeClass("active");var t=this.$el.find("figure.preview[data-figure-id='"+$(e.currentTarget).attr("data-figure-id")+"']");t.show().addClass("active"),this.displayTitle(),this.$el.find(".figure-previews").show(),app.views.toolbarView.updateHeight()},onFigurePreviewClicked:function(e){var t=$(e.target).parent("figure").attr("data-figure-id"),n=app.views.figures[t];return n&&n.fullscreen&&n.fullscreen(),!1},onViewInContextClicked:function(e){return Backbone.trigger("navigate",{identifier:$(e.target).parent("figure").attr("data-figure-id")}),app.views.toolbarView.contentClose(),!1},active:function(){if(app.collections.figures.length>1){var e=this.$el.find("figure.thumbnail");this.$el.find(".figure-browser .figure-reel").width(e.length*e.outerWidth(!0))}},render:function(){var e=app.collections.figures.toJSON();return this.$el.html(this.template({figures:e})),this},displayTitle:function(){var e=this.$el.find("figure.preview.active").attr("data-figure-id"),t=app.collections.figures.get(e);this.$el.find("h2 span.title").html(t.get("title"))}}),OsciTk.views.Font=OsciTk.views.BaseView.extend({className:"font-view",template:OsciTk.templateManager.get("font"),initialize:function(){this.currentFontSize=100,this.render()},render:function(){return this.$el.html(this.template()),this},events:{"click .font-button":"changeFontSize","click .theme-button":"changeTheme"},changeFontSize:function(e){e.preventDefault();var t=app.views.sectionView,n=$(e.target);n.attr("href")==="#font-larger"?this.currentFontSize+=25:this.currentFontSize-=25,t.$el.css({"font-size":this.currentFontSize+"%"}),Backbone.trigger("windowResized")},changeTheme:function(e){e.preventDefault();var t=$(e.target),n=t.attr("href").substr(1),r=$("body");r.removeClass("normal sepia night"),r.addClass(n)}}),OsciTk.views.Footnotes=OsciTk.views.BaseView.extend({id:"footnote",initialize:function(){this.listenTo(Backbone,"layoutComplete",function(e){var t=app.views.sectionView.$el.find("a.footnote-reference");_.each(t,function(e){e=$(e);var t=e.attr("href").slice(1),n=app.collections.footnotes.get(t);n&&e.qtip({content:n.get("body"),style:{def:!1}})})})}}),OsciTk.views.GlossaryTooltip=OsciTk.views.BaseView.extend({initialize:function(){this.listenTo(Backbone,"layoutComplete",function(){app.collections.glossaryTerms.length!==0&&$(".glossary-term").qtip({content:{title:" ",text:" "},position:{viewport:$(window)},style:{classes:"glossary-tooltip",def:!1,width:app.views.sectionView.dimensions.columnWidth+"px"},events:{show:function(e,t){var n=$(e.originalEvent.target).data("tid"),r=app.collections.glossaryTerms.get(n);t.set("content.title.text",r.get("term")),t.set("content.text",r.get("definition"))}}})}),this.listenTo(Backbone,"routedToSection",function(){$(".glossary-tooltip").not(event.target).qtip("destroy")})}}),OsciTk.views.Glossary=OsciTk.views.BaseView.extend({id:"glossary-view",className:"toolbar-item-view",template:OsciTk.templateManager.get("glossary"),events:{"keyup #glossary-filter":"filterTerms","click #glossary-filter-clear":"clearFilter","click li":"selectTerm"},render:function(){this.$el.html(this.template({glossary:app.collections.glossaryTerms.models}))},filterTerms:function(){var e=$("#glossary-filter").val();e.length?$("#glossary-filter-clear").show():$("#glossary-filter-clear").hide();var t;_.isEmpty(e)?t=app.collections.glossaryTerms.models:t=app.collections.glossaryTerms.filterByKeyword(e),$("#glossary-term-listing").empty(),_.each(t,function(e){var t=new Backbone.View,n=t.make("li",{"data-tid":e.get("id")},e.get("term"));$("#glossary-term-listing").append(n)})},clearFilter:function(){$("#glossary-filter").val(""),this.filterTerms()},selectTerm:function(e){var t=$(e.target).data("tid"),n=app.collections.glossaryTerms.get(t);this.$el.find("h4").html(n.get("term")),this.$el.find("p").html(n.get("definition"))}}),OsciTk.views.InlineNotes=OsciTk.views.BaseView.extend({template:OsciTk.templateManager.get("note-popup"),initialize:function(){this.listenTo(Backbone,"toggleNoteDialog",function(e){var t=this,n=e.contentId,r=$("#"+n);if(n){var i,s=app.collections.notes.where({content_id:n});s[0]?i=s[0]:(i=new OsciTk.models.Note({content_id:n,section_id:app.models.section.id}),app.collections.notes.add(i));var o=i.toJSON();o.referenceContent=r.text(),r.qtip("destroy"),r.qtip({id:i.cid,content:{title:{text:"Notes",button:"Save & Close"},text:t.template(o)},show:{ready:!0,event:"",modal:{on:!0,dim:!1}},hide:{event:"unfocus",fixed:!0},position:{my:"center",at:"center",target:$(document.body)},style:{classes:"note-tooltip",def:!1,width:app.views.sectionView.dimensions.columnWidth+"px"},events:{render:function(e,n){n.elements.content.find(".noteForm textarea").on("keyup",function(e){n.elements.content.find(".status").text("Saving...");var r=n.elements.tooltip.attr("id").match(/c\d+/)[0],i=app.collections.notes.getByCid(r);i.set("note",e.target.value),typeof t["saveTimeout"+r]!="undefined"&&(clearTimeout(t["saveTimeout"+r]),delete t["saveTimeout"+r]),t["saveTimeout"+r]=window.setTimeout(function(){i.save(),n.elements.content.find(".status").text("Saved")},1500)})},hide:function(e,t){var r=t.elements.content.find("textarea").val();if(r.length>0){var i=app.views.sectionView.getCurrentPageView(),s=i.$el.find(".paragraph-controls[data-osci_content_id="+n+"]");s.addClass("notes-present")}}}})}}),this.listenTo(Backbone,"notesLoaded",function(e){_.each(app.collections.notes.models,function(e){var t=app.views.sectionView.$el.find(".paragraph-controls[data-osci_content_id="+e.get("content_id")+"]");t.length&&t.addClass("notes-present")})})}}),OsciTk.views.figureTypeRegistry.image_asset="MultiColumnFigureImage",OsciTk.views.MultiColumnFigureImage=OsciTk.views.MultiColumnFigure.extend({renderContent:function(){var e=this.$el.find(".figure_content"),t=e.height(),n=e.width();e.html(this.model.get("content")),e.children("img").css({height:t+"px",width:n+"px"}),this.contentRendered=!0},fullscreen:function(){$.fancybox.open({href:$(this.model.get("content")).attr("src")})}}),OsciTk.views.figureTypeRegistry.layered_image="MultiColumnFigureLayeredImage",OsciTk.views.MultiColumnFigureLayeredImage=OsciTk.views.MultiColumnFigure.extend({events:{},renderContent:function(){this.figContent=this.figContent||null;var e=this.$el.find(".figure_content"),t=e.height(),n=e.width();this.jsonOptions=JSON.stringify(this.model.get("options")),this.$el.attr("data-options",this.jsonOptions);if(this.figContent!==null)this.renderFromContentDoc();else{var r=$(this.model.get("content")),i=r.attr("data");if(i!==undefined){var s=this;$.ajax({url:i,type:"GET",dataType:"html",success:function(e){s.figContent=$(e).filter(".layered_image-asset").first(),s.LIMarkup=s.figContent.clone(),s.renderFromContentDoc()}})}}},renderFromContentDoc:function(){var e=this.$el.find(".figure_content");e.empty(),e.html(this.figContent),new window.LayeredImage(e.find(".layered_image-asset")[0]),this.contentRendered=!0},fullscreen:function(){var e=liCollection.find(this.LIMarkup.attr("id"));e.fullscreen()}}),OsciTk.views.MultiColumnPage=OsciTk.views.Page.extend({initialize:function(){this._super("initialize"),this.columnTemplate=OsciTk.templateManager.get("multi-column-column"),this.visible=!1,this.paragraphControlsViews=[]},onClose:function(){this.model=undefined},events:{"click a.figure_reference":"onFigureReferenceClicked"},onFigureReferenceClicked:function(e){var t=e.currentTarget.hash.substring(1),n=app.views.figures[t];return n&&n.fullscreen&&n.fullscreen(),!1},hide:function(){this.$el.css("visibility","hidden"),this.visible=!1},show:function(){this.$el.css("visibility","visible"),this.visible=!0},resetPage:function(){this.removeAllContent();for(var e=0,t=this.paragraphControlsViews.length;e<t;e++)this.removeView(this.paragraphControlsViews[e]);this.paragraphControlsViews=[],this.$el.children(":not(figure)").remove(),this.initializeColumns()},render:function(){return this.processingData.rendered?this:(this.hide(),this.$el.css({width:this.parent.dimensions.innerSectionWidth,height:this.parent.dimensions.innerSectionHeight}),this.initializeColumns(),this.processingData.rendered=!0,this)},layoutContent:function(){var e="none",t=this.getCurrentColumn();if(t===null)return this.processingComplete(),e="contentOverflow",e;var n=$(this.model.get("content")[this.model.get("content").length-1]);t.$el.append(n);var r=parseFloat(n.css("line-height")),i=n.position();if(t.height-i.top<r)return n.remove(),t.heightRemain=0,e="contentOverflow",e;var s=n.outerHeight(!0),o=0;t.offset<0&&(o=s+t.offset,n.css("margin-top","-"+o+"px"),t.offset=0);var u={top:parseInt(n.css("margin-top"),10),bottom:parseInt(n.css("margin-bottom"),10)},a=t.heightRemain-n.outerHeight(!0);a>0&&a<r?a=0:a<0&&a>=u.bottom*-1&&(a=0);if(a<0){var f=a,l=Math.floor(f/r),c=i.top+n.outerHeight()+l*r;t.height=c,t.$el.height(c+"px"),l===0?(a=0,e="none"):(a=l*r-u.bottom,e="contentOverflow"),this.processingData.currentColumn===this.parent.dimensions.columnsPerPage-1&&this.processingComplete();if(t.height-i.top<r)return n.remove(),t.heightRemain=0,e="contentOverflow",e}a===0&&this.processingData.currentColumn===this.parent.dimensions.columnsPerPage-1&&this.processingComplete(),t.heightRemain=a;if(n.is("p")){var h=n.data("paragraph_number"),p=n.data("osci_content_id"),d=this.$el.find(".paragraph-identifier-"+h);if(d.length===0){var v=t.$el.position(),m=new OsciTk.views.ParagraphControlsView({content:n,position:{top:v.top+i.top+"px",left:v.left+i.left-this.parent.dimensions.gutterWidth+"px"}});this.addView(m),this.paragraphControlsViews.push(m)}}return e},getCurrentColumn:function(){var e=null,t=parseInt(this.$el.css("line-height"),10);t=t?t:this.parent.options.defaultLineHeight;var n=t*this.parent.dimensions.minLinesPerColumn;if(this.processingData.columns[this.processingData.currentColumn]&&this.processingData.columns[this.processingData.currentColumn].height>=n&&this.processingData.columns[this.processingData.currentColumn].heightRemain>0)e=this.processingData.columns[this.processingData.currentColumn];else for(var r=0;r<this.parent.dimensions.columnsPerPage;r++)if(this.processingData.columns[r].height>=n&&this.processingData.columns[r].heightRemain>0){e=this.processingData.columns[r],this.processingData.currentColumn=r;break}if(e!==null&&e.$el===null){if(this.processingData.currentColumn>0)e.offset=this.processingData.columns[this.processingData.currentColumn-1].heightRemain;else{var i=this.parent.getChildViewByIndex(this.parent.getChildViews().length-2);i&&(e.offset=i.processingData.columns[i.processingData.columns.length-1].heightRemain)}var s={width:this.parent.dimensions.columnWidth+"px",height:e.height+"px",left:this.processingData.columns[this.processingData.currentColumn].position.left,top:this.processingData.columns[this.processingData.currentColumn].position.top};e.$el=$(this.columnTemplate()).appendTo(this.$el).addClass("column-"+this.processingData.currentColumn).css(s)}return e},initializeColumns:function(){this.processingData.columns=[];var e=this.getChildViewsByType("figure"),t=e.length;for(var n=0;n<this.parent.dimensions.columnsPerPage;n++){var r=n*this.parent.dimensions.columnWidth+this.parent.dimensions.gutterWidth*(n+1),i=this.parent.dimensions.innerSectionHeight,s=0,o={x:[r,r+this.parent.dimensions.columnWidth],y:[s,s+i]};if(t)for(var u=0;u<t;u++){var a=e[u].position.x,f=e[u].position.y;if(o.x[0]<a[1]&&o.x[1]>a[0]&&o.y[0]<f[1]&&o.y[1]>f[0]){i=i-e[u].calculatedHeight-this.parent.dimensions.gutterWidth;switch(e[u].model.get("position").vertical){case"t":case"p":s=s+e[u].calculatedHeight+this.parent.dimensions.gutterWidth;break;case"b":s=s}o.y=[s,s+i]}}i=Math.floor(i),this.processingData.columns[n]={height:i,heightRemain:i>0?i:0,$el:null,offset:0,position:{left:o.x[0],top:o.y[0]}}}this.processingData.currentColumn=0},addFigure:function(e){var t=!1;return this.addView(e),e.layoutComplete||(e.render(),e.layoutComplete?t=!0:(t=!1,this.removeView(e,!1))),t}}),OsciTk.views.MultiColumnSection=OsciTk.views.Section.extend({template:OsciTk.templateManager.get("multi-column-section"),initialize:function(){this._super("initialize"),this.options.pageView="MultiColumnPage",this.listenTo(Backbone,"windowResized",function(){var e,t=this.getChildViewByIndex(app.views.navigationView.page-1),n=t.$el.find("[id]:first");n.length&&(e=n.attr("id")),e&&(app.views.navigationView.identifier=e),this.render()}),this.listenTo(Backbone,"navigate",function(e){var t=1;if(e.page)t=e.page;else if(e.identifier)switch(e.identifier){case"end":t=this.model.get("pages").length;break;case"start":t=1;break;default:var n=null;if(e.identifier.search(/^p-[0-9]+/)>-1){var r=e.identifier.slice(e.identifier.lastIndexOf("-")+1,e.identifier.length);n=this.getPageForParagraphId(r)}else if(e.identifier.search(/^fig-[0-9]+-[0-9]+-[0-9]+/)>-1){var i=e.identifier.match(/^(fig-[0-9]+-[0-9]+)-([0-9])+?/),s=i[1],o=i[2]?parseInt(i[2],10):1,u=$(".figure_reference").filter("[href='#"+s+"']");if(u.length)if(u.length===1)n=this.getPageForElement(u[0]);else{var a=0;for(var f=0,l=u.length;f<l;f++)if(this.isElementVisible(u[f])){a++;if(a===o){n=this.getPageForElement(u[f]);break}}}}else n=this.getPageForElementId(e.identifier);n!==null?t=n:(t=1,console.log("Navigation error: ",e.identifier,"not found in any page"))}this.getChildViewByIndex(t-1).show();var c=(t-1)*this.dimensions.innerSectionHeight*-1,h=this.getChildViews(),p=h.length;for(var d=0;d<p;d++)d!==t-1&&h[d].hide();this.$el.find("#pages").css({"-webkit-transform":"translate3d(0, "+c+"px, 0)","-moz-transform":"translate3d(0, "+c+"px, 0)",transform:"translate3d(0, "+c+"px, 0)"}),Backbone.trigger("pageChanged",{page:t})}),this.$el.addClass("oscitk_multi_column"),_.defaults(this.options,{minColumnWidth:200,maxColumnWidth:300,gutterWidth:40,minLinesPerColumn:5,defaultLineHeight:16}),this.dimensions={}},isElementVisible:function(e){var t=$(e),n=t.parents(".column"),r=null,i=!0;n.length?r=n:r=t.parents(".page");if(r.length){var s=t.position();if(s.top<0||s.top>r.height())i=!1}return i},preRender:function(){app.views.figures={}},renderContent:function(){this.$el.html(this.template()),this.calculateDimensions(),this.layoutData={data:this.model.get("content"),items:null},this.cleanData(),this.unplacedFigures=[];var e=app.collections.figures.where({plate:!0});e.length&&_.each(e,function(e){this.unplacedFigures.push(e.id)},this),this.layoutData.items=this.layoutData.data.length;var t=0,n=!0,r=1,i=0,s=0;while(this.layoutData.items>0||this.unplacedFigures.length>0){var o=this.getPageForProcessing(undefined,"#pages"),u=null,a=[];o.processingData.rendered||(s=0,i=0,o.render(),a=a.concat(this.unplacedFigures));var f=$(this.layoutData.data[t]).clone(),l=f.find("a.figure_reference"),c=l.length,h=f.find("figure"),p=h.length;if(f.is("figure")||c||p||a.length){var d;f.is("figure")&&a.push(f.attr("id"));if(c)for(d=0;d<c;d++)a.push($(l[d]).attr("href").substring(1));if(p)for(d=0;d<p;d++){var v=$(h[d]).remove();a.push(v.attr("id"))}var m=a.length;for(d=0;d<m;d++){var g=app.collections.figures.get(a[d]),y=g.get("type"),b=OsciTk.views.figureTypeRegistry[y]?OsciTk.views.figureTypeRegistry[y]:OsciTk.views.figureTypeRegistry["default"],w=this.getFigureView(g.get("id"));w||(app.views.figures[a[d]]=w=new OsciTk.views[b]({model:g,sectionDimensions:this.dimensions}));if(!w.layoutComplete){if(o.addFigure(w)){u="figurePlaced";var E=_.indexOf(this.unplacedFigures,a[d]);E>-1&&this.unplacedFigures.splice(E,1);break}_.indexOf(this.unplacedFigures,a[d])===-1&&this.unplacedFigures.push(a[d]),f.is("figure")&&(u="next")}else f.is("figure")&&(u="next")}}u===null&&(n&&f.attr("id","osci-content-"+t),f.attr("data-osci_content_id","osci-content-"+t),f.is("p")&&f.attr("data-paragraph_number",r),u=o.addContent(f).layoutContent());switch(u){case"contentOverflow":n=!1;break;case"figurePlaced":o.resetPage(),r-=i,i=0,this.layoutData.items+=s,t-=s,s=0;break;default:t++,this.layoutData.items--,s++,f.is("p")&&(r++,i++),n=!0}}},calculateDimensions:function(){var e=this.dimensions,t=$(window).width(),n=$(window).height();t<300&&(t=300),n<300&&(n=300);if(e.windowWidth&&e.windowWidth===t&&e.windowHeight&&e.windowHeight===n)return;e.windowHeight=n,e.windowWidth=t,e.gutterWidth=this.options.gutterWidth,e.minLinesPerColumn=this.options.minLinesPerColumn,e.sectionMargin={left:parseInt(this.$el.css("margin-left"),10),top:parseInt(this.$el.css("margin-top"),10),right:parseInt(this.$el.css("margin-right"),10),bottom:parseInt(this.$el.css("margin-bottom"),10)},e.sectionPadding={left:parseInt(this.$el.css("padding-left"),10),top:parseInt(this.$el.css("padding-top"),10),right:parseInt(this.$el.css("padding-right"),10),bottom:parseInt(this.$el.css("padding-bottom"),10)},e.outerSectionHeight=n-e.sectionMargin.top-e.sectionMargin.bottom,e.innerSectionHeight=e.outerSectionHeight-e.sectionPadding.top-e.sectionPadding.bottom,e.outerSectionWidth=this.$el.outerWidth(),e.innerSectionWidth=e.outerSectionWidth-e.sectionPadding.left-e.sectionPadding.right,e.innerSectionWidth<this.options.maxColumnWidth?e.columnWidth=e.innerSectionWidth:e.columnWidth=this.options.maxColumnWidth,e.columnsPerPage=Math.floor(e.innerSectionWidth/e.columnWidth),e.innerSectionWidth<e.columnsPerPage*e.columnWidth+e.columnsPerPage*this.options.gutterWidth&&(e.columnsPerPage=e.columnsPerPage-1),e.columnsPerPage===0&&(e.columnsPerPage=1,e.columnWidth=e.innerSectionWidth-this.options.gutterWidth);var r=(e.innerSectionWidth-e.columnsPerPage*e.columnWidth)/e.columnsPerPage;r>this.options.gutterWidth&&(e.columnWidth=(e.innerSectionWidth-this.options.gutterWidth*e.columnsPerPage)/e.columnsPerPage),e.columnWidth=Math.floor(e.columnWidth),this.dimensions=e},cleanData:function(){this.layoutData.data.find("#figures").remove(),this.layoutData.data.find("#footnotes").remove(),this.layoutData.data=this.layoutData.data.find("section").children()},getFigureView:function(e){if(app.views.figures[e])return app.views.figures[e]}}),OsciTk.views.Navigation=OsciTk.views.BaseView.extend({id:"navigation",template:OsciTk.templateManager.get("navigation"),initialize:function(){this.numPages=null,this.identifier=null,this.currentNavigationItem=null,this.page=null,this.listenTo(Backbone,"layoutComplete",function(e){this.identifier?(Backbone.trigger("navigate",{identifier:this.identifier}),this.identifier=null):Backbone.trigger("navigate",{page:1}),this.numPages=e.numPages,this.render()}),this.listenTo(Backbone,"pageChanged",function(e){this.page=e.page,this.update(e.page)}),this.listenTo(Backbone,"routedToSection",function(e){this.identifier=e.identifier;if(!e.section_id){var t=app.collections.navigationItems.at(0).id;this.setCurrentNavigationItem(t),app.router.navigate("section/"+t,{trigger:!1})}else this.setCurrentNavigationItem(e.section_id);var n=app.models.docPackage.getTitle();n=n?n+" | ":"",n+=this.getCurrentNavigationItem().get("title"),document.title=n}),$(document).keydown(function(e){var t;switch(e.which){case 39:t=app.views.navigationView.page+1;if(t>app.views.navigationView.numPages){var n=app.views.navigationView.currentNavigationItem.get("next");n&&app.router.navigate("section/"+n.id,{trigger:!0})}else Backbone.trigger("navigate",{page:t});break;case 37:t=app.views.navigationView.page-1;if(t<1){var r=app.views.navigationView.currentNavigationItem.get("previous");r&&app.router.navigate("section/"+r.id+"/end",{trigger:!0})}else Backbone.trigger("navigate",{page:t})}})},render:function(){this.$el.html(this.template({numPages:this.numPages,chapter:this.currentNavigationItem.get("title")})),this.numPages==1?$(".pager").hide():$(".pager").show();var e=100/this.numPages;$(".pager .head",this.$el).css("width",e+"%"),$(".pager").mousedown(function(e){var t=parseInt(app.views.navigationView.numPages*e.offsetX/$(this).width(),10);Backbone.trigger("navigate",{page:t+1})}),this.update(this.page)},getCurrentNavigationItem:function(){return this.currentNavigationItem},setCurrentNavigationItem:function(e){var t=app.collections.navigationItems.get(e);t?this.currentNavigationItem=app.collections.navigationItems.get(e):this.currentNavigationItem=app.collections.navigationItems.first(),Backbone.trigger("currentNavigationItemChanged",this.currentNavigationItem)},update:function(e){var t=100/this.numPages;$(".pager .head",this.$el).css("left",t*(e-1)+"%"),this.$el.find(".prev-page").unbind("click"),this.$el.find(".next-page").unbind("click");if(e==1){var n=this.currentNavigationItem.get("previous");n?(this.$el.find(".prev-page .label").html("Previous Section"),this.$el.find(".prev-page").removeClass("inactive").click(function(){app.router.navigate("section/"+n.id+"/end",{trigger:!0})})):$(".prev-page",this.$el).addClass("inactive").unbind("click")}else if(this.numPages>1){var r=this;this.$el.find(".prev-page .label").html("Previous"),this.$el.find(".prev-page").removeClass("inactive").click(function(){app.router.navigate("section/"+r.currentNavigationItem.id),Backbone.trigger("navigate",{page:e-1})})}if(e==this.numPages){var i=this.currentNavigationItem.get("next");i?(this.$el.find(".next-page .label").html("Next Section"),this.$el.find(".next-page").removeClass("inactive").click(function(){app.router.navigate("section/"+i.id,{trigger:!0})})):this.$el.find(".next-page").addClass("inactive").unbind("click")}else this.numPages>1&&(this.$el.find(".next-page .label").html("Next"),this.$el.find(".next-page").removeClass("inactive").click(function(){Backbone.trigger("navigate",{page:e+1})}))}}),OsciTk.views.Notes=OsciTk.views.BaseView.extend({className:"notes-view",template:OsciTk.templateManager.get("notes"),initialize:function(){this.listenTo(app.collections.notes,"add remove change",function(){this.render()}),this.listenTo(Backbone,"pageChanged notesLoaded",function(e){var t;typeof e.page=="undefined"?t=app.views.navigationView.page:t=e.page,pageView=app.views.sectionView.getChildViewByIndex(t-1),_.each(app.collections.notes.models,function(e){e.set("onCurrentPage",!1);var t=pageView.$el.find("#"+e.get("content_id"));t.length>0&&e.set("onCurrentPage",!0)}),this.render()})},events:{"click .noteLink":"noteLinkClick"},noteLinkClick:function(e){e.preventDefault();var t=$(e.target),n=t.attr("data-content_id");n&&(Backbone.trigger("navigate",{identifier:n}),Backbone.trigger("toggleNoteDialog",{contentId:n}),$("#"+n).click(),app.views.toolbarView.contentClose())},render:function(){var e=this.getSavedNotes();return this.$el.html(this.template({notes:e})),this.active(),this},getSavedNotes:function(){var e=_.filter(app.collections.notes.models,function(e){return e.id!==null?!0:!1});return e},active:function(){if(app.collections.notes.length>1){var e=this.$el.find(".notesListItem");this.$el.find(".notesList").width(e.length*e.first().outerWidth(!0))}}}),OsciTk.views.ParagraphControlsView=OsciTk.views.BaseView.extend({className:"paragraph-controls",initialize:function(){this.options.paragraphNumber=this.options.content.data("paragraph_number"),this.options.contentIdentifier=this.options.content.data("osci_content_id"),this.options.linkItems=app.config.get("paragraphControls"),this.options.linkItems&&this.render()},render:function(){var e=this.options.content.position();this.$el.attr("data-osci_content_id",this.options.contentIdentifier),this.$el.attr("data-paragraph_identifier",this.options.paragraphNumber),this.$el.html('<span class="paragraph-identifier paragraph-identifier-'+this.options.paragraphNumber+'">'+this.options.paragraphNumber+"</span>"),this.$el.css(this.options.position),this.$el.data("qtip")&&this.$el.qtip("destroy");var t="";for(var n in this.options.linkItems){var r=this.options.linkItems[n];t+='<a href="'+n+'" data-event="'+n+'" class="'+n+'">'+r+"</a> "}return this.$el.qtip({position:{my:"left center",at:"right center",target:this.$el,container:this.$el,adjust:{y:-10}},show:{ready:!1,solo:!0},hide:{fixed:!0,delay:500},style:{def:!1},overwrite:!1,content:t}),this.$el.on("click","a",{content:this.options.content},function(e){e.preventDefault(),Backbone.trigger($(this).data("event"),{contentId:$(e.data.content).attr("data-osci_content_id")})}),this}}),OsciTk.views.Search=OsciTk.views.BaseView.extend({id:"search-view",className:"toolbar-item-view",template:OsciTk.templateManager.get("search"),initialize:function(){this.query={page:0,keyword:null,filters:[],sort:"score"},this.response={numFound:0,docs:new OsciTk.collections.SearchResults,facets:null},this.results=null,this.hasSearched=!1,this.isLoading=!1,this.resultsTemplate=OsciTk.templateManager.get("search-results")},events:{"submit #search-form":"submitSearch","click #search-submit":"submitSearch","click .search-result":"gotoResult","click .facet":"addFacet","click .filter":"addFilter","click #reset-search":"resetSearch","click .sort-button":"addSort"},render:function(){this.$el.html(this.template(this))},renderResults:function(){this.prepareResults(),this.$el.find("#search-results-wrapper").html(this.resultsTemplate(this))},resizeResultsContainer:function(){var e=$("#toolbar-content").height(),t=this.$el.find("#search-header").outerHeight(),n=this.$el.find("#search-results-header").outerHeight(),r=e-t-n;this.$el.find("#search-results-container").height(r)},prepareResults:function(){this.results=_.groupBy(this.response.docs.models,function(e){return e.get("ss_section_id")})},search:function(){var e=this;this.query.keyword=this.$el.find("#search-keyword").val(),this.response.docs.reset(),this.hasSearched=!0;var t={key:this.query.keyword,group:"true",page:this.query.page,sort:this.query.sort};this.query.filters.push("pid:"+app.models.docPackage.get("id")),this.query.filters.length&&(t.filters=this.query.filters.join(" ")),$.ajax({url:app.config.get("endpoints").OsciTkSearch,data:t,success:function(t){t=JSON.parse(t),e.response.docs.reset(t.docs),e.response.facets=t.facets,e.response.numFound=t.numFound,e.renderResults(),app.views.toolbarView.contentOpen(),e.resizeResultsContainer(),Backbone.trigger("osci.search.finished")},error:function(){}})},gotoResult:function(e){var t=$(e.currentTarget),n=this.response.docs.get(t.data("id"));app.router.navigate("section/"+n.get("ss_section_id")+"/"+n.get("id"),{trigger:!0}),app.views.toolbarView.contentClose()},addSort:function(e){e.preventDefault();var t=$(e.currentTarget).data("sort"),n=t===this.query.sort;this.$el.find(".sort-button").removeClass("active"),n||(this.query.sort=t),this.hasSearched&&this.search(),this.$el.find(e.currentTarget).addClass("active")},addFilter:function(e){e.preventDefault();var t=$(e.currentTarget).data("filter"),n=_.indexOf(this.query.filters,t);this.$el.find(".filter").removeClass("active"),this.query.filters=_.reject(this.query.filters,function(e){return e.indexOf("type:")===0}),n===-1&&(this.query.filters.push(t),$(e.currentTarget).addClass("active")),this.hasSearched&&this.search()},addFacet:function(e){e.preventDefault();var t=$(e.currentTarget).data("filter");this.query.filters.push(t),this.hasSearched&&this.search()},submitSearch:function(e){e.preventDefault(),this.search()},resetSearch:function(e){e.preventDefault(),e.stopPropagation(),this.initialize(),this.$el.find("#search-results-header").remove(),this.$el.find("#search-results-container").remove(),this.$el.find("#search-keyword").val(""),app.views.toolbarView.contentOpen(),this.resizeResultsContainer()}}),OsciTk.views.Title=OsciTk.views.BaseView.extend({className:"title-view",template:OsciTk.templateManager.get("title"),initialize:function(){this.listenTo(Backbone,"packageLoaded",function(e){var t=e.getTitle();t&&this.$el.find("#publication-title").text(t)}),this.render()},render:function(){return this.$el.html(this.template()),this},events:{"click #publication-title":function(e){e.preventDefault(),Backbone.trigger("navigate",{identifier:"start"})}}}),OsciTk.views.Toc=OsciTk.views.BaseView.extend({className:"toc-view",template:OsciTk.templateManager.get("toc"),events:{"click li a":"itemClick"},initialize:function(){this.parent=this.options.parent,this.listenTo(Backbone,"currentNavigationItemChanged",function(){this.render()})},render:function(){this.$el.html(this.template({items:app.collections.navigationItems.where({depth:0})}))},itemClick:function(e){e.preventDefault();var t=$(e.currentTarget).attr("data-section-id");app.router.navigate("section/"+t,{trigger:!0}),app.views.toolbarView.contentClose()},active:function(){var e=$("#toolbar-content").height(),t=this.$el.find("h3").outerHeight(),n=e-t;this.$el.find("ul").height(n)}}),OsciTk.views.ToolbarItem=OsciTk.views.BaseView.extend({className:"toolbar-item",template:OsciTk.templateManager.get("toolbar-item"),initialize:function(){this.$el.addClass(this.options.toolbarItem.view+"-toolbar-item"),this.contentView=null,this.contentViewRendered=!1},events:{click:"itemClicked",touch:"itemClicked"},onClose:function(){this.contentView.close()},render:function(){this.contentView=new OsciTk.views[this.options.toolbarItem.view]({parent:this}),this.$el.html(this.template({text:this.options.toolbarItem.text}))},itemClicked:function(e){e.preventDefault(),e.stopPropagation(),this.contentViewRendered||(this.contentView.render(),this.contentViewRendered=!0),this.parent.setActiveToolbarItemView(this),this.parent.toggleContentView(),this.contentView.active&&this.contentView.active()}}),OsciTk.views.Toolbar=OsciTk.views.BaseView.extend({id:"toolbar",template:OsciTk.templateManager.get("toolbar"),initialize:function(){this.toolbarItems=app.config.get("toolbarItems")?app.config.get("toolbarItems"):[],this.isContentOpen=!1,this.activeToolbarItemView=undefined,this.activeToolbarItemViewChanged=!1,this.render(),this.listenTo(Backbone,"packageLoaded",function(e){var t=e.getTitle();t&&this.$el.find("#toolbar-title").text(t)}),$(window).on("click",{view:this},function(e){var t=$(e.target).parents("#"+e.data.view.id);e.data.view.isContentOpen&&t.length===0&&e.data.view.contentClose()})},events:{"click #toolbar-close":"contentClose"},render:function(){this.$el.html(this.template()),_.each(this.toolbarItems,function(e){var t=new OsciTk.views.ToolbarItem({toolbarItem:e});this.addView(t,"#toolbar-handle"),t.render()},this)},setActiveToolbarItemView:function(e){return this.activeToolbarItemView&&e.cid!==this.activeToolbarItemView.cid||this.activeToolbarItemView===undefined?(this.activeToolbarItemViewChanged=!0,this.activeToolbarItemView&&this.activeToolbarItemView.contentView.$el.detach()):this.activeToolbarItemViewChanged=!1,this.activeToolbarItemView=e,this.$el.find("#toolbar-content").html(e.contentView.$el),e.contentView.delegateEvents(),this},toggleContentView:function(){return this.isContentOpen?this.activeToolbarItemViewChanged?(this.updateHeight(),this):(this.contentClose(),this):(this.contentOpen(),this)},contentOpen:function(){this.updateHeight(),this.isContentOpen=!0},updateHeight:function(){var e=this.$el.find("#toolbar-content"),t=this.$el.height();e.height("");var n=e.height(),r=$("#toolbar-title-container").outerHeight();n>t-r?e.height(t-r+"px"):e.height(""),this.$el.css({top:0})},contentClose:function(){this.$el.css({top:"-"+this.$el.height()+"px"}),this.isContentOpen=!1}});var $=jQuery,LICollection=function(){var e=[];this.add=function(t){var n,r;for(n=0,r=e.length;n<r;n++)if(e[n].id==t.id)return!1;return e.push(t),!0},this.remove=function(t){var n,r;typeof t=="string"&&(t={id:t});for(n=0,r=e.length;n<r;n++)e[n].id==t.id&&e.splice(n,1)},this.find=function(t){var n,r;for(n=0,r=e.length;n<r;n++)if(e[n].id==t)return e[n];return!1},this.list=function(){return e},this.userIsDraggingAsset=!1},LayeredImage=function(e){var t,n,r;if(jQuery===undefined)return!1;var i=this.$=jQuery;if(org.polymaps===undefined)return!1;this.polymaps=org.polymaps,this.container=i(e);if(this.container.length<1)return!1;if(!window.liCollection.add(this))return;this.id=this.container.attr("id"),this.settings=this.container.data(),this.settings.zoomStep=this.settings.zoomStep||.1,this.settings.annotationSelectorVisible=!1,this.settings.dragging=undefined;var s=this.container.parents("figure:first"),o=s.attr("data-options");s.length>0&&o&&(this.figureOptions=JSON.parse(o)),this.figureOptions||(this.figureOptions={disable_interaction:!1,disable_annotation:!1,sliderPosition:0}),this.figureOptions.sliderPosition||(this.figureOptions.sliderPosition=0),this.settings.captionMarkup=this.container.parents("figure:first").find("figcaption").clone(),this.settings.originalMarkup=outerHTML(this.container[0]),this.layers=[];var u=this.container.find(".layered_image-layers"),a=u.find("li");for(t=0,n=a.length;t<n;t++){var f=i(a[t]);this.layers.push(f.data())}u.remove(),this.layers.sort(function(e,t){var n=e.annotation,r=t.annotation;return n==r?0:n&&!r?1:!n&&r?-1:0}),this.baseLayers=[],this.annotationLayers=[];for(t=0,n=this.layers.length;t<n;t++)r=this.layers[t],r.layer_num=t+1,r.annotation?this.annotationLayers.push(r):this.baseLayers.push(r);this.map=this.polymaps.map(),this.map.container(this.container[0].appendChild(this.polymaps.svg("svg"))),this.map.tileSize({x:256,y:256});for(t=0,n=this.layers.length;t<n;t++)r=this.layers[t],r.zoom_levels||(r.zoom_levels=this.getZoomLevels(r.width,r.height));var l=this.figureOptions.baseLayerPreset?this.figureOptions.baseLayerPreset:[],c=l.length,h=!1;if(c>0){var p=this.getLayerById(l[0]),d;c>1&&(d=this.getLayerById(l[1])),p&&(d||c==1)&&(this.createLayer(p),d&&(this.createLayer(d),i("#"+d.id).css("opacity",0)),h=!0)}!h&&this.baseLayers.length&&(this.createLayer(this.baseLayers[0]),this.baseLayers[1]&&(this.createLayer(this.baseLayers[1]),i("#"+this.baseLayers[1].id).css("opacity",0))),this.createUI(),this.showAnnotationPresets(),this.zoomToContainer();var v=[];this.figureOptions.fullscreenExtents?(v=[{lon:this.figureOptions.fullscreenExtents.swLon,lat:this.figureOptions.fullscreenExtents.swLat},{lon:this.figureOptions.fullscreenExtents.neLon,lat:this.figureOptions.fullscreenExtents.neLat}],this.setExtents(v)):this.figureOptions.swLat&&(v=[{lon:this.figureOptions.swLon,lat:this.figureOptions.swLat},{lon:this.figureOptions.neLon,lat:this.figureOptions.neLat}],this.setExtents(v))};LayeredImage.prototype.createLayer=function(e){var t=this.$,n;if(e===undefined)return;e.zoom_levels||(e.zoom_levels=this.getZoomLevels(e.width,e.height)),e.type=="image"&&(n=this.createLayerImage(e)),e.type=="iip"&&(n=this.createLayerIIP(e)),e.type=="svg"&&(n=this.createLayerSVG(e)),e.visible=!0,e.polymapLayer=n,n.id(e.id),this.map.add(n)},LayeredImage.prototype.removeLayer=function(e){e.polymapLayer&&this.map.remove(e.polymapLayer),e.polymapLayer=undefined,e.visible=!1},LayeredImage.prototype.toggleLayer=function(e){e.visible?this.removeLayer(e):this.createLayer(e)},LayeredImage.prototype.repaintLayer=function(e){this.removeLayer(e),this.createLayer(e)},LayeredImage.prototype.createLayerIIP=function(e){var t=this,n=this.polymaps.image(),r=function(n){var r=e.ptiff_server,i=e.ptiff_path,s=e.height,o=e.width,u=256,a=t.getScale(e.zoom_levels-1,n.zoom),f=Math.round(o/a),l=Math.round(s/a),c=Math.ceil(f/u),h=Math.ceil(l/u);if(n.row<0||n.row>=h||n.column<0||n.column>=c)return null;n.row==h-1&&n.element.setAttribute("height",l%u),n.column==c-1&&n.element.setAttribute("width",f%u);var p=r+"?fif="+i+"&jtl="+n.zoom+","+(n.row*c+n.column);return p};return n.url(r),n},LayeredImage.prototype.createLayerImage=function(e){var t=this,n=function(n){var r=t.getScale(e.zoom_levels,n.zoom);n.element=t.polymaps.svg("image"),n.element.setAttribute("preserveAspectRatio","none"),n.element.setAttribute("x",0),n.element.setAttribute("y",0),n.element.setAttribute("width",e.width/r),n.element.setAttribute("height",e.height/r),n.element.setAttributeNS("http://www.w3.org/1999/xlink","href",e.image_path),n.ready=!0},r=function(e){e.request&&e.request.abort(!0)},i=this.polymaps.layer(n,r).tile(!1);return i},LayeredImage.prototype.createLayerSVG=function(e){var t=this,n=function(n){var r=t.getScale(e.zoom_levels,n.zoom);n.element=t.polymaps.svg("image"),n.element.setAttribute("preserveAspectRatio","none"),n.element.setAttribute("x",0),n.element.setAttribute("y",0),n.element.setAttribute("width",e.width/r),n.element.setAttribute("height",e.height/r),n.element.setAttributeNS("http://www.w3.org/1999/xlink","href",e.svg_path),n.ready=!0},r=function(e){e.request&&e.request.abort(!0)},i=this.polymaps.layer(n,r).tile(!1);return i},LayeredImage.prototype.zoomToContainer=function(){var e=18,t,n;for(t=0,n=this.layers.length;t<n;t++){var r=this.layers[t],i=this.getScale(r.zoom_levels-0,e);r.type=="iip"&&(i=this.getScale(r.zoom_levels-1,e));var s=Math.round(r.width/i),o=Math.round(r.height/i),u=Math.ceil(s/this.map.tileSize().x),a=Math.ceil(o/this.map.tileSize().y);r.tiles_wide=u,r.tiles_high=a,r.tiles_zoom=e}var f=0,l=0;for(t=0,n=this.layers.length;t<n;t++)this.layers[t].tiles_high>l&&(l=this.layers[t].tiles_high),this.layers[t].tiles_wide>f&&(f=this.layers[t].tiles_wide);this.settings.containerFitSW=this.map.coordinateLocation({zoom:e,column:0,row:l}),this.settings.containerFitNE=this.map.coordinateLocation({zoom:e,column:f,row:0}),this.map.extent([this.settings.containerFitSW,this.settings.containerFitNE]),this.settings.containerFitZoomLevel=this.map.zoom(),this.resetZoomRange(this.settings.containerFitZoomLevel)},LayeredImage.prototype.createUI=function(){var e=this.$,t=this,n,r;if(!this.figureOptions.disable_interaction||this.figureOptions.editing)this.map.add(this.polymaps.drag()).add(this.polymaps.wheel()).add(this.polymaps.dblclick()).add(this.polymaps.touch()),e(this.container).bind({mousewheel:function(e){t.ui.zoomSlider.slider("value",t.map.zoom()),t.refreshViewfinderViewport()},DOMMouseScroll:function(e){t.ui.zoomSlider.slider("value",t.map.zoom()),t.refreshViewfinderViewport()},dblclick:function(e){t.ui.zoomSlider.slider("value",t.map.zoom()),t.refreshViewfinderViewport()},mousedown:function(e){t.settings.dragging={x:e.clientX,y:e.clientY},liCollection.userIsDraggingAsset=t.id}});this.ui={},this.ui.legendItemsCount=0,this.ui.controlbar=e('<div class="ca-ui-controlbar"></div>'),this.settings.collapsed?n="collapsed":n="expanded",this.ui.fullscreen=e('<div class="ca-ui-fullscreen '+n+'"></div>').bind("click",function(){t.settings.collapsed?t.fullscreen():(window.liCollection.remove(t),e(".ca-ui-fullscreen-modal").remove(),window.scrollOffset&&window.scrollTo(window.scrollOffset[0],window.scrollOffset[1]))}).appendTo(this.ui.controlbar),this.ui.reset=e('<div class="ca-ui-reset"></div>').bind("click",function(e){t.reset()}),(!this.figureOptions.disable_interaction||this.figureOptions.editing)&&this.ui.reset.appendTo(this.ui.controlbar),this.annotationLayers.length>0&&(this.ui.annotation=e('<div class="ca-ui-annotation"></div>').bind("click",function(e){t.toggleAnnotationSelector()}),(!this.figureOptions.disable_annotation||this.figureOptions.editing)&&this.ui.annotation.appendTo(this.ui.controlbar));var i=this.getVisibleBaseLayers();this.settings.currentLayer1=i[0];if(i.length>1){this.settings.currentLayer2=i[1],this.ui.layerSelector=e('<div class="ca-ui-layer-selector"></div>'),this.baseLayers.length>2&&this.ui.layerSelector.bind("click",{layeredImage:this},this.toggleLayerSelector),(!this.figureOptions.disable_interaction||this.figureOptions.editing)&&this.ui.controlbar.append(this.ui.layerSelector),this.ui.sliderContainer=e('<div class="ca-ui-layer-slider-container"></div>'),this.ui.sliderLayerText=e('<div class="ca-ui-layer-slider-layer-text"></div>').text(this.settings.currentLayer1.title+" - "+this.settings.currentLayer2.title).appendTo(this.ui.sliderContainer),this.ui.slider=e('<div class="ca-ui-layer-slider"></div>').slider({slide:function(n,r){var i=r.value/100;e("#"+t.settings.currentLayer2.id).css("opacity",i),t.refreshViewfinderOpacity(i)},change:function(n,r){var i=r.value/100;e("#"+t.settings.currentLayer2.id).css("opacity",i),t.refreshViewfinderOpacity(i)}}).appendTo(this.ui.sliderContainer);if(!this.figureOptions.disable_interaction||this.figureOptions.editing)this.ui.sliderContainer.appendTo(this.ui.controlbar),this.ui.layerSelector.after(this.ui.sliderContainer);this.figureOptions.sliderPosition!==undefined&&this.ui.slider.slider("value",this.figureOptions.sliderPosition)}this.ui.controlbar.appendTo(this.container),this.resizeControlBar(),this.ui.zoom=e('<div class="ca-ui-zoom"></div>'),this.ui.zoomIn=e('<div class="ca-ui-zoom-in"></div>').bind("click",function(e){var n=t.ui.zoomSlider.slider("value"),r=n+t.settings.zoomStep;t.ui.zoomSlider.slider("value",r),t.map.zoom(r)}).appendTo(this.ui.zoom),this.ui.zoomSlider=e('<div class="ca-ui-zoom-slider"></div>').slider({step:this.settings.zoomStep,orientation:"vertical",slide:function(e,n){var r=n.value,i=t.map.zoom();r!=i&&t.map.zoom(r)}}).appendTo(this.ui.zoom),this.ui.zoomOut=e('<div class="ca-ui-zoom-out"></div>').bind("click",function(e){var n=t.ui.zoomSlider.slider("value"),r=n-t.settings.zoomStep;t.ui.zoomSlider.slider("value",r),t.map.zoom(r)}).appendTo(this.ui.zoom),(!this.figureOptions.disable_interaction||this.figureOptions.editing)&&this.ui.zoom.appendTo(this.container),this.ui.viewfinder=e('<div class="ca-ui-viewfinder viewfinder-closed"></div>'),(!this.figureOptions.disable_interaction||this.figureOptions.editing)&&this.ui.viewfinder.appendTo(this.container),this.ui.viewfinder.bind("click",function(e){t.ui.viewfinder.hasClass("viewfinder-open")?(t.ui.viewfinder.empty().css("height",""),t.ui.viewfinder.removeClass("viewfinder-open").addClass("viewfinder-closed"),t.ui.viewfinderViewport=null):(t.ui.viewfinder.removeClass("viewfinder-closed").addClass("viewfinder-open"),t.refreshViewfinder())}),this.ui.controls=[this.ui.controlbar,this.ui.zoom,this.ui.viewfinder,this.ui.currentPopup,this.ui.annotation,this.ui.layerSelector],this.container.bind("mousemove",function(e){var n=t.container,r=new Date;n.attr("data-controls-time",r.getTime());var i=n.attr("data-controls")||"false";if(i=="false"){var s=window.liCollection.list();for(var o=0,u=s.length;o<u;o++){var a=s[o];a.container.attr("data-controls")=="true"&&(a.container.attr("data-controls","false"),a.toggleControls())}n.attr("data-controls","true"),t.toggleControls()}t.ui.controlsTimeout=setTimeout(function(){var e=new Date;n.attr("data-controls")=="true"&&e.getTime()-n.attr("data-controls-time")>=1750&&n.attr("data-controls-lock")!="true"&&(n.attr("data-controls","false"),t.clearPopups(),t.toggleControls())},2e3)}),e.each(this.ui.controls,function(){typeof this.bind=="function"&&(this.bind("mouseenter",function(){t.container.attr("data-controls-lock","true")}),this.bind("mouseleave",function(){t.container.attr("data-controls-lock","false")}))})},LayeredImage.prototype.reset=function(){var e=this.$,t,n,r=this;r.clearPopups();if(typeof r.figureOptions.swLat!="undefined"&&!r.figureOptions.editing){var i=[{lon:r.figureOptions.swLon,lat:r.figureOptions.swLat},{lon:r.figureOptions.neLon,lat:r.figureOptions.neLat}];r.map.extent(i)}else r.zoomToContainer();r.ui.zoomSlider.slider("value",r.map.zoom()),r.figureOptions.sliderPosition!==undefined&&r.ui.slider&&r.ui.slider.slider("value",r.figureOptions.sliderPosition);var s;if(r.figureOptions.baseLayerPreset){s=[];for(t=0,n=r.figureOptions.baseLayerPreset.length;t<n;t++)s.push(r.getLayerById(r.figureOptions.baseLayerPreset[t]))}else s=r.baseLayers;for(t=0,n=s.length;t<n&&t<2;t++)currentLayer=r.settings["currentLayer"+(t+1)],r.toggleLayer(currentLayer),r.toggleLayer(s[t]),r.settings["currentLayer"+(t+1)]=s[t],r.ui["layerSelector"+(t+1)]&&r.ui["layerSelector"+(t+1)].find("span").html(s[t].title);s.length>1&&r.ui.slider&&(e("#"+r.settings.currentLayer2.id).css("opacity",r.ui.slider.slider("value")/100),r.ui.viewfinderLayer2&&r.ui.viewfinderLayer2.css("opacity",r.ui.slider.slider("value")/100)),r.showAnnotationPresets()},LayeredImage.prototype.refreshViewfinder=function(){var e=this.$,t=this;this.ui.viewfinder.empty();var n=this.settings.currentLayer1.thumb;this.ui.viewfinderLayer1=e('<div class="ca-ui-viewfinderLayer viewfinderLayer1"></div>'),e("<img />").attr("src",n).appendTo(this.ui.viewfinderLayer1),this.ui.viewfinder.append(this.ui.viewfinderLayer1);if(this.settings.currentLayer2){var r=this.settings.currentLayer2.thumb;this.ui.viewfinderLayer2=e('<div class="ca-ui-viewfinderLayer viewfinderLayer2"></div>'),e("<img />").attr("src",r).appendTo(this.ui.viewfinderLayer2),this.ui.viewfinder.append(this.ui.viewfinderLayer2),this.ui.viewfinderLayer2.css("opacity",this.ui.slider.slider("value")/100)}var i=this.ui.viewfinder.width(),s=Math.floor(i/this.settings.aspect);this.ui.viewfinder.height(s),this.refreshViewfinderViewport()},LayeredImage.prototype.refreshViewfinderViewport=function(){if(this.ui.viewfinder.hasClass("viewfinder-open")){var e=this.$,t=this.ui.viewfinder.width(),n=Math.floor(t/this.settings.aspect);this.ui.viewfinderViewport||(this.ui.viewfinderViewport=e('<div class="ca-ui-viewfinder-viewport">&nbsp;</div>').appendTo(this.ui.viewfinder),this.settings.viewPortBorderWidth===undefined&&(this.settings.viewPortBorderWidth=parseInt(this.ui.viewfinderViewport.css("border-left-width"),10)));var r=this.map.locationPoint(this.settings.containerFitSW),i=this.map.locationPoint(this.settings.containerFitNE),s=r.x*-1/(i.x-r.x)*t-this.settings.viewPortBorderWidth,o=i.y*-1/(r.y-i.y)*n-this.settings.viewPortBorderWidth,u=this.map.size().x/(i.x-r.x),a=this.map.size().y/(r.y-i.y),f=u*t,l=a*n;this.ui.viewfinderViewport.css({top:o+"px",left:s+"px",width:f+"px",height:l+"px"})}},LayeredImage.prototype.refreshViewfinderOpacity=function(e){this.ui.viewfinderLayer2&&this.ui.viewfinderLayer2.css("opacity",e)},LayeredImage.prototype.fullscreen=function(e){var t=this.$,n=this,r=t('<div class="ca-ui-fullscreen-modal"></div>').appendTo(document.body);r.bind("click",function(e){t(e.target).hasClass("ca-ui-fullscreen-modal")&&t(this).find(".ca-ui-fullscreen").trigger("click")});var i=t('<div class="ca-ui-fullscreen-wrap"></div>').appendTo(r),s=r.offset(),o=r.height()-s.top,u=r.outerWidth()-s.left;i.css({height:Math.round(o*.9)+"px",top:Math.round(o*.05)+"px",width:Math.round(u*.9)+"px",left:Math.round(u*.05)+"px"});var a=t(this.settings.originalMarkup);a.attr("id",a.attr("id")+"-fullscreen"),a.attr("data-collapsed","false"),a.find("li").each(function(){var e=t(this);e.data("id",e.data("id")+"-fullscreen"),e.data("parent_asset",e.data("parent_asset")+"-fullscreen")});var f=this.map.extent();this.figureOptions.fullscreenExtents={swLon:f[0].lon,swLat:f[0].lat,neLon:f[1].lon,neLat:f[1].lat};var l=t("<figure></figure>").attr("data-options",JSON.stringify(this.figureOptions)).css({height:Math.round(o*.9)+"px",width:Math.round(u*.9)+"px"}).appendTo(i),c=0;this.settings.captionMarkup&&(l.append(this.settings.captionMarkup),c=this.settings.captionMarkup.outerHeight(!0)),t("<div>",{"class":"figureContent",css:{height:Math.round(o*.9)-c+"px",width:Math.round(u*.9)+"px"}}).append(a).prependTo(l);var h=new LayeredImage(a);e&&h.reset()},LayeredImage.prototype.resizeControlBar=function(){var e=this.container.outerWidth(),t=this.ui.controlbar.outerWidth(),n=e-parseInt(this.ui.controlbar.css("right"),10)*2;t>n&&(this.ui.controlbar.css({"max-width":n+"px"}),this.ui.controlbar.find(".ca-ui-layer > span").css({width:"1px"}))},LayeredImage.prototype.toggleLayerSelector=function(e){var t=jQuery,n=e.data.layeredImage,r=t(this),i=n.settings.currentLayer1,s=n.settings.currentLayer2;if(n.ui.currentPopup&&n.ui.currentPopup==n.ui["layerSelectorPopup"])n.clearPopups();else{n.clearPopups(),r.addClass("active"),rows=t('<div class="ca-ui-layer-selector-rows"></div>');for(var o=0;o<n.baseLayers.length;o++){var u=n.baseLayers[o];rowLayerButton1=t('<div class="ca-ui-layer-selector-row-button1"><div class="ca-ui-layer-selector-button"></div></div>').attr("data-layer_index",o),rowTitle=t('<div class="ca-ui-layer-selector-row-title"><span>'+u.title+"</span></div>"),rowLayerButton2=t('<div class="ca-ui-layer-selector-row-button2"><div class="ca-ui-layer-selector-button"></div></div>').attr("data-layer_index",o),u==n.settings.currentLayer1&&rowLayerButton1.find(".ca-ui-layer-selector-button").first().addClass("active"),u==n.settings.currentLayer2&&rowLayerButton2.find(".ca-ui-layer-selector-button").first().addClass("active"),rowLayerButton1.bind("click",{CA:n,layerNum:1},n.layerSelect),rowLayerButton2.bind("click",{CA:n,layerNum:2},n.layerSelect),row=t('<div class="ca-ui-layer-selector-row"></div>').append(rowLayerButton1).append(rowTitle).append(rowLayerButton2),rows.append(row)}var a=parseInt(n.ui.controlbar.css("bottom"),10)+n.ui.controlbar.height(),f=n.ui.controlbar.position().left,l=n.ui.sliderContainer.outerWidth()+r.outerWidth(),c={bottom:a+"px",left:f+"px"};n.ui.layerSelectorPopup=t('<div class="ca-ui-layer-selector-popup"></div>').css(c).bind("mouseenter",function(){n.container.attr("data-controls-lock","true")}).bind("mouseleave",function(){n.container.attr("data-controls-lock","false")}).append(rows).appendTo(n.container),n.ui.currentPopup=n.ui.layerSelectorPopup}},LayeredImage.prototype.toggleAnnotationSelector=function(){var e=this.$,t=this;if(this.ui.currentPopup&&this.ui.currentPopup==this.ui.annotationSelector)this.clearPopups();else{this.clearPopups(),this.ui.annotation.addClass("active");var n=this.ui.annotation.offsetParent().position(),r=this.ui.annotation.position(),i=this.ui.annotation.outerWidth(),s=this.ui.annotation.offsetParent().parent().width(),o=this.ui.annotation.offsetParent().parent().height(),u=s-n.left-r.left-i,a=o-n.top-r.top;this.settings.annotationSelectorVisible=!0,this.ui.annotationSelector=e('<div class="ca-ui-annotation-selector"></div>').css({right:u,bottom:a}),e('<div class="title">Annotations</div>').appendTo(this.ui.annotationSelector),this.ui.annotationSelectorList=e('<ul class="ca-ui-annotation-selector-list"></ul>');for(var f=0,l=this.annotationLayers.length;f<l;f++){var c=this.annotationLayers[f],h=e("<li></li>").bind("click",{layerData:c,CA:t},t.annotationLayerClick),p=e('<div class="ca-ui-annotation-selector-item-box"></div>').addClass(c.visible?"filled":"empty");c.visible&&c.annotation&&p.css("background-color","#"+c.color),h.append(p).append("<span>"+c.title+"</span>").appendTo(this.ui.annotationSelectorList)}this.ui.annotationSelector.bind("mouseenter",function(){t.container.attr("data-controls-lock","true")}).bind("mouseleave",function(){t.container.attr("data-controls-lock","false")}).append(this.ui.annotationSelectorList).appendTo(this.container),this.ui.currentPopup=this.ui.annotationSelector}},LayeredImage.prototype.annotationLayerClick=function(e){var t=e.data.layerData,n=e.data.CA;n.toggleLayer(t);var r=$(this).find(".ca-ui-annotation-selector-item-box");if(t.visible){r.removeClass("empty").addClass("filled");if(t.annotation&&t.type=="svg"){var i=t.color||"#fff";r.css("background-color","#"+i),n.addLegendItem(t)}}else r.removeClass("filled").addClass("empty"),t.annotation&&t.type=="svg"&&(r.css("background-color",""),n.removeLegendItem(t))},LayeredImage.prototype.resetZoomRange=function(e){e=e||0;var t=0;for(var n=0,r=this.layers.length;n<r;n++)this.layers[n].type=="iip"?this.layers[n].zoom_levels-1>t&&(t=this.layers[n].zoom_levels-1):this.layers[n].zoom_levels>t&&(t=this.layers[n].zoom_levels);this.map.zoomRange([e,t]),this.ui.zoomSlider.slider("option","min",e),this.ui.zoomSlider.slider("option","max",t)},LayeredImage.prototype.getZoomLevels=function(e,t){var n=this.map.tileSize().x,r=1;while(e>n||t>n)r++,e/=2,t/=2;return r},LayeredImage.prototype.getScale=function(e,t){return Math.pow(2,e-t)},LayeredImage.prototype.realignLayers=function(){var e=this.$,t,n,r=this.container.find("svg.map"),i=r.find("g.layer").remove();for(t=0,n=i.length;t<n;t++)e(i[t]).attr("id")==this.settings.currentLayer1.id&&(r.append(i[t]),i.splice(t,1));for(t=0,n=i.length;t<n;t++)e(i[t]).attr("id")==this.settings.currentLayer2.id&&(r.append(i[t]),i.splice(t,1));r.append(i)},LayeredImage.prototype.clearPopups=function(){var e=this;this.ui.currentPopup&&(this.ui.currentPopup.fadeOut(400,function(){$(this).remove()}),this.ui.currentPopup=!1),this.ui.controls&&$.each(this.ui.controls,function(){$(this).removeClass("active")})},LayeredImage.prototype.toggleControls=function(e){e=e||400;var t=this.$;t.each(this.ui.controls,function(){this!=window&&this.fadeToggle(e)})},LayeredImage.prototype.addLegendItem=function(e){var t=this.$;if(!e.color||e.color==="")return;this.ui.legend||(this.ui.legend=t('<div class="ca-ui-legend"><ul class="legendList"></ul></div>').appendTo(this.container),this.container.attr("data-controls")!="true"&&this.ui.legend.css("display","none"),this.ui.controls.push(this.ui.legend));var n=this.ui.legend.find("ul"),r=t('<li data-layer_num="'+e.layer_num+'">'+e.title+"</li>").appendTo(n),i=t('<div class="item-box"></div>').css("background-color","#"+e.color).prependTo(r);this.ui.legendItemsCount++},LayeredImage.prototype.removeLegendItem=function(e){var t=this.$,n=this;if(this.ui.legend){var r=this.ui.legend.find("ul").children();r.each(function(){t(this).attr("data-layer_num")==e.layer_num&&(t(this).remove(),n.ui.legendItemsCount--)});if(this.ui.legendItemsCount<=0){this.ui.legend.remove(),delete this.ui.legend;for(var i=0,s=this.ui.controls.length;i<s;i++)t(this.ui.controls[i]).hasClass("ca-ui-legend")&&this.ui.controls.splice(i,1)}}},LayeredImage.prototype.showAnnotationPresets=function(){for(var e=0,t=this.annotationLayers.length;e<t;e++){this.removeLayer(this.annotationLayers[e]),this.removeLegendItem(this.annotationLayers[e]);if(this.figureOptions.annotationPreset)for(var n=0,r=this.figureOptions.annotationPreset.length;n<r;n++){var i=this.figureOptions.annotationPreset[n];if(this.annotationLayers[e].layer_id==i){this.repaintLayer(this.annotationLayers[e]),(!this.figureOptions.disable_annotation||this.figureOptions.editing)&&this.addLegendItem(this.annotationLayers[e]);break}}}},LayeredImage.prototype.getVisibleBaseLayers=function(){var e,t,n=[];for(e=0,t=this.baseLayers.length;e<t;e++){var r=this.baseLayers[e];r.visible&&n.push(r)}return n},LayeredImage.prototype.getVisibleBaseLayerIds=function(){var e,t,n=[];for(e=0,t=this.baseLayers.length;e<t;e++){var r=this.baseLayers[e];r.visible&&n.push(r.layer_id)}return n},LayeredImage.prototype.getVisibleAnnotationIds=function(){var e,t,n=[];for(e=0,t=this.annotationLayers.length;e<t;e++){var r=this.annotationLayers[e];r.visible&&n.push(r.layer_id)}return n},LayeredImage.prototype.getExtents=function(){var e=this.map.extent();return{swLon:e[0].lon,swLat:e[0].lat,neLon:e[1].lon,neLat:e[1].lat}},LayeredImage.prototype.setExtents=function(e){this.map.extent(e),this.ui.zoomSlider&&this.ui.zoomSlider.slider("value",this.map.zoom())},LayeredImage.prototype.getSliderPosition=function(){return typeof this.ui.slider!="undefined"?this.ui.slider.slider("value"):0},LayeredImage.prototype.getLayerById=function(e){for(var t=0,n=this.layers.length;t<n;t++)if(this.layers[t].layer_id&&this.layers[t].layer_id==e)return this.layers[t];return!1},LayeredImage.prototype.layerSelect=function(e){var t=e.data.CA,n=e.data.layerNum,r=parseInt($(this).attr("data-layer_index"),10),i=$(this).find(".ca-ui-layer-selector-button");if(i.hasClass("active"))return;var s=n==1?2:1,o=t.ui.layerSelectorPopup.find(".ca-ui-layer-selector-row-button"+s+'[data-layer_index="'+r+'"] .ca-ui-layer-selector-button');if(o.hasClass("active"))return;t.removeLayer(t.settings["currentLayer"+n]),t.createLayer(t.baseLayers[r]),t.settings["currentLayer"+n]=t.baseLayers[r];if(n==2){var u=t.ui.slider.slider("value"),a=u/100;$("#"+t.settings.currentLayer2.id).css("opacity",a)}t.ui.layerSelectorPopup.find(".ca-ui-layer-selector-row-button"+n+" .ca-ui-layer-selector-button").removeClass("active"),i.addClass("active"),t.ui.sliderLayerText.text(t.settings.currentLayer1.title+" - "+t.settings.currentLayer2.title),t.realignLayers()},window.liCollection=new LICollection,window.addEventListener("mousemove",liMousemove,!1),window.addEventListener("mouseup",liMouseup,!1),app={router:undefined,config:undefined,views:{},models:{},collections:{},bootstrap:function(e){this.config=new OsciTk.models.Config(e),this.router=new OsciTk.router,this.account=new OsciTk.models.Account,this.collections.notes=new OsciTk.collections.Notes,this.collections.figures=new OsciTk.collections.Figures,this.collections.footnotes=new OsciTk.collections.Footnotes,this.collections.navigationItems=new OsciTk.collections.NavigationItems,this.collections.glossaryTerms=new OsciTk.collections.GlossaryTerms,window.onresize=function(){window.resizeTimer&&clearTimeout(window.resizeTimer);var e=function(){Backbone.trigger("windowResized")};window.resizeTimer=setTimeout(e,200)},this.views.app=new OsciTk.views.App},run:function(){this.models.docPackage=new OsciTk.models.Package({url:this.config.get("packageUrl")}),Backbone.history.start()}},app.zotero=_.extend({init:function(){this.listenTo(Backbone,"packageLoaded",function(e){var t=new Date(e.get("dc:date"));t=t.getFullYear()+"-"+(t.getMonth()+1)+"-"+t.getDate();var n=["ctx_ver=Z39.88-2004","rft_val_fmt=info%3Aofi%2Ffmt%3Akev%3Amtx%3Abook","rft.genre=book","rft.date="+t,"rfr_id="+e.get("dc:identifier"),"rft.btitle="+e.get("dc:title"),"rft.atitle="+e.get("dc:title"),"rft.au="+e.get("dc:creator"),"rft.pub="+e.get("dc:publisher")],r=$("<span></span>");r.addClass("Z3988"),r.attr("title",n.join("&")),r.appendTo($("body"));var i=document.createEvent("HTMLEvents");i.initEvent("ZoteroItemUpdated",!0,!0),document.dispatchEvent(i)})}},Backbone.Events);