/*
 * OSCI Toolkit - v0.1.0 - 2012-10-23
 * http://oscitoolkit.org/
 * Copyright (c) 2010-2012 The Art Institute of Chicago and the Indianapolis Museum of Art
 * GNU General Public License
 */
function loadXMLDoc(a){return xhttp=new XMLHttpRequest,xhttp.overrideMimeType("text/xml"),xhttp.open("GET",a,!1),xhttp.send(),xhttp.responseXML}function xmlToJson(a,b){var c=!0,d=0;if(!b){b=["xml:"];for(d=0;d<a.documentElement.attributes.length;d++)a.documentElement.attributes.item(d).nodeName.indexOf("xmlns")!=-1&&b.push(a.documentElement.attributes.item(d).nodeName.replace("xmlns:","")+":")}var e=!0;if(a.attributes&&a.attributes.length>0){var f;e={};for(var g=0;g<a.attributes.length;g++)f=a.attributes.item(g),e[f.nodeName.replaceArray(b,"").toCamel()]=f.nodeValue}if(a.hasChildNodes()){var h,i,j;e===!0&&(e={});for(var k=0;k<a.childNodes.length;k++){j=a.childNodes.item(k);if((j.nodeType&7)===1)h=j.nodeName.replaceArray(b,"").toCamel(),i=xmlToJson(j,b),e.hasOwnProperty(h)?(e[h].constructor!==Array&&(e[h]=[e[h]]),e[h].push(i)):e[h]=i;else if((j.nodeType-1|1)===3){h="value",i=j.nodeType===3?j.nodeValue.replace(/^\s+|\s+$/g,""):j.nodeValue;if(e.hasOwnProperty(h))e[h]+=i;else if(j.nodeType===4||i!=="")e[h]=i}}}return e}function outerHTML(a){return a.outerHTML||function(a){var b=document.createElement("div"),c;return b.appendChild(a.cloneNode(!0)),c=b.innerHTML,b=null,c}(a)}function liMousemove(a){if(window.liCollection&&liCollection.userIsDraggingAsset){var b=liCollection.find(liCollection.userIsDraggingAsset);if(b){if(!b.settings.dragging)return;b.refreshViewfinderViewport(),a.conservationDraggingRemove&&(b.settings.dragging=undefined,liCollection.userIsDraggingAsset=!1)}}}function liMouseup(a){window.liCollection&&liCollection.userIsDraggingAsset&&(a.conservationDraggingRemove=!0,liMousemove(a))}OsciTk={},OsciTk.collections={},OsciTk.models={},OsciTk.templates={},OsciTk.views={figureTypeRegistry:{}},String.prototype.replaceArray=function(a,b){var c=this;for(var d=0;d<a.length;d++)c=c.replace(a[d],b);return c},String.prototype.toCamel=function(){return this.replace(/\s(.)/g,function(a){return a.toUpperCase()}).replace(/\s/g,"").replace(/^(.)/,function(a){return a.toLowerCase()})},OsciTk.router=Backbone.Router.extend({routes:{"":"routeToSection","section/:section_id":"routeToSection","section/:section_id/:identifier":"routeToSection"},routeToSection:function(a,b){app.dispatcher.trigger("routedToSection",{section_id:a,identifier:b})}}),OsciTk.templateManager={get:function(a){return function(b){return OsciTk.templateManager.useTemplate(a,b)}},useTemplate:function(a,b){if(OsciTk.templates[a]===undefined){var c=app.config.get("templateUrls"),d=!1,e=c.length;for(var f=0;f<e;f++){$.ajax({async:!1,dataType:"html",url:c[f]+a+".tpl.html",success:function(b,c,e){OsciTk.templates[a]=_.template(b),d=!0}});if(d)break}}return OsciTk.templates[a](b)}},OsciTk.collections.BaseCollection=Backbone.Collection.extend(),OsciTk.models.BaseModel=Backbone.Model.extend(),OsciTk.views.BaseView=Backbone.View.extend({getChildViews:function(){return this.childViews||(this.childViews=[]),this.childViews},addView:function(a,b){return a.parent=this,typeof b=="undefined"?this.$el.append(a.el):this.$el.find(b).append(a.el),this._addViewReference(a),this},removeAllChildViews:function(){if(this.childViews){for(var a=0,b=this.childViews.length;a<b;a++)this.childViews[a].close();this.childViews=[]}return this},removeView:function(a,b){if(this.childViews)for(var c=0,d=this.childViews.length;c<d;c++)if(a.cid===this.childViews[c].cid){this.childViews.splice(c,1),a.$el.detach(),(b||b===undefined)&&a.close();break}return this},getChildViewById:function(a){var b;if(this.childViews)for(var c=0,d=this.childViews.length;c<d;c++)if(a===this.childViews[c].cid){b=this.childViews[c];break}return b},getChildViewByIndex:function(a){var b;return this.childViews&&this.childViews[a]&&(b=this.childViews[a]),b},getChildViewsByType:function(a){return _.filter(this.childViews,function(b){return b.$el.is(a)})},replaceView:function(a,b){return a.parent=this,typeof b=="undefined"?this.$el.html(a.el):this.$el.find(b).html(a.el),this._addViewReference(a),this},changeModel:function(a){return this.model=a,this},close:function(){this.removeAllChildViews(),this.remove(),this.unbind(),this.undelegateEvents(),this.onClose&&this.onClose()},_addViewReference:function(a){this.childViews||(this.childViews=[]);var b=!1;for(var c=0,d=this.childViews.length;c<d;c++)if(a.cid===this.childViews[c].cid){b=!0;break}b||this.childViews.push(a)}}),OsciTk.templates["account-login"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<h3>Login</h3>\n<div class="form-error"></div>\n<form id="account-form">\n\t<label for="username">Username:</label>\n\t<input type="text" id="username" placeholder="Username" />\n\t<label for="password">Password:</label>\n\t<input type="password" id="password" placeholder="Password" />\n\t<button type="button" class="login">Log In</button>\n\t<div><a href="#" class="register">Register an account</a></div>\n</form>';return __p},OsciTk.templates["account-profile"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+="<h3>Profile</h3>\n<h4>"+username+"</h4>\n<h5>"+email+'</h5>\n<div><a href="#" class="logout">Log out</a></div>';return __p},OsciTk.templates["account-register"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<h2>Register</h2>\n<div class="form-error"></div>\n<form id="account-form">\n\t<label for="username">Username:</label>\n\t<input type="text" id="username" placeholder="Username" />\n\t<label for="password">Password:</label>\n\t<input type="password" id="password" placeholder="Password" />\n\t<label for="email">Email:</label>\n\t<input type="text" id="email" placeholder="Email" />\n\t<button type="button" class="register">Register</button>\n\t<div><a href="#" class="login">Already have an account?</a></div>\n</form>';return __p},OsciTk.templates.citation=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<div class="citations">\n\t<span>Format</span>\n\t<ul class="formats">\n\t\t<li class="active"><a href="#citation-format-chicago">Chicago</a></li>\n\t\t<li><a href="#citation-format-mla">MLA</a></li>\n\t</ul>\n\t<div id="citation-format-chicago" class="citation">\n\t\t'+creator+', "<em>'+title+'</em>," in <em>'+publicationTitle+"</em>, ed. "+editor+" "+publisher+" "+formattedDate+", para "+paragraphNumber+'.\n\t</div>\n\t<div id="citation-format-mla" style="display: none;" class="citation">\n\t\t'+creator+', "<em>'+title+'</em>," in <span style="text-decoration:underline;">'+publicationTitle+"</span>, ed. "+editor+" ("+publisher+"), "+formattedDate+", "+paragraphNumber+'.\n\t</div>\n</div>\n<div class="citation_url">\n\t<span>Citation URL</span>\n\t<input disabled="disabled" value="'+url+'" />\n</div>\n<div class="reference_text">\n\t<span>Reference Text</span>\n\t<textarea disabled="disabled">'+referenceText+"</textarea>\n</div>";return __p},OsciTk.templates["figure-reference"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<a href="#'+id+'" class="figure_reference">'+title+"</a>";return __p},OsciTk.templates.figures=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+="<div class='figure-browser'>\n\t<h3>Figures</h3>\n\t<div class='figure-tray'>\n\t\t<div class='figure-reel'>\n\t\t\t",_.each(figures,function(a){__p+="\n\t\t\t\t<figure class='thumbnail' data-figure-id=\""+a.id+'">\n\t\t\t\t\t',a.thumbnail_url!=undefined?__p+="\n\t\t\t\t\t\t<img class='figure-thumbnail' src='"+a.thumbnail_url+"'/>\n\t\t\t\t\t":__p+="\n\t\t\t\t\t\t<div class='figure-thumbnail'>&nbsp;</div>\n\t\t\t\t\t",__p+="\n\t\t\t\t\t<figcaption>"+a.title+"</figcaption>\n\t\t\t\t</figure>\n\t\t\t"}),__p+="\n\t\t</div>\n\t</div>\n</div>\n<div class='figure-previews'>\n\t<div class='figure-nav prev' title='Previous figure'>&lt;</div>\n\t<div class='figure-nav next' title='Next Figure'>&gt;</div>\n\n\t<h3><span class='back-to-grid'>&laquo; Figures</span> | <span class='title'>TITLE</span></h3>\n\t<div class='figure-tray'>\n\t\t<div class='figure-reel'>\n\t\t\t",_.each(figures,function(a){__p+="\n\t\t\t\t<figure class='preview' data-figure-id=\""+a.id+'">\n\t\t\t\t\t',a.thumbnail_url!=undefined?__p+="\n\t\t\t\t\t\t<img class='figure-preview' src='"+a.thumbnail_url+"'/>\n\t\t\t\t\t":__p+="\n\t\t\t\t\t\t<div class='figure-preview'>&nbsp;</div>\n\t\t\t\t\t",__p+="\n\t\t\t\t\t<div class='figure-info'>\n\t\t\t\t\t\t<!--<h3 class='title'>Figure Title?</h3>-->\n\t\t\t\t\t\t<!--<p class='meta-info'>meta info | more meta</p>-->\n\t\t\t\t\t\t<div class='caption'>\n\t\t\t\t\t\t\t"+a.caption+"\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<a class='view-fullscreen'>View fullscreen</a>\n\t\t\t\t\t<a class='view-in-context'>View in context</a>\n\t\t\t\t</figure>\n\t\t\t"}),__p+="\n\t\t</div>\n\t</div>\n</div>";return __p},OsciTk.templates.font=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<h3>Reading Settings</h3>\n<div class="font-control">\n\t<h3>Font Size</h3>\n\t<a href="#font-larger" class="larger font-button">A</a>\n\t<a href="#font-smaller" class="smaller font-button">A</a>\n</div>\n<div class="theme-control">\n\t<h3>Theme</h3>\n\t<a href="#normal" class="theme-button">Normal</a>\n\t<a href="#sepia" class="theme-button">Sepia</a>\n\t<a href="#night" class="theme-button">Night</a>\n</div>';return __p},OsciTk.templates["multi-column-column"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<div class="column"></div>';return __p},OsciTk.templates["multi-column-figure"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<div class="figure_content"></div>\n<figcaption>'+caption+"</figcaption>";return __p},OsciTk.templates["multi-column-section"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<div id="pages"></div>';return __p},OsciTk.templates.navigation=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+="<div class='header'>"+chapter+"</div>\n<div class='prev-page side'><div class='indicator'>&lt;</div></div>\n<div class='next-page side'><div class='indicator'>&gt;</div></div>\n<div class='prev-page corner'>\n\t<div class='label'>Previous</div>\n\t<div class='button'>&nbsp;</div>\n</div>\n<div class='pager'><div class='head'>&nbsp;</div></div>\n<div class='next-page corner'>\n\t<div class='label'>Next</div>\n\t<div class='button'>&nbsp;</div>\n</div>";return __p},OsciTk.templates["note-popup"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<form class="noteForm">\n\t<textarea>'+note+'</textarea>\n\t<div class="status">Saved</div>\n</form>\n<div class="reference-text">\n\t<span class="reference-text-label">Reference Text</span>\n\t<div class="reference-text-content">'+referenceContent+"</div>\n</div>";return __p},OsciTk.templates.notes=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<h3>Notes</h3>\n<div class="notesReel">\n\t<ul class="notesList">\n\t\t',_.each(notes,function(a){__p+='\n\t\t\t<li class="notesListItem">\n\t\t\t\t<div class="the-note">\n\t\t\t\t\t<span class="note-content">'+a.get("note")+"</span>\n\t\t\t\t</div>\n\t\t\t\t",a.get("tags").length>0&&(__p+='\n\t\t\t\t\t<div class="note-tags">\n\t                \t<span class="tags-label">tags:</span> ',_.each(a.get("tags"),function(a){__p+=""+a+" "}),__p+="\n\t                </div>\n\t\t\t\t"),__p+='\n\t\t\t\t<div class="note-buttons">\n\t\t\t\t\t<a href="#" class="noteLink" data-content_id="'+a.get("content_id")+'">Link</a>\n\t\t\t\t\t<!-- <a href="#" class="noteEdit" data-content_id="'+a.get("content_id")+'">Edit</a> -->\n\t\t\t\t</div>\n\t\t\t</li>\n\t\t'}),__p+="\n\t</ul>\n</div>";return __p},OsciTk.templates.page=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+=""+content+"";return __p},OsciTk.templates["search-results"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+="",query.keyword&&(__p+='\n<div id="search-results-header">\n\t<div id="search-summary">\n\t\tResult(s) for <span id="search-query">"'+query.keyword+'"</span> ('+response.numFound+')\n\t\t<a id="reset-search" href="#">RESET</a>\n\t</div>\n\t<div id="results-sort">\n\t\tSort By:\n\t\t<ul>\n\t\t\t<li id="results-sort-relevance" class="sort-button"><a href="#" class="sort-button">Relevance</a></li>\n\t\t\t<li id="results-sort-type"><a href="#" class="sort-button">Type</a></li>\n\t\t</ul>\n\t</div>\n</div>\n<div id="search-results-container">\n\t<div id="search-results">\n\t\t<div id="search-results-content">\n\t\t\t',_.each(results,function(a){var b=!0;__p+='\n\t\t\t\t<div class="result-section">\n\t\t\t\t\t',_.each(a,function(a){__p+="\n\t\t\t\t\t",b&&(__p+='\n\t\t\t\t\t<div class="result-title">'+a.get("label")+"</div>\n\t\t\t\t\t",b=!1),__p+='\n\t\t\t\t\t<div class="search-result" data-id="'+a.get("id")+'">\n\t\t\t\t\t\t<div class="result-content">\n\t\t\t\t\t\t\t<div class="result-type '+a.get("bundle")+'">'+a.get("bundle")+'</div>\n\t\t\t\t\t\t\t<div class="result-body">'+a.get("teaser")+"</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t"}),__p+="\n\t\t\t\t</div>\n\t\t\t"}),__p+='\n\t\t</div>\n\t</div>\n\t<div id="filter-by-section">\n\t\t<div class="section-title">Filter by section</div>\n\t\t<ul>\n\t\t\t',_.each(response.facets,function(a){__p+='\n\t\t\t\t<li><a href="#" data-filter="section:'+a.section_id+'" class="facet">'+a.section+"</a> ("+a.count+")</li>\n\t\t\t"}),__p+="\n\t\t</ul>\n\t</div>\n</div>\n"),__p+="";return __p},OsciTk.templates.search=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<div id="search-header">\n\t<h3>Search</h3>\n\t<div id="search-box">\n\t\t<form id="search-form" name="search-form" method="POST">\n\t\t\t<input type="text" name="keyword" id="search-keyword" placeholder="search" value="'+query.keyword+'"/>\n\t\t\t<input type="hidden" name="page" id="search-page" />\n\t\t</form>\n\t</div>\n\t<div id="search-filters">\n\t\t<div class="label">Filter |</div>\n\t\t<ul>\n\t\t\t<li class="filter" data-filter="type:content" id="search-filter-content"><div class="dot">&nbsp;</div><div class="label">Content</div></li>\n\t\t\t<li class="filter" data-filter="type:notes" id="search-filter-notes"><div class="dot">&nbsp;</div><div class="label">My Notes</div></li>\n\t\t\t<li class="filter" data-filter="type:footnotes" id="search-filter-footnotes"><div class="dot">&nbsp;</div><div class="label">Footnotes</div></li>\n\t\t\t<li class="filter" data-filter="type:figures" id="search-filter-figures"><div class="dot">&nbsp;</div><div class="label">Figures</div></li>\n\t\t</ul>\n\t</div>\n</div>\n<div id="search-results-wrapper"></div>';return __p},OsciTk.templates.title=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<h1 id="publication-title"></h1>';return __p},OsciTk.templates.toc=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+="<h3>Table of Contents</h3>\n<ul>\n\t",_.each(items,function(a){__p+='\n\t\t<li class="toc-item',a.id===app.views.navigationView.currentNavigationItem.id&&print(" active"),__p+='">\n\t\t\t<a data-section-id="'+a.id+'" href="#">\n\t\t\t\t<div class="toc-item-thumbnail">\n\t\t\t\t\t',a.get("thumbnail")&&(__p+='\n\t\t\t\t\t\t<img src="'+a.get("thumbnail")+'">\n\t\t\t\t\t'),__p+='\n\t\t\t\t</div>\n\t\t\t\t<div class="toc-item-text">\n\t\t\t\t\t<h4>'+a.get("title")+"</h4>\n\t\t\t\t\t",a.get("subtitle")&&(__p+="\n\t\t\t\t\t\t<h5>"+a.get("subtitle")+"</h5>\n\t\t\t\t\t"),__p+="\n\t\t\t\t</div>\n\t\t\t</a>\n\t\t\t<hr>\n\t\t</li>\n\t"}),__p+="\n</ul>";return __p},OsciTk.templates["toolbar-item"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+=""+text+"";return __p},OsciTk.templates.toolbar=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<div id="toolbar-close">Close</div>\n<div id="toolbar-title-container">\n\t<h2 id="toolbar-title"></h2>\n</div>\n<div id="toolbar-content-container">\n\t<div id="toolbar-content"></div>\n</div>\n<div id="toolbar-handle"></div>';return __p},OsciTk.models.Account=OsciTk.models.BaseModel.extend({defaults:{username:"anonymous",id:0},initialize:function(){this.getSessionState()},sync:function(a,b,c){console.log(a,"account sync")},getSessionState:function(){var a=this;$.ajax({url:app.config.get("endpoints").OsciTkAccount,data:{action:"status"},type:"POST",dataType:"json",success:function(b){b.success===!0&&a.set(b.user)}})}}),OsciTk.models.Config=OsciTk.models.BaseModel.extend({}),OsciTk.models.Figure=OsciTk.models.BaseModel.extend({defaults:function(){return{section_id:null,delta:null,caption:null,position:null,columns:null,aspect:1,body:null,options:{}}},initialize:function(){this.parsePositionData()},parsePositionData:function(){var a=this.get("position"),b;return a.length>1?b={vertical:a[0],horizontal:a[1]}:a==="n"||a==="p"?b={vertical:a,horizontal:a}:b={vertical:a,horizontal:"na"},this.set("position",b),this}}),OsciTk.models.Footnote=OsciTk.models.BaseModel.extend({defaults:function(){return{body:"",section_id:"",delta:""}},sync:function(a,b,c){console.log("Footnote.sync: "+a)}}),OsciTk.models.NavigationItem=OsciTk.models.BaseModel.extend({defaults:function(){return{title:null,subtitle:null,uri:null,parent:null,next:null,previous:null,depth:0,thumbnail:null,timestamp:null}},initialize:function(){}}),OsciTk.models.Note=OsciTk.models.BaseModel.extend({defaults:function(){return{id:null,content_id:null,section_id:null,note:null,tags:[]}},initialize:function(a,b){this.on("error",function(a,b){console.log([a,b],"error fired")})},sync:function(a,b,c){var d=app.config.get("endpoints").OsciTkNote;console.log("Note.sync: "+a),console.log(b,"model"),console.log(c,"options");switch(a){case"create":c.data=b.toJSON(),delete c.data.id,c.success=function(a,d,e){var f=JSON.parse(a);console.log(f,"response"),f.success?(b.set("id",f.note.id),b.trigger("change")):c.error(b,e)},c.type="POST",$.ajax(d,c);break;case"update":c.data=b.toJSON(),c.success=function(a,d,e){var f=JSON.parse(a);console.log(f,"update response"),f.success?b.trigger("change"):c.error(b,e)},c.type="POST",$.ajax(d,c);break;case"delete":c.data=b.toJSON(),c.data["delete"]=1,c.type="POST",c.success=function(a,d,e){var f=JSON.parse(a);console.log(f,"delete response"),f.success?b.trigger("change"):c.error(b,e)},$.ajax(d,c)}}}),OsciTk.models.Package=OsciTk.models.BaseModel.extend({defaults:function(){return{url:null,lang:null,spine:null,manifest:null,metadata:null,id:null,version:null,xmlns:null}},initialize:function(){var a=xmlToJson(loadXMLDoc(this.get("url")));this.set("lang",a["package"].lang),this.set("spine",a["package"].spine),this.set("manifest",a["package"].manifest),this.set("metadata",a["package"].metadata);var b=a["package"].metadata["dc:identifier"];_.isArray(b)||(b=[b]);var c=b.length;for(var d=0;d<c;d++){var e=b[d];if(e.value.indexOf("urn:osci_tk_identifier:")!==!1){this.set("id",e.value.substr(23));break}}this.set("version",a["package"].version),this.set("xmlns",a["package"].xmlns),app.dispatcher.trigger("packageLoaded",this)},sync:function(a,b,c){console.log("Package.sync: "+a)},getTitle:function(){var a,b=this.get("metadata");return b["dc:title"]&&b["dc:title"].value&&(a=b["dc:title"].value),a}}),OsciTk.models.Page=OsciTk.models.BaseModel.extend({defaults:function(){return{content:[],pageNumber:0}},addContent:function(a){var b=this.get("content");return b.push(a),this},removeContentAt:function(a){var b=this.get("content");return b.splice(a,1),this},removeAllContent:function(){this.set("content",[])},contentLength:function(){return this.get("content").length}}),OsciTk.models.SearchResult=OsciTk.models.BaseModel.extend({get:function(a){if(!this.attributes[a])return this.attributes[a];var b=this.attributes[a];switch(a){case"bundle":return b==="footnote"||b==="note"||b==="figure"?b:"content";case"url":break;default:return this.attributes[a]}}}),OsciTk.models.Section=OsciTk.models.BaseModel.extend({defaults:function(){return{title:null,content:null,uri:null,media_type:"application/xhtml+xml",contentLoaded:!1,pages:new OsciTk.collections.Pages}},sync:function(a,b,c){},parse:function(a){console.log("parse section")},loadContent:function(){var a=null;if(this.get("contentLoaded")===!1){var b=loadXMLDoc(this.get("uri"));a=$(b),this.set("title",b.title),this.set("content",a),this.set("contentLoaded",!0)}a===null&&(a=$(this.get("content")));var c=a.find("section#footnotes"),d=a.find("figure");app.dispatcher.trigger("footnotesAvailable",c),app.dispatcher.trigger("figuresAvailable",d),app.dispatcher.trigger("sectionLoaded",this)},removeAllPages:function(){this.set("pages",new OsciTk.collections.Pages)}}),OsciTk.collections.Figures=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.Figure,initialize:function(){app.dispatcher.on("figuresAvailable",function(a){this.populateFromMarkup(a),app.dispatcher.trigger("figuresLoaded",this)},this)},comparator:function(a){return a.get("delta")},populateFromMarkup:function(a){var b=[];_.each(a,function(a){var c=a.id.match(/\w+-(\d+)-(\d+)/),d=$(a),e={id:a.id,rawData:a,body:a.innerHTML,section_id:c[1],delta:c[2],title:d.attr("title"),caption:d.find("figcaption").html(),content:d.find(".figure_content").html(),position:d.data("position"),columns:d.data("columns"),options:d.data("options"),thumbnail_url:undefined,type:d.data("figure_type"),aspect:d.data("aspect")},f=d.children("img.thumbnail").remove();if(f.length)e.thumbnail_url=f.attr("src"),e.preview_url=f.attr("src");else{var g=$(".figure_content img",a);g.length&&(e.thumbnail_url=g.attr("src"),e.preview_url=g.attr("src"))}b.push(e)},this),this.reset(b)}}),OsciTk.collections.Footnotes=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.Footnote,initialize:function(){app.dispatcher.on("footnotesAvailable",function(a){this.populateFromMarkup(a),app.dispatcher.trigger("footnotesLoaded",this)},this)},populateFromMarkup:function(a){_.each($("aside",a),function(a){var b=a.id.match(/\w+-(\d+)-(\d+)/),c={id:a.id,rawData:a,body:a.innerHTML,section_id:b[1],delta:b[2]};this.add(c)},this)}}),OsciTk.collections.NavigationItems=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.NavigationItem,currentNavigationItem:null,initialize:function(){app.dispatcher.on("packageLoaded",function(a){var b=_.find(a.get("manifest").item,function(a){return a.properties=="nav"});if(b){var c=xmlToJson(loadXMLDoc(b.href)),d=c.html.body.nav;for(var e=0,f=d.length;e<f;e++)if(d[e].type=="toc"){var g=d[e].ol;this.parseChildren(g,null,0);break}app.dispatcher.trigger("navigationLoaded",this)}},this)},parseChildren:function(a,b,c){_.isArray(a)===!1&&(a=[a]);for(var d=0,e=a.length;d<e;d++){var f=a[d];if(f.a){var g={id:f.a["data-section_id"],parent:b,depth:c,previous:this.at(this.length-1)||null,next:null,length:f.a["data-length"]||null,title:f.a.value,subtitle:f.a["data-subtitle"],thumbnail:f.a["data-thumbnail"],timestamp:f.a["data-timestamp"],uri:f.a.href};this.add(g);var h=this.at(this.length-1);h.get("previous")!==null&&h.get("previous").set("next",h);if(f.ol&&f.ol.li){var i;f.ol.li.length?i=f.ol.li:i=[f.ol.li];var j=c+1;for(var k=0,l=i.length;k<l;k++)this.parseChildren(i[k],h,j)}}f.li&&this.parseChildren(f.li,b,c)}}}),OsciTk.collections.Notes=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.Note,initialize:function(){app.dispatcher.on("currentNavigationItemChanged",function(a){a.id&&app.collections.notes.getNotesForSection(a.id)},this)},comparator:function(a){return a.get("content_id").match(/.*-(\d+)/)[1]},parse:function(a){return a.success?a.notes:!1},getNotesForSection:function(a){$.ajax({url:app.config.get("endpoints").OsciTkNotes,data:{section_id:a},type:"GET",dataType:"json",success:function(a){a.success===!0&&(app.collections.notes.reset(a.notes),app.dispatcher.trigger("notesLoaded",app.collections.notes))}})}}),OsciTk.collections.Pages=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.Page,initialize:function(){}}),OsciTk.collections.SearchResults=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.SearchResult}),OsciTk.views.Page=OsciTk.views.BaseView.extend({template:OsciTk.templateManager.get("page"),className:"page",initialize:function(){this.processingData={complete:!1},this.$el.addClass("page-num-"+this.model.collection.length).attr("data-page_num",this.model.collection.length)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},processingComplete:function(){return this.processingData.complete=!0,this},addContent:function(a){return this.model.addContent(a),this},hasContent:function(a){return this.model.get("content").length?!0:!1},isPageComplete:function(){return this.processingData.complete},removeAllContent:function(){return this.model.removeAllContent(),this},containsElementId:function(a){return this.$el.find("#"+a).length!==0}}),OsciTk.views.Section=OsciTk.views.BaseView.extend({id:"section",initialize:function(){_.defaults(this.options,{pageView:"Page"}),app.dispatcher.on("currentNavigationItemChanged",function(a){a&&(app.models.section=new OsciTk.models.Section({uri:a.get("uri"),id:a.get("id")}),app.models.section.loadContent(),this.changeModel(app.models.section),this.render())},this)},render:function(){return this.preRender&&this.preRender(),this.model.removeAllPages(),this.removeAllChildViews(),app.dispatcher.trigger("layoutStart"),this.renderContent(),app.dispatcher.trigger("layoutComplete",{numPages:this.model.get("pages").length}),this},onClose:function(){this.model.removeAllPages()},getPageForParagraphId:function(a){var b=this.getChildViews(),c=_.find(b,function(b){return b.$el.find("[data-paragraph_identifier='"+a+"']").length!==0});return c!==undefined&&c!==-1?_.indexOf(b,c)+1:null},getPageForElement:function(a){var b=$(a).parents(".page");return b?b.data("page_num"):null},getPageForElementId:function(a){var b=this.getChildViews(),c=_.find(b,function(b){return b.containsElementId(a)});return c!==undefined&&c!==-1?_.indexOf(b,c)+1:null},isElementVisible:function(a){return!0},getPageForProcessing:function(a,b){var c;if(a!==undefined)c=this.getChildViewById(a);else{c=_.filter(this.getChildViews(),function(a){return a.isPageComplete()===!1});if(c.length===0){var d=this.model.get("pages");d.add({pageNumber:this.model.get("pages").length+1}),c=new OsciTk.views[this.options.pageView]({model:d.last(),pageNumber:this.model.get("pages").length}),this.addView(c,b)}else c=c.pop()}return c},getCurrentPageView:function(){return this.getChildViewByIndex(app.views.navigationView.page-1)},renderContent:function(){var a=this.getPageForProcessing();a.addContent(this.model.get("content").find("body").html()),a.render(),a.processingComplete()}}),OsciTk.views.figureTypeRegistry["default"]="MultiColumnFigure",OsciTk.views.MultiColumnFigure=OsciTk.views.BaseView.extend({tagName:"figure",template:OsciTk.templateManager.get("multi-column-figure"),initialize:function(){this.layoutComplete=!1,this.contentRendered=!1,this.sizeCalculated=!1,this.calculatedHeight=0,this.calculatedWidth=0,this.position={x:[0,0],y:[0,0]},this.$el.attr("id",this.model.get("id"))},events:{"click .figure_content":"fullscreen"},onClose:function(){app.dispatcher.off("pageChanged",this.toggleVisibility,this)},toggleVisibility:function(a){this.parent.options.pageNumber===a.page?(this.contentRendered||this.renderContent(),this.$el.css("visibility","visible")):this.$el.css("visibility","hidden")},render:function(){this.$el.html(this.template(this.model.toJSON())),this.sizeElement();var a=this.positionElement();return a&&(this.layoutComplete=!0),this.contentRendered||this.renderContent(),this},renderContent:function(){this.$el.find(".figure_content").html(this.model.get("content")),this.contentRendered=!0},fullscreen:function(){$.fancybox.open({content:this.model.get("content")})},positionElement:function(){var a=this.model.toJSON(),b=this.options.sectionDimensions;if(a.position.vertical==="n")return this.$el.hide(),!0;var c;switch(a.position.horizontal){case"r":c=b.columnsPerPage-1;break;case"l":case"p":c=0;break;default:c=this.parent.processingData.currentColumn}var d=!1,e=this.model.get("calculatedColumns"),f=0,g=0,h=e,j=0;k:while(!d&&j<=h){j++,c+e>b.columnsPerPage&&(c-=c+e-b.columnsPerPage);var l=b.columnWidth*e+(e+1)*b.gutterWidth,m=0;this.calculatedWidth<l&&(m=Math.floor((l-this.calculatedWidth)/2)),f=c*b.columnWidth+c*b.gutterWidth+m,this.$el.css("left",f+"px");switch(a.position.vertical){case"t":case"p":g=0;break;case"b":g=b.innerSectionHeight-this.calculatedHeight}this.$el.css("top",g+"px");var n=[f,f+this.calculatedWidth],o=[g,g+this.calculatedHeight];this.position={x:n,y:o},d=!0;if(f<0||n[1]>b.innerSectionWidth)d=!1;var p=this.parent.getChildViewsByType("figure"),q=p.length;if(d&&q&&q>1)for(i=0;i<q;i++){if(p[i].cid===this.cid)continue;var r=p[i].position.x,s=p[i].position.y;if(n[0]<r[1]&&n[1]>r[0]&&o[0]<s[1]&&o[1]>s[0]){d=!1;break}}if(!d)switch(a.position.horizontal){case"r":c--;if(c<0)break k;break;case"l":case"p":c++;if(c>=b.columnsPerPage)break k;break;default:c++,c>b.columnsPerPage&&(c=0)}}return d},sizeElement:function(){var a,b,c=this.options.sectionDimensions,d=this.model.toJSON();if(d.position==="n")return this.calculatedHeight=this.$el.height(),this.calculatedWidth=this.$el.width(),this;typeof d.columns=="string"&&d.columns.indexOf("%")>0&&(d.columns=Math.ceil(parseInt(d.columns,10)/100*c.columnsPerPage)),d.columns>c.columnsPerPage||d.position==="p"?(a=c.innerSectionWidth,d.columns=c.columnsPerPage):a=d.columns*c.columnWidth+c.gutterWidth*(d.columns-1),a=Math.floor(a),this.$el.css("width",a+"px");var e=this.$el.find("figcaption").outerHeight(!0);return b=a/d.aspect+e,b>c.innerSectionHeight&&(b=c.innerSectionHeight,a=(b-e)*d.aspect,this.$el.css("width",a+"px"),e=this.$el.find("figcaption").outerHeight(!0),d.columns=Math.ceil((a+c.gutterWidth)/(c.gutterWidth+c.columnWidth))),a=Math.floor(a),b=Math.floor(b),this.$el.css({height:b+"px",width:a+"px"}),this.calculatedHeight=b,this.calculatedWidth=a,this.model.set("calculatedColumns",d.columns),this.$el.find(".figure_content").css({width:a,height:b-e}),this.sizeCalculated=!0,this}}),OsciTk.views.Account=OsciTk.views.BaseView.extend({className:"account-view",template:null,initialize:function(){this.model=app.account},render:function(){this.model.get("id")>0?this.showProfile():this.showLoginForm()},events:{"click button.login":"login","click button.register":"register","click a.register":"showRegistrationForm","click a.login":"showLoginForm","click a.logout":"logout"},login:function(){var a=this,b=this.$el.find("#username").val(),c=this.$el.find("#password").val();$.ajax({url:app.config.get("endpoints").OsciTkAccount,data:{action:"login",username:b,password:c},type:"POST",dataType:"json",success:function(b){b.success===!0?(a.model.set(b.user),a.showProfile()):a.$el.find("div.form-error").html(b.error)}})},logout:function(){var a=this;$.ajax({url:app.config.get("endpoints").OsciTkAccount,data:{action:"logout"},type:"POST",dataType:"json",success:function(b){a.model.set(b.user),a.showLoginForm()}})},register:function(){var a=this,b=this.$el.find("#username").val(),c=this.$el.find("#password").val(),d=this.$el.find("#email").val();$.ajax({url:app.config.get("endpoints").OsciTkAccount,data:{action:"register",username:b,password:c,email:d},type:"POST",dataType:"json",success:function(b){b.success===!0?(a.model.set(b.user),a.showProfile()):a.$el.find("div.form-error").html(b.error)}})},showRegistrationForm:function(){this.template=OsciTk.templateManager.get("account-register"),this.$el.html(this.template())},showLoginForm:function(){this.template=OsciTk.templateManager.get("account-login"),this.$el.html(this.template())},showProfile:function(){this.template=OsciTk.templateManager.get("account-profile"),this.$el.html(this.template(this.model.toJSON()))}}),OsciTk.views.App=OsciTk.views.BaseView.extend({id:"reader",initialize:function(){$("body").append(this.el),app.views.titleView=new OsciTk.views.Title,this.addView(app.views.titleView),app.views.toolbarView=new OsciTk.views.Toolbar,this.addView(app.views.toolbarView);var a=OsciTk.views.Section;app.config.get("sectionView")&&OsciTk.views[app.config.get("sectionView")]&&(a=OsciTk.views[app.config.get("sectionView")]);var b={};app.config.get("sectionViewOptions")&&(b=app.config.get("sectionViewOptions")),app.views.sectionView=new a(b),this.addView(app.views.sectionView),app.views.navigationView=new OsciTk.views.Navigation,this.addView(app.views.navigationView),app.views.footnotesView=new OsciTk.views.Footnotes,app.views.inlineNotesView=new OsciTk.views.InlineNotes,app.views.citationView=new OsciTk.views.Citation}}),OsciTk.views.Citation=OsciTk.views.BaseView.extend({template:OsciTk.templateManager.get("citation"),initialize:function(){app.dispatcher.on("toggleCiteDialog",function(a){var b=this,c=a.contentId,d=$("#"+c),e={section_id:app.models.section.get("id"),publication_id:app.models.docPackage.get("id"),element_id:a.contentId},f=app.views.sectionView.dimensions.columnWidth,g=$(window).width(),h=f;f*1.5<g&&(h=f*1.5),d.qtip("destroy"),d.qtip({content:{title:{text:"Citation",button:"Close"},text:"Loading...",ajax:{url:app.config.get("endpoints").OsciTkCitation,data:e,success:function(a,c){a.success&&(a.citation.referenceText=d.text(),a.citation.url=document.URL+"/p-"+app.models.section.get("id")+"-"+d.data("paragraph_number"),a.citation.paragraphNumber=d.data("paragraph_number"),a.citation.date=new Date(a.citation.date),a.citation.formattedDate=a.citation.date.getMonth()+1+"/"+a.citation.date.getDate()+"/"+a.citation.date.getFullYear(),a.citation.creator=a.citation.creator?a.citation.creator:"",a.citation.description=a.citation.description?a.citation.description:"",a.citation.editor=a.citation.editor?a.citation.editor:"",a.citation.publicationTitle=a.citation.publicationTitle?a.citation.publicationTitle:"",a.citation.publisher=a.citation.publisher?a.citation.publisher:"",a.citation.rights=a.citation.rights?a.citation.rights:"",a.citation.title=a.citation.title?a.citation.title:"",this.set("content.text",b.template(a.citation)),this.elements.content.on("click","a",function(a){a.preventDefault();var b=$(this),c=b.parents(".citations");c.find(".citation").hide(),c.find(b.attr("href")).show(),c.find("li").removeClass("active"),b.parent().addClass("active")}))}}},show:{event:"",ready:!0,modal:{on:!0,dim:!1}},hide:{fixed:!0,event:"unfocus"},position:{my:"center",at:"center",target:$(document.body)},style:{classes:"citation-tooltip",def:!1,width:h+"px"},events:{hide:function(a,b){b.destroy()}}})},this)}}),OsciTk.views.Figures=OsciTk.views.BaseView.extend({className:"figures-view",template:OsciTk.templateManager.get("figures"),initialize:function(){app.collections.figures.on("add remove reset",function(){this.render()},this)},events:{"click .figure-preview":"onFigurePreviewClicked","click a.view-fullscreen":"onFigurePreviewClicked","click a.view-in-context":"onViewInContextClicked","click figure.thumbnail":"onThumbnailClick","click .back-to-grid":"backToGridClick","click .figure-nav.next":"figureNextClick","click .figure-nav.prev":"figurePrevClick"},figureNextClick:function(a){var b=this.$el.find("figure.preview.active").hide().removeClass("active").next("figure.preview");b.length===0&&(b=this.$el.find("figure.preview").first()),b.show().addClass("active"),this.displayTitle()},figurePrevClick:function(a){var b=this.$el.find("figure.preview.active").hide().removeClass("active").prev("figure.preview");b.length===0&&(b=this.$el.find("figure.preview").last()),b.show().addClass("active"),this.displayTitle()},backToGridClick:function(a){this.$el.find(".figure-previews").hide(),this.$el.find(".figure-browser").show(),this.active(),app.views.toolbarView.updateHeight()},onThumbnailClick:function(a){this.$el.find(".figure-browser").hide(),this.$el.find(".figure-previews figure.active").hide().removeClass("active");var b=this.$el.find("figure.preview[data-figure-id='"+$(a.currentTarget).attr("data-figure-id")+"']");b.show().addClass("active"),this.displayTitle(),this.$el.find(".figure-previews").show(),app.views.toolbarView.updateHeight()},onFigurePreviewClicked:function(a){var b=$(a.target).parent("figure").attr("data-figure-id"),c=app.views.figures[b];return c&&c.fullscreen&&c.fullscreen(),!1},onViewInContextClicked:function(a){return app.dispatcher.trigger("navigate",{identifier:$(a.target).parent("figure").attr("data-figure-id")}),app.views.toolbarView.contentClose(),!1},active:function(){if(app.collections.figures.length>1){var a=this.$el.find("figure.thumbnail");this.$el.find(".figure-browser .figure-reel").width(a.length*a.outerWidth(!0))}},render:function(){var a=app.collections.figures.toJSON();return this.$el.html(this.template({figures:a})),this},displayTitle:function(){var a=this.$el.find("figure.preview.active").attr("data-figure-id"),b=app.collections.figures.get(a);this.$el.find("h2 span.title").html(b.get("title"))}}),OsciTk.views.Font=OsciTk.views.BaseView.extend({className:"font-view",template:OsciTk.templateManager.get("font"),initialize:function(){this.currentFontSize=100,this.render()},render:function(){return this.$el.html(this.template()),this},events:{"click .font-button":"changeFontSize","click .theme-button":"changeTheme"},changeFontSize:function(a){a.preventDefault();var b=app.views.sectionView,c=$(a.target);c.attr("href")==="#font-larger"?this.currentFontSize+=25:this.currentFontSize-=25,b.$el.css({"font-size":this.currentFontSize+"%"}),app.dispatcher.trigger("windowResized")},changeTheme:function(a){a.preventDefault();var b=$(a.target),c=b.attr("href").substr(1),d=$("body");d.removeClass("normal sepia night"),d.addClass(c)}}),OsciTk.views.Footnotes=OsciTk.views.BaseView.extend({id:"footnote",initialize:function(){app.dispatcher.on("layoutComplete",function(a){var b=app.views.sectionView.$el.find("a.footnote-reference");_.each(b,function(a){a=$(a);var b=a.attr("href").slice(1),c=app.collections.footnotes.get(b);c&&a.qtip({content:c.get("body"),style:{def:!1}})})},this)}}),OsciTk.views.InlineNotes=OsciTk.views.BaseView.extend({template:OsciTk.templateManager.get("note-popup"),initialize:function(){app.dispatcher.on("toggleNoteDialog",function(a){var b=this,c=a.contentId,d=$("#"+c);if(c){var e,f=app.collections.notes.where({content_id:c});f[0]?e=f[0]:(e=new OsciTk.models.Note({content_id:c,section_id:app.models.section.id}),app.collections.notes.add(e));var g=e.toJSON();g.referenceContent=d.text(),d.qtip("destroy"),d.qtip({id:e.cid,content:{title:{text:"Notes",button:"Save & Close"},text:b.template(g)},show:{ready:!0,event:"",modal:{on:!0,dim:!1}},hide:{event:"unfocus",fixed:!0},position:{my:"center",at:"center",target:$(document.body)},style:{classes:"note-tooltip",def:!1,width:app.views.sectionView.dimensions.columnWidth+"px"},events:{render:function(a,c){c.elements.content.find(".noteForm textarea").on("keyup",function(a){c.elements.content.find(".status").text("Saving...");var d=c.elements.tooltip.attr("id").match(/c\d+/)[0],e=app.collections.notes.getByCid(d);e.set("note",a.target.value),typeof b["saveTimeout"+d]!="undefined"&&(clearTimeout(b["saveTimeout"+d]),delete b["saveTimeout"+d]),b["saveTimeout"+d]=window.setTimeout(function(){e.save(),c.elements.content.find(".status").text("Saved")},1500)})},hide:function(a,b){var d=b.elements.content.find("textarea").val();if(d.length>0){var e=app.views.sectionView.getCurrentPageView(),f=e.$el.find(".paragraph-controls[data-osci_content_id="+c+"]");f.addClass("notes-present")}}}})}},this),app.dispatcher.on("notesLoaded",function(a){_.each(app.collections.notes.models,function(a){var b=app.views.sectionView.$el.find(".paragraph-controls[data-osci_content_id="+a.get("content_id")+"]");b.length&&b.addClass("notes-present")})},this)}}),OsciTk.views.figureTypeRegistry.image_asset="MultiColumnFigureImage",OsciTk.views.MultiColumnFigureImage=OsciTk.views.MultiColumnFigure.extend({renderContent:function(){var a=this.$el.find(".figure_content"),b=a.height(),c=a.width();a.html(this.model.get("content")),a.children("img").css({height:b+"px",width:c+"px"}),this.contentRendered=!0},fullscreen:function(){$.fancybox.open({href:$(this.model.get("content")).attr("src")})}}),OsciTk.views.figureTypeRegistry.layered_image="MultiColumnFigureLayeredImage",OsciTk.views.MultiColumnFigureLayeredImage=OsciTk.views.MultiColumnFigure.extend({events:{},renderContent:function(){this.figContent=this.figContent||null;var a=this.$el.find(".figure_content"),b=a.height(),c=a.width();this.jsonOptions=JSON.stringify(this.model.get("options")),this.$el.attr("data-options",this.jsonOptions);if(this.figContent!==null)this.renderFromContentDoc();else{var d=$(this.model.get("content")),e=d.attr("data");if(e!==undefined){var f=this;$.ajax({url:e,type:"GET",dataType:"html",success:function(a){f.figContent=$(a).filter(".layered_image-asset").first(),f.LIMarkup=f.figContent.clone(),f.renderFromContentDoc()}})}}},renderFromContentDoc:function(){var a=this.$el.find(".figure_content");a.empty(),a.html(this.figContent),new window.LayeredImage(a.find(".layered_image-asset")[0]),this.contentRendered=!0},fullscreen:function(){var a=liCollection.find(this.LIMarkup.attr("id"));a.fullscreen()}}),OsciTk.views.MultiColumnPage=OsciTk.views.Page.extend({initialize:function(){this.columnTemplate=OsciTk.templateManager.get("multi-column-column"),this.visible=!1,this.paragraphControlsViews=[],OsciTk.views.MultiColumnPage.__super__.initialize.call(this)},onClose:function(){this.model=undefined},events:{"click a.figure_reference":"onFigureReferenceClicked"},onFigureReferenceClicked:function(a){var b=a.currentTarget.hash.substring(1),c=app.views.figures[b];return c&&c.fullscreen&&c.fullscreen(),!1},hide:function(){this.$el.css("visibility","hidden"),this.visible=!1},show:function(){this.$el.css("visibility","visible"),this.visible=!0},resetPage:function(){this.removeAllContent();for(var a=0,b=this.paragraphControlsViews.length;a<b;a++)this.removeView(this.paragraphControlsViews[a]);this.paragraphControlsViews=[],this.$el.children(":not(figure)").remove(),this.initializeColumns()},render:function(){return this.processingData.rendered?this:(this.hide(),this.$el.css({width:this.parent.dimensions.innerSectionWidth,height:this.parent.dimensions.innerSectionHeight}),this.initializeColumns(),this.processingData.rendered=!0,this)},layoutContent:function(){var a="none",b=this.getCurrentColumn();if(b===null)return this.processingComplete(),a="contentOverflow",a;var c=$(this.model.get("content")[this.model.get("content").length-1]);b.$el.append(c);var d=parseFloat(c.css("line-height")),e=c.position();if(b.height-e.top<d)return c.remove(),b.heightRemain=0,a="contentOverflow",a;var f=c.outerHeight(!0),g=0;b.offset<0&&(g=f+b.offset,c.css("margin-top","-"+g+"px"),b.offset=0);var h={top:parseInt(c.css("margin-top"),10),bottom:parseInt(c.css("margin-bottom"),10)},i=b.heightRemain-c.outerHeight(!0);i>0&&i<d?i=0:i<0&&i>=h.bottom*-1&&(i=0);if(i<0){var j=i,k=Math.floor(j/d),l=e.top+c.outerHeight()+k*d;b.height=l,b.$el.height(l+"px"),k===0?(i=0,a="none"):(i=k*d-h.bottom,a="contentOverflow"),this.processingData.currentColumn===this.parent.dimensions.columnsPerPage-1&&this.processingComplete();if(b.height-e.top<d)return c.remove(),b.heightRemain=0,a="contentOverflow",a}i===0&&this.processingData.currentColumn===this.parent.dimensions.columnsPerPage-1&&this.processingComplete(),b.heightRemain=i;if(c.is("p")){var m=c.data("paragraph_number"),n=c.data("osci_content_id"),o=this.$el.find(".paragraph-identifier-"+m);if(o.length===0){var p=b.$el.position(),q=new OsciTk.views.ParagraphControlsView({content:c,position:{top:p.top+e.top+"px",left:p.left+e.left-this.parent.dimensions.gutterWidth+"px"}});this.addView(q),this.paragraphControlsViews.push(q)}}return a},getCurrentColumn:function(){var a=null,b=parseInt(this.$el.css("line-height"),10);b=b?b:this.parent.options.defaultLineHeight;var c=b*this.parent.dimensions.minLinesPerColumn;if(this.processingData.columns[this.processingData.currentColumn]&&this.processingData.columns[this.processingData.currentColumn].height>=c&&this.processingData.columns[this.processingData.currentColumn].heightRemain>0)a=this.processingData.columns[this.processingData.currentColumn];else for(var d=0;d<this.parent.dimensions.columnsPerPage;d++)if(this.processingData.columns[d].height>=c&&this.processingData.columns[d].heightRemain>0){a=this.processingData.columns[d],this.processingData.currentColumn=d;break}if(a!==null&&a.$el===null){if(this.processingData.currentColumn>0)a.offset=this.processingData.columns[this.processingData.currentColumn-1].heightRemain;else{var e=this.parent.getChildViewByIndex(this.parent.getChildViews().length-2);e&&(a.offset=e.processingData.columns[e.processingData.columns.length-1].heightRemain)}var f={width:this.parent.dimensions.columnWidth+"px",height:a.height+"px",left:this.processingData.columns[this.processingData.currentColumn].position.left,top:this.processingData.columns[this.processingData.currentColumn].position.top};a.$el=$(this.columnTemplate()).appendTo(this.$el).addClass("column-"+this.processingData.currentColumn).css(f)}return a},initializeColumns:function(){this.processingData.columns=[];var a=this.getChildViewsByType("figure"),b=a.length;for(var c=0;c<this.parent.dimensions.columnsPerPage;c++){var d=c*this.parent.dimensions.columnWidth+this.parent.dimensions.gutterWidth*(c+1),e=this.parent.dimensions.innerSectionHeight,f=0,g={x:[d,d+this.parent.dimensions.columnWidth],y:[f,f+e]};if(b)for(var h=0;h<b;h++){var i=a[h].position.x,j=a[h].position.y;if(g.x[0]<i[1]&&g.x[1]>i[0]&&g.y[0]<j[1]&&g.y[1]>j[0]){e=e-a[h].calculatedHeight-this.parent.dimensions.gutterWidth;switch(a[h].model.get("position").vertical){case"t":case"p":f=f+a[h].calculatedHeight+this.parent.dimensions.gutterWidth;break;case"b":f=f}g.y=[f,f+e]}}e=Math.floor(e),this.processingData.columns[c]={height:e,heightRemain:e>0?e:0,$el:null,offset:0,position:{left:g.x[0],top:g.y[0]}}}this.processingData.currentColumn=0},addFigure:function(a){var b=!1;return this.addView(a),a.layoutComplete||(a.render(),a.layoutComplete?b=!0:(b=!1,this.removeView(a,!1))),b}}),OsciTk.views.MultiColumnSection=OsciTk.views.Section.extend({template:OsciTk.templateManager.get("multi-column-section"),initialize:function(){this.options.pageView="MultiColumnPage",app.dispatcher.on("windowResized",function(){var a,b=this.getChildViewByIndex(app.views.navigationView.page-1),c=b.$el.find("[id]:first");c.length&&(a=c.attr("id")),a&&(app.views.navigationView.identifier=a),this.render()},this),app.dispatcher.on("navigate",function(a){var b=1;if(a.page)b=a.page;else if(a.identifier)switch(a.identifier){case"end":b=this.model.get("pages").length;break;case"start":b=1;break;default:var c=null;if(a.identifier.search(/^p-[0-9]+/)>-1){var d=a.identifier.slice(a.identifier.lastIndexOf("-")+1,a.identifier.length);c=this.getPageForParagraphId(d)}else if(a.identifier.search(/^fig-[0-9]+-[0-9]+-[0-9]+/)>-1){var e=a.identifier.match(/^(fig-[0-9]+-[0-9]+)-([0-9])+?/),f=e[1],g=e[2]?parseInt(e[2],10):1,h=$(".figure_reference").filter("[href='#"+f+"']");if(h.length)if(h.length===1)c=this.getPageForElement(h[0]);else{var i=0;for(var j=0,k=h.length;j<k;j++)if(this.isElementVisible(h[j])){i++;if(i===g){c=this.getPageForElement(h[j]);break}}}}else c=this.getPageForElementId(a.identifier);c!==null?b=c:(b=1,console.log("Navigation error: ",a.identifier,"not found in any page"))}this.getChildViewByIndex(b-1).show();var l=(b-1)*this.dimensions.innerSectionHeight*-1,m=this.getChildViews(),n=m.length;for(var o=0;o<n;o++)o!==b-1&&m[o].hide();this.$el.find("#pages").css({"-webkit-transform":"translate3d(0, "+l+"px, 0)","-moz-transform":"translate3d(0, "+l+"px, 0)",transform:"translate3d(0, "+l+"px, 0)"}),app.dispatcher.trigger("pageChanged",{page:b})},this),this.$el.addClass("oscitk_multi_column"),_.defaults(this.options,{minColumnWidth:200,maxColumnWidth:300,gutterWidth:40,minLinesPerColumn:5,defaultLineHeight:16}),this.dimensions={},OsciTk.views.MultiColumnSection.__super__.initialize.call(this)},isElementVisible:function(a){var b=$(a),c=b.parents(".column"),d=null,e=!0;c.length?d=c:d=b.parents(".page");if(d.length){var f=b.position();if(f.top<0||f.top>d.height())e=!1}return e},preRender:function(){app.views.figures={}},renderContent:function(){this.$el.html(this.template()),this.calculateDimensions(),this.layoutData={data:this.model.get("content"),items:null},this.cleanData(),this.unplacedFigures=[],this.layoutData.items=this.layoutData.data.length;var a=0,b=!0,c=1,d=0,e=0;while(this.layoutData.items>0){var f=this.getPageForProcessing(undefined,"#pages"),g=null,h=[];f.processingData.rendered||(e=0,d=0,f.render(),h=h.concat(this.unplacedFigures));var i=$(this.layoutData.data[a]).clone(),j=i.find("a.figure_reference"),k=j.length,l=i.find("figure"),m=l.length;if(i.is("figure")||k||m||h.length){var n;i.is("figure")&&h.push(i.attr("id"));if(k)for(n=0;n<k;n++)h.push($(j[n]).attr("href").substring(1));if(m)for(n=0;n<m;n++){var o=$(l[n]).remove();h.push(o.attr("id"))}var p=h.length;for(n=0;n<p;n++){var q=app.collections.figures.get(h[n]),r=q.get("type"),s=OsciTk.views.figureTypeRegistry[r]?OsciTk.views.figureTypeRegistry[r]:OsciTk.views.figureTypeRegistry["default"],t=this.getFigureView(q.get("id"));t||(app.views.figures[h[n]]=t=new OsciTk.views[s]({model:q,sectionDimensions:this.dimensions}));if(!t.layoutComplete){if(f.addFigure(t)){g="figurePlaced";var u=_.indexOf(this.unplacedFigures,h[n]);u>-1&&this.unplacedFigures.splice(u,1);break}_.indexOf(this.unplacedFigures,h[n])===-1&&this.unplacedFigures.push(h[n]),i.is("figure")&&(g="next")}else i.is("figure")&&(g="next")}}g===null&&(b&&i.attr("id","osci-content-"+a),i.attr("data-osci_content_id","osci-content-"+a),i.is("p")&&i.attr("data-paragraph_number",c),g=f.addContent(i).layoutContent());switch(g){case"contentOverflow":b=!1;break;case"figurePlaced":f.resetPage(),c-=d,d=0,this.layoutData.items+=e,a-=e,e=0;break;default:a++,this.layoutData.items--,e++,i.is("p")&&(c++,d++),b=!0}}},calculateDimensions:function(){var a=this.dimensions,b=$(window).width(),c=$(window).height();b<300&&(b=300),c<300&&(c=300);if(a.windowWidth&&a.windowWidth===b&&a.windowHeight&&a.windowHeight===c)return;a.windowHeight=c,a.windowWidth=b,a.gutterWidth=this.options.gutterWidth,a.minLinesPerColumn=this.options.minLinesPerColumn,a.sectionMargin={left:parseInt(this.$el.css("margin-left"),10),top:parseInt(this.$el.css("margin-top"),10),right:parseInt(this.$el.css("margin-right"),10),bottom:parseInt(this.$el.css("margin-bottom"),10)},a.sectionPadding={left:parseInt(this.$el.css("padding-left"),10),top:parseInt(this.$el.css("padding-top"),10),right:parseInt(this.$el.css("padding-right"),10),bottom:parseInt(this.$el.css("padding-bottom"),10)},a.outerSectionHeight=c-a.sectionMargin.top-a.sectionMargin.bottom,a.innerSectionHeight=a.outerSectionHeight-a.sectionPadding.top-a.sectionPadding.bottom,a.outerSectionWidth=this.$el.outerWidth(),a.innerSectionWidth=a.outerSectionWidth-a.sectionPadding.left-a.sectionPadding.right,a.innerSectionWidth<this.options.maxColumnWidth?a.columnWidth=a.innerSectionWidth:a.columnWidth=this.options.maxColumnWidth,a.columnsPerPage=Math.floor(a.innerSectionWidth/a.columnWidth),a.innerSectionWidth<a.columnsPerPage*a.columnWidth+a.columnsPerPage*this.options.gutterWidth&&(a.columnsPerPage=a.columnsPerPage-1),a.columnsPerPage===0&&(a.columnsPerPage=1,a.columnWidth=a.innerSectionWidth-this.options.gutterWidth);var d=(a.innerSectionWidth-a.columnsPerPage*a.columnWidth)/a.columnsPerPage;d>this.options.gutterWidth&&(a.columnWidth=(a.innerSectionWidth-this.options.gutterWidth*a.columnsPerPage)/a.columnsPerPage),a.columnWidth=Math.floor(a.columnWidth),this.dimensions=a},cleanData:function(){this.layoutData.data.find("#figures").remove(),this.layoutData.data.find("#footnotes").remove(),this.layoutData.data=this.layoutData.data.find("section").children()},getFigureView:function(a){if(app.views.figures[a])return app.views.figures[a]}}),OsciTk.views.Navigation=OsciTk.views.BaseView.extend({id:"navigation",template:OsciTk.templateManager.get("navigation"),initialize:function(){this.numPages=null,this.identifier=null,this.currentNavigationItem=null,this.page=null,app.dispatcher.on("layoutComplete",function(a){this.identifier?(app.dispatcher.trigger("navigate",{identifier:this.identifier}),this.identifier=null):app.dispatcher.trigger("navigate",{page:1}),this.numPages=a.numPages,this.render()},this),app.dispatcher.on("pageChanged",function(a){this.page=a.page,this.update(a.page)},this),app.dispatcher.on("routedToSection",function(a){this.identifier=a.identifier;if(!a.section_id){var b=app.collections.navigationItems.at(0).id;this.setCurrentNavigationItem(b),app.router.navigate("section/"+b,{trigger:!1})}else this.setCurrentNavigationItem(a.section_id);var c=app.models.docPackage.getTitle();c=c?c+" | ":"",c+=this.getCurrentNavigationItem().get("title"),document.title=c},this),$(document).keydown(function(a){var b;switch(a.which){case 39:b=app.views.navigationView.page+1;if(b>app.views.navigationView.numPages){var c=app.views.navigationView.currentNavigationItem.get("next");c&&app.router.navigate("section/"+c.id,{trigger:!0})}else app.dispatcher.trigger("navigate",{page:b});break;case 37:b=app.views.navigationView.page-1;if(b<1){var d=app.views.navigationView.currentNavigationItem.get("previous");d&&app.router.navigate("section/"+d.id+"/end",{trigger:!0})}else app.dispatcher.trigger("navigate",{page:b})}})},render:function(){this.$el.html(this.template({numPages:this.numPages,chapter:this.currentNavigationItem.get("title")})),this.numPages==1?$(".pager").hide():$(".pager").show();var a=100/this.numPages;$(".pager .head",this.$el).css("width",a+"%"),$(".pager").mousedown(function(a){var b=parseInt(app.views.navigationView.numPages*a.offsetX/$(this).width(),10);app.dispatcher.trigger("navigate",{page:b+1})}),this.update(this.page)},getCurrentNavigationItem:function(){return this.currentNavigationItem},setCurrentNavigationItem:function(a){this.currentNavigationItem=app.collections.navigationItems.get(a),app.dispatcher.trigger("currentNavigationItemChanged",this.currentNavigationItem)},update:function(a){var b=100/this.numPages;$(".pager .head",this.$el).css("left",b*(a-1)+"%"),this.$el.find(".prev-page").unbind("click"),this.$el.find(".next-page").unbind("click");if(a==1){var c=this.currentNavigationItem.get("previous");c?(this.$el.find(".prev-page .label").html("Previous Section"),this.$el.find(".prev-page").removeClass("inactive").click(function(){app.router.navigate("section/"+c.id+"/end",{trigger:!0})})):$(".prev-page",this.$el).addClass("inactive").unbind("click")}else if(this.numPages>1){var d=this;this.$el.find(".prev-page .label").html("Previous"),this.$el.find(".prev-page").removeClass("inactive").click(function(){app.router.navigate("section/"+d.currentNavigationItem.id),app.dispatcher.trigger("navigate",{page:a-1})})}if(a==this.numPages){var e=this.currentNavigationItem.get("next");e?(this.$el.find(".next-page .label").html("Next Section"),this.$el.find(".next-page").removeClass("inactive").click(function(){app.router.navigate("section/"+e.id,{trigger:!0})})):this.$el.find(".next-page").addClass("inactive").unbind("click")}else this.numPages>1&&(this.$el.find(".next-page .label").html("Next"),this.$el.find(".next-page").removeClass("inactive").click(function(){app.dispatcher.trigger("navigate",{page:a+1})}))}}),OsciTk.views.Notes=OsciTk.views.BaseView.extend({className:"notes-view",template:OsciTk.templateManager.get("notes"),initialize:function(){app.collections.notes.on("add remove change",function(){this.render()},this),app.dispatcher.on("pageChanged notesLoaded",function(a){var b;typeof a.page=="undefined"?b=app.views.navigationView.page:b=a.page,pageView=app.views.sectionView.getChildViewByIndex(b-1),_.each(app.collections.notes.models,function(a){a.set("onCurrentPage",!1);var b=pageView.$el.find("#"+a.get("content_id"));b.length>0&&a.set("onCurrentPage",!0)}),this.render()},this)},events:{"click .noteLink":"noteLinkClick"},noteLinkClick:function(a){a.preventDefault();var b=$(a.target),c=b.attr("data-content_id");c&&(app.dispatcher.trigger("navigate",{identifier:c}),app.dispatcher.trigger("toggleNoteDialog",{contentId:c}),$("#"+c).click(),app.views.toolbarView.contentClose())},render:function(){var a=this.getSavedNotes();return this.$el.html(this.template({notes:a})),this.active(),this},getSavedNotes:function(){var a=_.filter(app.collections.notes.models,function(a){return a.id!==null?!0:!1});return a},active:function(){if(app.collections.notes.length>1){var a=this.$el.find(".notesListItem");this.$el.find(".notesList").width(a.length*a.first().outerWidth(!0))}}}),OsciTk.views.ParagraphControlsView=OsciTk.views.BaseView.extend({className:"paragraph-controls",initialize:function(){this.options.paragraphNumber=this.options.content.data("paragraph_number"),this.options.contentIdentifier=this.options.content.data("osci_content_id"),this.options.linkItems=app.config.get("paragraphControls"),this.options.linkItems&&this.render()},render:function(){var a=this.options.content.position();this.$el.attr("data-osci_content_id",this.options.contentIdentifier),this.$el.attr("data-paragraph_identifier",this.options.paragraphNumber),this.$el.html('<span class="paragraph-identifier paragraph-identifier-'+this.options.paragraphNumber+'">'+this.options.paragraphNumber+"</span>"),this.$el.css(this.options.position),this.$el.data("qtip")&&this.$el.qtip("destroy");var b="";for(var c in this.options.linkItems){var d=this.options.linkItems[c];b+='<a href="'+c+'" data-event="'+c+'" class="'+c+'">'+d+"</a> "}return this.$el.qtip({position:{my:"left center",at:"right center",target:this.$el,container:this.$el,adjust:{y:-10}},show:{ready:!1,solo:!0},hide:{fixed:!0,delay:500},style:{def:!1},overwrite:!1,content:b}),this.$el.on("click","a",{content:this.options.content},function(a){a.preventDefault(),app.dispatcher.trigger($(this).data("event"),{contentId:$(a.data.content).attr("data-osci_content_id")})}),this}}),OsciTk.views.SearchResults=OsciTk.views.BaseView.extend({id:"search-results-container",template:OsciTk.templateManager.get("search-results"),initialize:function(a){console.log(a),this.searchResults=new OsciTk.collections.SearchResults({docs:a.docs}),this.render()},render:function(){this.$el.html(this.template())}}),OsciTk.views.SearchResult=OsciTk.views.BaseView.extend({id:"search-results-container",template:OsciTk.templateManager.get("search-result"),initialize:function(a){this.render()},render:function(){this.$el.html(this.template())}}),OsciTk.views.Search=OsciTk.views.BaseView.extend({id:"search-view",className:"toolbar-item-view",template:OsciTk.templateManager.get("search"),initialize:function(){this.query={page:0,keyword:null,filters:[],sort:null},this.response={numFound:0,docs:new OsciTk.collections.SearchResults,facets:null},this.results=null,this.hasSearched=!1,this.isLoading=!1,this.resultsTemplate=OsciTk.templateManager.get("search-results")},events:{"submit #search-form":"submitSearch","click .search-result":"gotoResult","click .facet":"addFacet","click .filter":"addFilter","click #reset-search":"resetSearch"},render:function(){this.$el.html(this.template(this))},renderResults:function(){this.prepareResults(),this.$el.find("#search-results-wrapper").html(this.resultsTemplate(this))},resizeResultsContainer:function(){var a=$("#toolbar-content").height(),b=this.$el.find("#search-header").outerHeight(),c=this.$el.find("#search-results-header").outerHeight(),d=a-b-c;this.$el.find("#search-results-container").height(d)},search:function(){var a=this;this.query.keyword=this.$el.find("#search-keyword").val(),this.response.docs.reset(),this.hasSearched=!0;var b={key:this.query.keyword,group:"true",page:this.query.page};this.query.filters.length&&(b.filters=this.query.filters.join(" ")),$.ajax({url:app.config.get("endpoints").OsciTkSearch,data:b,success:function(b){b=JSON.parse(b);if(b.numFound===0)return;a.response.docs.reset(b.docs),a.response.facets=b.facets,a.response.numFound=b.numFound,a.renderResults(),app.views.toolbarView.contentOpen(),a.resizeResultsContainer()},error:function(){}})},prepareResults:function(){this.results=_.groupBy(this.response.docs.models,function(a){return a.get("ss_section_id")})},gotoResult:function(a){var b=$(a.currentTarget),c=this.response.docs.get(b.data("id"));app.router.navigate("section/"+c.get("ss_section_id")+"/"+c.get("id"),{trigger:!0}),app.views.toolbarView.contentClose()},addFilter:function(a){a.preventDefault();var b=$(a.currentTarget).data("filter"),c=_.indexOf(this.query.filters,b);this.$el.find(".filter").removeClass("active"),this.query.filters=_.reject(this.query.filters,function(a){return a.indexOf("type:")===0}),c===-1&&(this.query.filters.push(b),$(a.currentTarget).addClass("active")),this.hasSearched&&this.search()},addFacet:function(a){a.preventDefault();var b=$(a.currentTarget).data("filter");this.query.filters.push(b),this.hasSearched&&this.search()},submitSearch:function(a){a.preventDefault(),this.search()},resetSearch:function(a){a.preventDefault(),a.stopPropagation(),this.initialize(),this.$el.find("#search-results-header").remove(),this.$el.find("#search-results-container").remove(),this.$el.find("#search-keyword").val(""),app.views.toolbarView.contentOpen(),this.resizeResultsContainer()}}),OsciTk.views.Title=OsciTk.views.BaseView.extend({className:"title-view",template:OsciTk.templateManager.get("title"),initialize:function(){app.dispatcher.on("packageLoaded",function(a){var b=a.getTitle();b&&this.$el.find("#publication-title").text(b)},this),this.render()},render:function(){return this.$el.html(this.template()),this},events:{"click #publication-title":function(a){a.preventDefault(),app.dispatcher.trigger("navigate",{identifier:"start"})}}}),OsciTk.views.Toc=OsciTk.views.BaseView.extend({className:"toc-view",template:OsciTk.templateManager.get("toc"),events:{"click li a":"itemClick"},initialize:function(){this.parent=this.options.parent,app.dispatcher.on("currentNavigationItemChanged",function(){this.render()},this)},render:function(){this.$el.html(this.template({items:app.collections.navigationItems.where({depth:0})}))},itemClick:function(a){a.preventDefault();var b=$(a.currentTarget).attr("data-section-id");app.router.navigate("section/"+b,{trigger:!0}),app.views.toolbarView.contentClose()},active:function(){var a=$("#toolbar-content").height(),b=this.$el.find("h3").outerHeight(),c=a-b;this.$el.find("ul").height(c)}}),OsciTk.views.ToolbarItem=OsciTk.views.BaseView.extend({className:"toolbar-item",template:OsciTk.templateManager.get("toolbar-item"),initialize:function(){this.$el.addClass(this.options.toolbarItem.view+"-toolbar-item"),this.contentView=null,this.contentViewRendered=!1},events:{click:"itemClicked",touch:"itemClicked"},onClose:function(){this.contentView.close()},render:function(){this.contentView=new OsciTk.views[this.options.toolbarItem.view]({parent:this}),this.$el.html(this.template({text:this.options.toolbarItem.text}))},itemClicked:function(a){a.preventDefault(),a.stopPropagation(),this.contentViewRendered||(this.contentView.render(),this.contentViewRendered=!0),this.parent.setActiveToolbarItemView(this),this.parent.toggleContentView(),this.contentView.active&&this.contentView.active()}}),OsciTk.views.Toolbar=OsciTk.views.BaseView.extend({id:"toolbar",template:OsciTk.templateManager.get("toolbar"),initialize:function(){this.toolbarItems=app.config.get("toolbarItems")?app.config.get("toolbarItems"):[],this.isContentOpen=!1,this.activeToolbarItemView=undefined,this.activeToolbarItemViewChanged=!1,this.render(),app.dispatcher.on("packageLoaded",function(a){var b=a.getTitle();b&&this.$el.find("#toolbar-title").text(b)},this),$(window).on("click",{view:this},function(a){var b=$(a.target).parents("#"+a.data.view.id);a.data.view.isContentOpen&&b.length===0&&a.data.view.contentClose()})},events:{"click #toolbar-close":"contentClose"},render:function(){this.$el.html(this.template()),_.each(this.toolbarItems,function(a){var b=new OsciTk.views.ToolbarItem({toolbarItem:a});this.addView(b,"#toolbar-handle"),b.render()},this)},setActiveToolbarItemView:function(a){return this.activeToolbarItemView&&a.cid!==this.activeToolbarItemView.cid||this.activeToolbarItemView===undefined?(this.activeToolbarItemViewChanged=!0,this.activeToolbarItemView&&this.activeToolbarItemView.contentView.$el.detach()):this.activeToolbarItemViewChanged=!1,this.activeToolbarItemView=a,this.$el.find("#toolbar-content").html(a.contentView.$el),a.contentView.delegateEvents(),this},toggleContentView:function(){return this.isContentOpen?this.activeToolbarItemViewChanged?(this.updateHeight(),this):(this.contentClose(),this):(this.contentOpen(),this)},contentOpen:function(){this.updateHeight(),this.isContentOpen=!0},updateHeight:function(){var a=this.$el.find("#toolbar-content"),b=this.$el.height();a.height("");var c=a.height(),d=$("#toolbar-title-container").outerHeight();c>b-d?a.height(b-d+"px"):a.height(""),this.$el.css({top:0})},contentClose:function(){this.$el.css({top:"-"+this.$el.height()+"px"}),this.isContentOpen=!1}});var $=jQuery,LICollection=function(){var a=[];this.add=function(b){var c,d;for(c=0,d=a.length;c<d;c++)if(a[c].id==b.id)return!1;return a.push(b),!0},this.remove=function(b){var c,d;typeof b=="string"&&(b={id:b});for(c=0,d=a.length;c<d;c++)a[c].id==b.id&&a.splice(c,1)},this.find=function(b){var c,d;for(c=0,d=a.length;c<d;c++)if(a[c].id==b)return a[c];return!1},this.list=function(){return a},this.userIsDraggingAsset=!1},LayeredImage=function(a){var b,c,d;if(jQuery===undefined)return!1;var e=this.$=jQuery;if(org.polymaps!==undefined)this.polymaps=org.polymaps;else return!1;this.container=e(a);if(this.container.length<1)return!1;if(!window.liCollection.add(this))return;this.id=this.container.attr("id"),this.settings=this.container.data(),this.settings.zoomStep=this.settings.zoomStep||.1,this.settings.annotationSelectorVisible=!1,this.settings.dragging=undefined;var f=this.container.parents("figure:first"),g=f.attr("data-options");f.length>0&&g&&(this.figureOptions=JSON.parse(g)),this.figureOptions||(this.figureOptions={disable_interaction:!1,disable_annotation:!1,sliderPosition:0}),this.figureOptions.sliderPosition||(this.figureOptions.sliderPosition=0),this.settings.captionMarkup=this.container.parents("figure:first").find("figcaption").clone(),this.settings.originalMarkup=outerHTML(this.container[0]),this.layers=[];var h=this.container.find(".layered_image-layers"),i=h.find("li");for(b=0,c=i.length;b<c;b++){var j=e(i[b]);this.layers.push(j.data())}h.remove(),this.layers.sort(function(a,b){var c=a.annotation,d=b.annotation;return c==d?0:c&&!d?1:!c&&d?-1:0}),this.baseLayers=[],this.annotationLayers=[];for(b=0,c=this.layers.length;b<c;b++)d=this.layers[b],d.layer_num=b+1,d.annotation?this.annotationLayers.push(d):this.baseLayers.push(d);this.map=this.polymaps.map(),this.map.container(this.container[0].appendChild(this.polymaps.svg("svg"))),this.map.tileSize({x:256,y:256});for(b=0,c=this.layers.length;b<c;b++)d=this.layers[b],d.zoom_levels||(d.zoom_levels=this.getZoomLevels(d.width,d.height));var k=this.figureOptions.baseLayerPreset?this.figureOptions.baseLayerPreset:[],l=k.length,m=!1;if(l>0){var n=this.getLayerById(k[0]),o;l>1&&(o=this.getLayerById(k[1])),n&&(o||l==1)&&(this.createLayer(n),o&&(this.createLayer(o),e("#"+o.id).css("opacity",0)),m=!0)}!m&&this.baseLayers.length&&(this.createLayer(this.baseLayers[0]),this.baseLayers[1]&&(this.createLayer(this.baseLayers[1]),e("#"+this.baseLayers[1].id).css("opacity",0))),this.createUI(),this.showAnnotationPresets(),this.zoomToContainer();var p=[];this.figureOptions.fullscreenExtents?(p=[{lon:this.figureOptions.fullscreenExtents.swLon,lat:this.figureOptions.fullscreenExtents.swLat},{lon:this.figureOptions.fullscreenExtents.neLon,lat:this.figureOptions.fullscreenExtents.neLat}],this.setExtents(p)):this.figureOptions.swLat&&(p=[{lon:this.figureOptions.swLon,lat:this.figureOptions.swLat},{lon:this.figureOptions.neLon,lat:this.figureOptions.neLat}],this.setExtents(p))};LayeredImage.prototype.createLayer=function(a){var b=this.$,c;if(a===undefined)return;a.zoom_levels||(a.zoom_levels=this.getZoomLevels(a.width,a.height)),a.type=="image"&&(c=this.createLayerImage(a)),a.type=="iip"&&(c=this.createLayerIIP(a)),a.type=="svg"&&(c=this.createLayerSVG(a)),a.visible=!0,a.polymapLayer=c,c.id(a.id),this.map.add(c)},LayeredImage.prototype.removeLayer=function(a){a.polymapLayer&&this.map.remove(a.polymapLayer),a.polymapLayer=undefined,a.visible=!1},LayeredImage.prototype.toggleLayer=function(a){a.visible?this.removeLayer(a):this.createLayer(a)},LayeredImage.prototype.repaintLayer=function(a){this.removeLayer(a),this.createLayer(a)},LayeredImage.prototype.createLayerIIP=function(a){var b=this,c=this.polymaps.image(),d=function(c){var d=a.ptiff_server,e=a.ptiff_path,f=a.height,g=a.width,h=256,i=b.getScale(a.zoom_levels-1,c.zoom),j=Math.round(g/i),k=Math.round(f/i),l=Math.ceil(j/h),m=Math.ceil(k/h);if(c.row<0||c.row>=m||c.column<0||c.column>=l)return null;c.row==m-1&&c.element.setAttribute("height",k%h),c.column==l-1&&c.element.setAttribute("width",j%h);var n=d+"?fif="+e+"&jtl="+c.zoom+","+(c.row*l+c.column);return n};return c.url(d),c},LayeredImage.prototype.createLayerImage=function(a){var b=this,c=function(c){var d=b.getScale(a.zoom_levels,c.zoom);c.element=b.polymaps.svg("image"),c.element.setAttribute("preserveAspectRatio","none"),c.element.setAttribute("x",0),c.element.setAttribute("y",0),c.element.setAttribute("width",a.width/d),c.element.setAttribute("height",a.height/d),c.element.setAttributeNS("http://www.w3.org/1999/xlink","href",a.image_path),c.ready=!0},d=function(a){a.request&&a.request.abort(!0)},e=this.polymaps.layer(c,d).tile(!1);return e},LayeredImage.prototype.createLayerSVG=function(a){var b=this,c=function(c){var d=b.getScale(a.zoom_levels,c.zoom);c.element=b.polymaps.svg("image"),c.element.setAttribute("preserveAspectRatio","none"),c.element.setAttribute("x",0),c.element.setAttribute("y",0),c.element.setAttribute("width",a.width/d),c.element.setAttribute("height",a.height/d),c.element.setAttributeNS("http://www.w3.org/1999/xlink","href",a.svg_path),c.ready=!0},d=function(a){a.request&&a.request.abort(!0)},e=this.polymaps.layer(c,d).tile(!1);return e},LayeredImage.prototype.zoomToContainer=function(){var a=18,b,c;for(b=0,c=this.layers.length;b<c;b++){var d=this.layers[b],e=this.getScale(d.zoom_levels-0,a);d.type=="iip"&&(e=this.getScale(d.zoom_levels-1,a));var f=Math.round(d.width/e),g=Math.round(d.height/e),h=Math.ceil(f/this.map.tileSize().x),i=Math.ceil(g/this.map.tileSize().y);d.tiles_wide=h,d.tiles_high=i,d.tiles_zoom=a}var j=0,k=0;for(b=0,c=this.layers.length;b<c;b++)this.layers[b].tiles_high>k&&(k=this.layers[b].tiles_high),this.layers[b].tiles_wide>j&&(j=this.layers[b].tiles_wide);this.settings.containerFitSW=this.map.coordinateLocation({zoom:a,column:0,row:k}),this.settings.containerFitNE=this.map.coordinateLocation({zoom:a,column:j,row:0}),this.map.extent([this.settings.containerFitSW,this.settings.containerFitNE]),this.settings.containerFitZoomLevel=this.map.zoom(),this.resetZoomRange(this.settings.containerFitZoomLevel)},LayeredImage.prototype.createUI=function(){var a=this.$,b=this,c,d;if(!this.figureOptions.disable_interaction||this.figureOptions.editing)this.map.add(this.polymaps.drag()).add(this.polymaps.wheel()).add(this.polymaps.dblclick()).add(this.polymaps.touch()),a(this.container).bind({mousewheel:function(a){b.ui.zoomSlider.slider("value",b.map.zoom()),b.refreshViewfinderViewport()},DOMMouseScroll:function(a){b.ui.zoomSlider.slider("value",b.map.zoom()),b.refreshViewfinderViewport()},dblclick:function(a){b.ui.zoomSlider.slider("value",b.map.zoom()),b.refreshViewfinderViewport()},mousedown:function(a){b.settings.dragging={x:a.clientX,y:a.clientY},liCollection.userIsDraggingAsset=b.id}});this.ui={},this.ui.legendItemsCount=0,this.ui.controlbar=a('<div class="ca-ui-controlbar"></div>'),this.settings.collapsed?c="collapsed":c="expanded",this.ui.fullscreen=a('<div class="ca-ui-fullscreen '+c+'"></div>').bind("click",function(){b.settings.collapsed?b.fullscreen():(window.liCollection.remove(b),a(".ca-ui-fullscreen-modal").remove(),window.scrollOffset&&window.scrollTo(window.scrollOffset[0],window.scrollOffset[1]))}).appendTo(this.ui.controlbar),this.ui.reset=a('<div class="ca-ui-reset"></div>').bind("click",function(a){b.reset()}),(!this.figureOptions.disable_interaction||this.figureOptions.editing)&&this.ui.reset.appendTo(this.ui.controlbar),this.annotationLayers.length>0&&(this.ui.annotation=a('<div class="ca-ui-annotation"></div>').bind("click",function(a){b.toggleAnnotationSelector()}),(!this.figureOptions.disable_annotation||this.figureOptions.editing)&&this.ui.annotation.appendTo(this.ui.controlbar));var e=this.getVisibleBaseLayers();this.settings.currentLayer1=e[0];if(e.length>1){this.settings.currentLayer2=e[1],this.ui.layerSelector=a('<div class="ca-ui-layer-selector"></div>'),this.baseLayers.length>2&&this.ui.layerSelector.bind("click",{layeredImage:this},this.toggleLayerSelector),(!this.figureOptions.disable_interaction||this.figureOptions.editing)&&this.ui.controlbar.append(this.ui.layerSelector),this.ui.sliderContainer=a('<div class="ca-ui-layer-slider-container"></div>'),this.ui.sliderLayerText=a('<div class="ca-ui-layer-slider-layer-text"></div>').text(this.settings.currentLayer1.title+" - "+this.settings.currentLayer2.title).appendTo(this.ui.sliderContainer),this.ui.slider=a('<div class="ca-ui-layer-slider"></div>').slider({slide:function(c,d){var e=d.value/100;a("#"+b.settings.currentLayer2.id).css("opacity",e),b.refreshViewfinderOpacity(e)},change:function(c,d){var e=d.value/100;a("#"+b.settings.currentLayer2.id).css("opacity",e),b.refreshViewfinderOpacity(e)}}).appendTo(this.ui.sliderContainer);if(!this.figureOptions.disable_interaction||this.figureOptions.editing)this.ui.sliderContainer.appendTo(this.ui.controlbar),this.ui.layerSelector.after(this.ui.sliderContainer);this.figureOptions.sliderPosition!==undefined&&this.ui.slider.slider("value",this.figureOptions.sliderPosition)}this.ui.controlbar.appendTo(this.container),this.resizeControlBar(),this.ui.zoom=a('<div class="ca-ui-zoom"></div>'),this.ui.zoomIn=a('<div class="ca-ui-zoom-in"></div>').bind("click",function(a){var c=b.ui.zoomSlider.slider("value"),d=c+b.settings.zoomStep;b.ui.zoomSlider.slider("value",d),b.map.zoom(d)}).appendTo(this.ui.zoom),this.ui.zoomSlider=a('<div class="ca-ui-zoom-slider"></div>').slider({step:this.settings.zoomStep,orientation:"vertical",slide:function(a,c){var d=c.value,e=b.map.zoom();d!=e&&b.map.zoom(d)}}).appendTo(this.ui.zoom),this.ui.zoomOut=a('<div class="ca-ui-zoom-out"></div>').bind("click",function(a){var c=b.ui.zoomSlider.slider("value"),d=c-b.settings.zoomStep;b.ui.zoomSlider.slider("value",d),b.map.zoom(d)}).appendTo(this.ui.zoom),(!this.figureOptions.disable_interaction||this.figureOptions.editing)&&this.ui.zoom.appendTo(this.container),this.ui.viewfinder=a('<div class="ca-ui-viewfinder viewfinder-closed"></div>'),(!this.figureOptions.disable_interaction||this.figureOptions.editing)&&this.ui.viewfinder.appendTo(this.container),this.ui.viewfinder.bind("click",function(a){b.ui.viewfinder.hasClass("viewfinder-open")?(b.ui.viewfinder.empty().css("height",""),b.ui.viewfinder.removeClass("viewfinder-open").addClass("viewfinder-closed"),b.ui.viewfinderViewport=null):(b.ui.viewfinder.removeClass("viewfinder-closed").addClass("viewfinder-open"),b.refreshViewfinder())}),this.ui.controls=[this.ui.controlbar,this.ui.zoom,this.ui.viewfinder,this.ui.currentPopup,this.ui.annotation,this.ui.layerSelector],this.container.bind("mousemove",function(a){var c=b.container,d=new Date;c.attr("data-controls-time",d.getTime());var e=c.attr("data-controls")||"false";if(e=="false"){var f=window.liCollection.list();for(var g=0,h=f.length;g<h;g++){var i=f[g];i.container.attr("data-controls")=="true"&&(i.container.attr("data-controls","false"),i.toggleControls())}c.attr("data-controls","true"),b.toggleControls()}b.ui.controlsTimeout=setTimeout(function(){var a=new Date;c.attr("data-controls")=="true"&&a.getTime()-c.attr("data-controls-time")>=1750&&c.attr("data-controls-lock")!="true"&&(c.attr("data-controls","false"),b.clearPopups(),b.toggleControls())},2e3)}),a.each(this.ui.controls,function(){typeof this.bind=="function"&&(this.bind("mouseenter",function(){b.container.attr("data-controls-lock","true")}),this.bind("mouseleave",function(){b.container.attr("data-controls-lock","false")}))})},LayeredImage.prototype.reset=function(){var a=this.$,b,c,d=this;d.clearPopups();if(typeof d.figureOptions.swLat!="undefined"&&!d.figureOptions.editing){var e=[{lon:d.figureOptions.swLon,lat:d.figureOptions.swLat},{lon:d.figureOptions.neLon,lat:d.figureOptions.neLat}];d.map.extent(e)}else d.zoomToContainer();d.ui.zoomSlider.slider("value",d.map.zoom()),d.figureOptions.sliderPosition!==undefined&&d.ui.slider&&d.ui.slider.slider("value",d.figureOptions.sliderPosition);var f;if(d.figureOptions.baseLayerPreset){f=[];for(b=0,c=d.figureOptions.baseLayerPreset.length;b<c;b++)f.push(d.getLayerById(d.figureOptions.baseLayerPreset[b]))}else f=d.baseLayers;for(b=0,c=f.length;b<c&&b<2;b++)currentLayer=d.settings["currentLayer"+(b+1)],d.toggleLayer(currentLayer),d.toggleLayer(f[b]),d.settings["currentLayer"+(b+1)]=f[b],d.ui["layerSelector"+(b+1)]&&d.ui["layerSelector"+(b+1)].find("span").html(f[b].title);f.length>1&&d.ui.slider&&(a("#"+d.settings.currentLayer2.id).css("opacity",d.ui.slider.slider("value")/100),d.ui.viewfinderLayer2&&d.ui.viewfinderLayer2.css("opacity",d.ui.slider.slider("value")/100)),d.showAnnotationPresets()},LayeredImage.prototype.refreshViewfinder=function(){var a=this.$,b=this;this.ui.viewfinder.empty();var c=this.settings.currentLayer1.thumb;this.ui.viewfinderLayer1=a('<div class="ca-ui-viewfinderLayer viewfinderLayer1"></div>'),a("<img />").attr("src",c).appendTo(this.ui.viewfinderLayer1),this.ui.viewfinder.append(this.ui.viewfinderLayer1);if(this.settings.currentLayer2){var d=this.settings.currentLayer2.thumb;this.ui.viewfinderLayer2=a('<div class="ca-ui-viewfinderLayer viewfinderLayer2"></div>'),a("<img />").attr("src",d).appendTo(this.ui.viewfinderLayer2),this.ui.viewfinder.append(this.ui.viewfinderLayer2),this.ui.viewfinderLayer2.css("opacity",this.ui.slider.slider("value")/100)}var e=this.ui.viewfinder.width(),f=Math.floor(e/this.settings.aspect);this.ui.viewfinder.height(f),this.refreshViewfinderViewport()},LayeredImage.prototype.refreshViewfinderViewport=function(){if(this.ui.viewfinder.hasClass("viewfinder-open")){var a=this.$,b=this.ui.viewfinder.width(),c=Math.floor(b/this.settings.aspect);this.ui.viewfinderViewport||(this.ui.viewfinderViewport=a('<div class="ca-ui-viewfinder-viewport">&nbsp;</div>').appendTo(this.ui.viewfinder),this.settings.viewPortBorderWidth===undefined&&(this.settings.viewPortBorderWidth=parseInt(this.ui.viewfinderViewport.css("border-left-width"),10)));var d=this.map.locationPoint(this.settings.containerFitSW),e=this.map.locationPoint(this.settings.containerFitNE),f=d.x*-1/(e.x-d.x)*b-this.settings.viewPortBorderWidth,g=e.y*-1/(d.y-e.y)*c-this.settings.viewPortBorderWidth,h=this.map.size().x/(e.x-d.x),i=this.map.size().y/(d.y-e.y),j=h*b,k=i*c;this.ui.viewfinderViewport.css({top:g+"px",left:f+"px",width:j+"px",height:k+"px"})}},LayeredImage.prototype.refreshViewfinderOpacity=function(a){this.ui.viewfinderLayer2&&this.ui.viewfinderLayer2.css("opacity",a)},LayeredImage.prototype.fullscreen=function(a){var b=this.$,c=this,d=b('<div class="ca-ui-fullscreen-modal"></div>').appendTo(document.body);d.bind("click",function(a){b(a.target).hasClass("ca-ui-fullscreen-modal")&&b(this).find(".ca-ui-fullscreen").trigger("click")});var e=b('<div class="ca-ui-fullscreen-wrap"></div>').appendTo(d),f=d.offset(),g=d.height()-f.top,h=d.outerWidth()-f.left;e.css({height:Math.round(g*.9)+"px",top:Math.round(g*.05)+"px",width:Math.round(h*.9)+"px",left:Math.round(h*.05)+"px"});var i=b(this.settings.originalMarkup);i.attr("id",i.attr("id")+"-fullscreen"),i.attr("data-collapsed","false"),i.find("li").each(function(){var a=b(this);a.data("id",a.data("id")+"-fullscreen"),a.data("parent_asset",a.data("parent_asset")+"-fullscreen")});var j=this.map.extent();this.figureOptions.fullscreenExtents={swLon:j[0].lon,swLat:j[0].lat,neLon:j[1].lon,neLat:j[1].lat};var k=b("<figure></figure>").attr("data-options",JSON.stringify(this.figureOptions)).css({height:Math.round(g*.9)+"px",width:Math.round(h*.9)+"px"}).appendTo(e),l=0;this.settings.captionMarkup&&(k.append(this.settings.captionMarkup),l=this.settings.captionMarkup.outerHeight(!0)),b("<div>",{"class":"figureContent",css:{height:Math.round(g*.9)-l+"px",width:Math.round(h*.9)+"px"}}).append(i).prependTo(k);var m=new LayeredImage(i);a&&m.reset()},LayeredImage.prototype.resizeControlBar=function(){var a=this.container.outerWidth(),b=this.ui.controlbar.outerWidth(),c=a-parseInt(this.ui.controlbar.css("right"),10)*2;b>c&&(this.ui.controlbar.css({"max-width":c+"px"}),this.ui.controlbar.find(".ca-ui-layer > span").css({width:"1px"}))},LayeredImage.prototype.toggleLayerSelector=function(a){var b=jQuery,c=a.data.layeredImage,d=b(this),e=c.settings.currentLayer1,f=c.settings.currentLayer2;if(c.ui.currentPopup&&c.ui.currentPopup==c.ui.layerSelectorPopup)c.clearPopups();else{c.clearPopups(),d.addClass("active"),rows=b('<div class="ca-ui-layer-selector-rows"></div>');for(var g=0;g<c.baseLayers.length;g++){var h=c.baseLayers[g];rowLayerButton1=b('<div class="ca-ui-layer-selector-row-button1"><div class="ca-ui-layer-selector-button"></div></div>').attr("data-layer_index",g),rowTitle=b('<div class="ca-ui-layer-selector-row-title"><span>'+h.title+"</span></div>"),rowLayerButton2=b('<div class="ca-ui-layer-selector-row-button2"><div class="ca-ui-layer-selector-button"></div></div>').attr("data-layer_index",g),h==c.settings.currentLayer1&&rowLayerButton1.find(".ca-ui-layer-selector-button").first().addClass("active"),h==c.settings.currentLayer2&&rowLayerButton2.find(".ca-ui-layer-selector-button").first().addClass("active"),rowLayerButton1.bind("click",{CA:c,layerNum:1},c.layerSelect),rowLayerButton2.bind("click",{CA:c,layerNum:2},c.layerSelect),row=b('<div class="ca-ui-layer-selector-row"></div>').append(rowLayerButton1).append(rowTitle).append(rowLayerButton2),rows.append(row)}var i=parseInt(c.ui.controlbar.css("bottom"),10)+c.ui.controlbar.height(),j=c.ui.controlbar.position().left,k=c.ui.sliderContainer.outerWidth()+d.outerWidth(),l={bottom:i+"px",left:j+"px"};c.ui.layerSelectorPopup=b('<div class="ca-ui-layer-selector-popup"></div>').css(l).bind("mouseenter",function(){c.container.attr("data-controls-lock","true")}).bind("mouseleave",function(){c.container.attr("data-controls-lock","false")}).append(rows).appendTo(c.container),c.ui.currentPopup=c.ui.layerSelectorPopup}},LayeredImage.prototype.toggleAnnotationSelector=function(){var a=this.$,b=this;if(this.ui.currentPopup&&this.ui.currentPopup==this.ui.annotationSelector)this.clearPopups();else{this.clearPopups(),this.ui.annotation.addClass("active");var c=this.ui.annotation.offsetParent().position(),d=this.ui.annotation.position(),e=this.ui.annotation.outerWidth(),f=this.ui.annotation.offsetParent().parent().width(),g=this.ui.annotation.offsetParent().parent().height(),h=f-c.left-d.left-e,i=g-c.top-d.top;this.settings.annotationSelectorVisible=!0,this.ui.annotationSelector=a('<div class="ca-ui-annotation-selector"></div>').css({right:h,bottom:i}),a('<div class="title">Annotations</div>').appendTo(this.ui.annotationSelector),this.ui.annotationSelectorList=a('<ul class="ca-ui-annotation-selector-list"></ul>');for(var j=0,k=this.annotationLayers.length;j<k;j++){var l=this.annotationLayers[j],m=a("<li></li>").bind("click",{layerData:l,CA:b},b.annotationLayerClick),n=a('<div class="ca-ui-annotation-selector-item-box"></div>').addClass(l.visible?"filled":"empty");l.visible&&l.annotation&&n.css("background-color","#"+l.color),m.append(n).append("<span>"+l.title+"</span>").appendTo(this.ui.annotationSelectorList)}this.ui.annotationSelector.bind("mouseenter",function(){b.container.attr("data-controls-lock","true")}).bind("mouseleave",function(){b.container.attr("data-controls-lock","false")}).append(this.ui.annotationSelectorList).appendTo(this.container),this.ui.currentPopup=this.ui.annotationSelector}},LayeredImage.prototype.annotationLayerClick=function(a){var b=a.data.layerData,c=a.data.CA;c.toggleLayer(b);var d=$(this).find(".ca-ui-annotation-selector-item-box");if(b.visible){d.removeClass("empty").addClass("filled");if(b.annotation&&b.type=="svg"){var e=b.color||"#fff";d.css("background-color","#"+e),c.addLegendItem(b)}}else d.removeClass("filled").addClass("empty"),b.annotation&&b.type=="svg"&&(d.css("background-color",""),c.removeLegendItem(b))},LayeredImage.prototype.resetZoomRange=function(a){a=a||0;var b=0;for(var c=0,d=this.layers.length;c<d;c++)this.layers[c].type=="iip"?this.layers[c].zoom_levels-1>b&&(b=this.layers[c].zoom_levels-1):this.layers[c].zoom_levels>b&&(b=this.layers[c].zoom_levels);this.map.zoomRange([a,b]),this.ui.zoomSlider.slider("option","min",a),this.ui.zoomSlider.slider("option","max",b)},LayeredImage.prototype.getZoomLevels=function(a,b){var c=this.map.tileSize().x,d=1;while(a>c||b>c)d++,a=a/2,b=b/2;return d},LayeredImage.prototype.getScale=function(a,b){return Math.pow(2,a-b)},LayeredImage.prototype.realignLayers=function(){var a=this.$,b,c,d=this.container.find("svg.map"),e=d.find("g.layer").remove();for(b=0,c=e.length;b<c;b++)a(e[b]).attr("id")==this.settings.currentLayer1.id&&(d.append(e[b]),e.splice(b,1));for(b=0,c=e.length;b<c;b++)a(e[b]).attr("id")==this.settings.currentLayer2.id&&(d.append(e[b]),e.splice(b,1));d.append(e)},LayeredImage.prototype.clearPopups=function(){var a=this;this.ui.currentPopup&&(this.ui.currentPopup.fadeOut(400,function(){$(this).remove()}),this.ui.currentPopup=!1),this.ui.controls&&$.each(this.ui.controls,function(){$(this).removeClass("active")})},LayeredImage.prototype.toggleControls=function(a){a=a||400;var b=this.$;b.each(this.ui.controls,function(){this!=window&&this.fadeToggle(a)})},LayeredImage.prototype.addLegendItem=function(a){var b=this.$;if(!a.color||a.color==="")return;this.ui.legend||(this.ui.legend=b('<div class="ca-ui-legend"><ul class="legendList"></ul></div>').appendTo(this.container),this.container.attr("data-controls")!="true"&&this.ui.legend.css("display","none"),this.ui.controls.push(this.ui.legend));var c=this.ui.legend.find("ul"),d=b('<li data-layer_num="'+a.layer_num+'">'+a.title+"</li>").appendTo(c),e=b('<div class="item-box"></div>').css("background-color","#"+a.color).prependTo(d);this.ui.legendItemsCount++},LayeredImage.prototype.removeLegendItem=function(a){var b=this.$,c=this;if(this.ui.legend){var d=this.ui.legend.find("ul").children();d.each(function(){b(this).attr("data-layer_num")==a.layer_num&&(b(this).remove(),c.ui.legendItemsCount--)});if(this.ui.legendItemsCount<=0){this.ui.legend.remove(),delete this.ui.legend;for(var e=0,f=this.ui.controls.length;e<f;e++)b(this.ui.controls[e]).hasClass("ca-ui-legend")&&this.ui.controls.splice(e,1)}}},LayeredImage.prototype.showAnnotationPresets=function(){for(var a=0,b=this.annotationLayers.length;a<b;a++){this.removeLayer(this.annotationLayers[a]),this.removeLegendItem(this.annotationLayers[a]);if(this.figureOptions.annotationPreset)for(var c=0,d=this.figureOptions.annotationPreset.length;c<d;c++){var e=this.figureOptions.annotationPreset[c];if(this.annotationLayers[a].layer_id==e){this.repaintLayer(this.annotationLayers[a]),(!this.figureOptions.disable_annotation||this.figureOptions.editing)&&this.addLegendItem(this.annotationLayers[a]);break}}}},LayeredImage.prototype.getVisibleBaseLayers=function(){var a,b,c=[];for(a=0,b=this.baseLayers.length;a<b;a++){var d=this.baseLayers[a];d.visible&&c.push(d)}return c},LayeredImage.prototype.getVisibleBaseLayerIds=function(){var a,b,c=[];for(a=0,b=this.baseLayers.length;a<b;a++){var d=this.baseLayers[a];d.visible&&c.push(d.layer_id)}return c},LayeredImage.prototype.getVisibleAnnotationIds=function(){var a,b,c=[];for(a=0,b=this.annotationLayers.length;a<b;a++){var d=this.annotationLayers[a];d.visible&&c.push(d.layer_id)}return c},LayeredImage.prototype.getExtents=function(){var a=this.map.extent();return{swLon:a[0].lon,swLat:a[0].lat,neLon:a[1].lon,neLat:a[1].lat}},LayeredImage.prototype.setExtents=function(a){this.map.extent(a),this.ui.zoomSlider&&this.ui.zoomSlider.slider("value",this.map.zoom())},LayeredImage.prototype.getSliderPosition=function(){return typeof this.ui.slider!="undefined"?this.ui.slider.slider("value"):0},LayeredImage.prototype.getLayerById=function(a){for(var b=0,c=this.layers.length;b<c;b++)if(this.layers[b].layer_id&&this.layers[b].layer_id==a)return this.layers[b];return!1},LayeredImage.prototype.layerSelect=function(a){var b=a.data.CA,c=a.data.layerNum,d=parseInt($(this).attr("data-layer_index"),10),e=$(this).find(".ca-ui-layer-selector-button");if(e.hasClass("active"))return;var f=c==1?2:1,g=b.ui.layerSelectorPopup.find(".ca-ui-layer-selector-row-button"+f+'[data-layer_index="'+d+'"] .ca-ui-layer-selector-button');if(g.hasClass("active"))return;b.removeLayer(b.settings["currentLayer"+c]),b.createLayer(b.baseLayers[d]),b.settings["currentLayer"+c]=b.baseLayers[d];if(c==2){var h=b.ui.slider.slider("value"),i=h/100;$("#"+b.settings.currentLayer2.id).css("opacity",i)}b.ui.layerSelectorPopup.find(".ca-ui-layer-selector-row-button"+c+" .ca-ui-layer-selector-button").removeClass("active"),e.addClass("active"),b.ui.sliderLayerText.text(b.settings.currentLayer1.title+" - "+b.settings.currentLayer2.title),b.realignLayers()},window.liCollection=new LICollection,window.addEventListener("mousemove",liMousemove,!1),window.addEventListener("mouseup",liMouseup,!1),app={dispatcher:undefined,router:undefined,config:undefined,views:{},models:{},collections:{},bootstrap:function(a){this.dispatcher=_.extend({},Backbone.Events),this.config=new OsciTk.models.Config(a),this.router=new OsciTk.router,this.account=new OsciTk.models.Account,this.collections.notes=new OsciTk.collections.Notes,this.collections.figures=new OsciTk.collections.Figures,this.collections.footnotes=new OsciTk.collections.Footnotes,this.collections.navigationItems=new OsciTk.collections.NavigationItems,window.onresize=function(){window.resizeTimer&&clearTimeout(window.resizeTimer);var a=function(){app.dispatcher.trigger("windowResized")};window.resizeTimer=setTimeout(a,200)},this.views.app=new OsciTk.views.App},run:function(){this.models.docPackage=new OsciTk.models.Package({url:this.config.get("packageUrl")}),Backbone.history.start()}},app.zotero={init:function(){app.dispatcher.on("packageLoaded",function(a){var b=new Date(a.get("dc:date"));b=b.getFullYear()+"-"+(b.getMonth()+1)+"-"+b.getDate();var c=["ctx_ver=Z39.88-2004","rft_val_fmt=info%3Aofi%2Ffmt%3Akev%3Amtx%3Abook","rft.genre=book","rft.date="+b,"rfr_id="+a.get("dc:identifier"),"rft.btitle="+a.get("dc:title"),"rft.atitle="+a.get("dc:title"),"rft.au="+a.get("dc:creator"),"rft.pub="+a.get("dc:publisher")],d=$("<span></span>");d.addClass("Z3988"),d.attr("title",c.join("&")),d.appendTo($("body"));var e=document.createEvent("HTMLEvents");e.initEvent("ZoteroItemUpdated",!0,!0),document.dispatchEvent(e)})}};