/*
 * OSCI Toolkit - v0.1.0 - 2012-05-24
 * http://oscitoolkit.org/
 * Copyright (c) 2010-2012 The Art Institute of Chicago and the Indianapolis Museum of Art
 * GNU General Public License
 */
function getAttributeByLanguage(a){var b=[];for(var c=0;c<a.length;c++)(!a[c].lang||a[c].lang&&a[c].lang==tap.language)&&b.push(a[c]);return b.length===0&&(b=a),b}function loadXMLDoc(a){return xhttp=new XMLHttpRequest,xhttp.open("GET",a,!1),xhttp.send(),xhttp.responseXML}function objectToArray(a){if(a===undefined)return;return Object.prototype.toString.call(a)!=="[object Array]"?[a]:a}function xmlToJson(a,b){var c=!0,d=0;if(!b){b=["xml:"];for(d=0;d<a.documentElement.attributes.length;d++)a.documentElement.attributes.item(d).nodeName.indexOf("xmlns")!=-1&&b.push(a.documentElement.attributes.item(d).nodeName.replace("xmlns:","")+":")}if(a.nodeType===Node.TEXT_NODE)c=a.nodeValue.replace(/^\s+|\s+$/g,"");else{if(a.nodeType===1&&a.attributes.length>0){var e;c={};for(d=0;d<a.attributes.length;d++)e=a.attributes.item(d),c[e.nodeName.replaceArray(b,"").toCamel()]=e.nodeValue}if(a.hasChildNodes()){var f,g,h;c===!0&&(c={});for(d=0;d<a.childNodes.length;d++){h=a.childNodes.item(d),f=h.nodeType===3?"value":h.nodeName.replaceArray(b,"").toCamel(),g=xmlToJson(h,b);if(g.length!==0&&f!=="#comment")if(c.hasOwnProperty(f))h.nodeType===3?c[f]+=g:(c[f].constructor!==Array&&(c[f]=[c[f]]),c[f].push(g));else if(h.nodeType!==3||g!=="")c[f]=g}}}return c}function roundNumber(a,b){return Math.round(a*Math.pow(10,b))/Math.pow(10,b)}String.prototype.replaceArray=function(a,b){var c=this;for(var d=0;d<a.length;d++)c=c.replace(a[d],b);return c},String.prototype.toCamel=function(){return this.replace(/\s(.)/g,function(a){return a.toUpperCase()}).replace(/\s/g,"").replace(/^(.)/,function(a){return a.toLowerCase()})},typeof OsciTk=="undefined"&&(OsciTk={}),jQuery(function(){OsciTk.router=Backbone.Router.extend({routes:{"":"routeToSection","section/:section_id":"routeToSection","section/:section_id/:identifier":"routeToSection"},routeToSection:function(a,b){app.dispatcher.trigger("routedToSection",{section_id:a,identifier:b})}})}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.templates=="undefined"&&(OsciTk.templates={}),OsciTk.templateManager={get:function(a){return OsciTk.templates[a]===undefined&&$.ajax({async:!1,dataType:"html",url:"js/backbone/templates/"+a+".tpl.html",success:function(b,c,d){OsciTk.templates[a]=_.template(b)}}),OsciTk.templates[a]}},typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.collections=="undefined"&&(OsciTk.collections={}),OsciTk.collections.BaseCollection=Backbone.Collection.extend(),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.models=="undefined"&&(OsciTk.models={}),OsciTk.models.BaseModel=Backbone.Model.extend(),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.views=="undefined"&&(OsciTk.views={}),OsciTk.views.BaseView=Backbone.View.extend({getChildViews:function(){return this.childViews||(this.childViews=[]),this.childViews},addView:function(a,b){return a.parent=this,typeof b=="undefined"?this.$el.append(a.el):this.$el.find(b).append(a.el),this._addViewReference(a),this},removeAllChildViews:function(){if(this.childViews){for(var a=0,b=this.childViews.length;a<b;a++)this.childViews[a].close();this.childViews=[]}return this},removeView:function(a,b){if(this.childViews)for(var c=0,d=this.childViews.length;c<d;c++)if(a.cid===this.childViews[c].cid){this.childViews.splice(c,1),(b||b===undefined)&&a.close();break}return this},getChildViewById:function(a){var b;if(this.childViews)for(var c=0,d=this.childViews.length;c<d;c++)if(a===this.childViews[c].cid){b=this.childViews[c];break}return b},getChildViewByIndex:function(a){var b;return this.childViews&&this.childViews[a]&&(b=this.childViews[a]),b},getChildViewsByType:function(a){return _.filter(this.childViews,function(b){return b.$el.is(a)})},replaceView:function(a,b){return a.parent=this,typeof b=="undefined"?this.$el.html(a.el):this.$el.find(b).html(a.el),this._addViewReference(a),this},changeModel:function(a){return this.model=a,this},close:function(){this.removeAllChildViews(),this.remove(),this.unbind(),this.undelegateEvents(),this.onClose&&this.onClose()},_addViewReference:function(a){this.childViews||(this.childViews=[]);var b=!1;for(var c=0,d=this.childViews.length;c<d;c++)if(a.cid===this.childViews[c].cid){b=!0;break}b||this.childViews.push(a)}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.templates=="undefined"&&(OsciTk.templates={}),OsciTk.templates["account-login"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<h2>Login</h2>\n<div class="form-error"></div>\n<form id="account-form">\n\t<label for="username">Username:</label>\n\t<input type="text" id="username" placeholder="Username" />\n\t<label for="password">Password:</label>\n\t<input type="password" id="password" placeholder="Password" />\n\t<button type="button" class="login">Log In</button>\n\t<div><a href="#" class="register">Register an account</a></div>\n</form>';return __p},OsciTk.templates["account-profile"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+="<h2>Profile</h2>\n<h3>"+username+"</h3>\n<h4>"+email+'</h4>\n<div><a href="#" class="logout">Log out</a></div>';return __p},OsciTk.templates["account-register"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<h2>Register</h2>\n<div class="form-error"></div>\n<form id="account-form">\n\t<label for="username">Username:</label>\n\t<input type="text" id="username" placeholder="Username" />\n\t<label for="password">Password:</label>\n\t<input type="password" id="password" placeholder="Password" />\n\t<label for="email">Email:</label>\n\t<input type="text" id="email" placeholder="Email" />\n\t<button type="button" class="register">Register</button>\n\t<div><a href="#" class="login">Already have an account?</a></div>\n</form>';return __p},OsciTk.templates["figure-reference"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<a href="#'+id+'" class="figure_reference">'+title+"</a>";return __p},OsciTk.templates.figures=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+="<div class='figure-browser'>\n\t<h2>Figures</h2>\n\t<div class='figure-tray'>\n\t\t<div class='figure-reel'>\n\t\t\t",_.each(figures,function(a){__p+="\n\t\t\t\t<figure class='thumbnail' data-figure-id=\""+a.id+'">\n\t\t\t\t\t',a.thumbnail_url!=undefined?__p+="\n\t\t\t\t\t\t<img class='figure-thumbnail' src='"+a.thumbnail_url+"'/>\n\t\t\t\t\t":__p+="\n\t\t\t\t\t\t<div class='figure-thumbnail'>&nbsp;</div>\n\t\t\t\t\t",__p+="\n\t\t\t\t\t<figcaption>"+a.title+"</figcaption>\n\t\t\t\t</figure>\n\t\t\t"}),__p+="\n\t\t</div>\n\t</div>\n</div>\n<div class='figure-previews'>\n\t<div class='figure-nav prev' title='Previous figure'>&lt;</div>\n\t<div class='figure-nav next' title='Next Figure'>&gt;</div>\n\n\t<h2><span class='back-to-grid'>&laquo; Figures</span> | <span class='title'>TITLE</span></h2>\n\t<div class='figure-tray'>\n\t\t<div class='figure-reel'>\n\t\t\t",_.each(figures,function(a){__p+="\n\t\t\t\t<figure class='preview' data-figure-id=\""+a.id+'">\n\t\t\t\t\t',a.thumbnail_url!=undefined?__p+="\n\t\t\t\t\t\t<img class='figure-preview' src='"+a.thumbnail_url+"'/>\n\t\t\t\t\t":__p+="\n\t\t\t\t\t\t<div class='figure-preview'>&nbsp;</div>\n\t\t\t\t\t",__p+="\n\t\t\t\t\t<div class='figure-info'>\n\t\t\t\t\t\t<!--<h3 class='title'>Figure Title?</h3>-->\n\t\t\t\t\t\t<!--<p class='meta-info'>meta info | more meta</p>-->\n\t\t\t\t\t\t<div class='caption'>\n\t\t\t\t\t\t\t"+a.caption+"\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<a class='view-in-context'>View in context</a>\n\t\t\t\t</figure>\n\t\t\t"}),__p+="\n\t\t</div>\n\t</div>\n</div>";return __p},OsciTk.templates.font=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<h2>Reading Settings</h2>\n<div class="font-control">\n\t<h3>Font Size</h3>\n\t<a href="#font-larger" class="larger font-button">A</a>\n\t<a href="#font-smaller" class="smaller font-button">A</a>\n</div>\n<div class="theme-control">\n\t<h3>Theme</h3>\n\t<a href="#normal" class="theme-button">Normal</a>\n\t<a href="#sepia" class="theme-button">Sepia</a>\n\t<a href="#night" class="theme-button">Night</a>\n</div>';return __p},OsciTk.templates["multi-column-column"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<div class="column"></div>';return __p},OsciTk.templates["multi-column-figure"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<div class="figure_content"></div>\n<figcaption>'+caption+"</figcaption>";return __p},OsciTk.templates["multi-column-section"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<div id="pages"></div>';return __p},OsciTk.templates.navigation=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+="<div class='header'>"+chapter+"</div>\n<div class='prev-page side'><div class='indicator'>&lt;</div></div>\n<div class='next-page side'><div class='indicator'>&gt;</div></div>\n<div class='prev-page corner'>\n\t<div class='label'>Previous</div>\n\t<div class='button'>&nbsp;</div>\n</div>\n<div class='pager'><div class='head'>&nbsp;</div></div>\n<div class='next-page corner'>\n\t<div class='label'>Next</div>\n\t<div class='button'>&nbsp;</div>\n</div>";return __p},OsciTk.templates.notes=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+="<h2>Notes</h2>\n<ul>\n\t",_.each(notes,function(a){__p+="\n\t\t<li>\n\t\t\t<p>P#"+a.paragraph_id+" - "+a.note+"<br>\n\t\t\t",a.tags.length>0&&(__p+="\n\t\t\t\t<small>tags: ",_.each(a.tags,function(a){__p+=""+a+" "}),__p+="</small>\n\t\t\t"),__p+="\n\t\t\t</p>\n\t\t</li>\n\t"}),__p+="\n</ul>";return __p},OsciTk.templates.page=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+=""+content+"";return __p},OsciTk.templates["search-result"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<div class="search-result-title">'+title+'</div>\n<div class="search-result-type type-'+type+'">'+type+'</div>\n<div class="search-result-content">'+content+"</div>";return __p},OsciTk.templates["search-results"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<div id="search-summary">Result(s) for "'+keyword+'" ('+result_count+')</div>\n<div id="search-sort">\n\tSort By: \n\t<div id="search-sort-relevance" data-selected="0">Relevance</div>\n\t<div id="search-sort-type" data-selected="0">Type</div>\n</div>\n<div id="search-results">'+search_results+"</div>";return __p},OsciTk.templates.search=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<div id="search-header">\n\t<div id="search-box">\n\t\t<form id="search-form" name="search-form" method="POST">\n\t\t\t<input type="text" name="keyword" id="search-keyword" placeholder="search" value="'+query+'"/>\n\t\t\t<input type="hidden" name="page" id="search-page" />\n\t\t</form>\n\t</div>\n</div>\n',searchResults.length>0&&(__p+='\n\t<div id="search-summary">Result(s) for "'+searchResults.keyword+'" ('+searchResults.length+')</div>\n\t<div id="search-sort">\n\t\tSort By: \n\t\t<div id="search-sort-relevance" data-selected="0">Relevance</div>\n\t\t<div id="search-sort-type" data-selected="0">Type</div>\n\t</div>\n\t<div id="search-results">\n\t\t<ul>\n\t\t\t',_.each(searchResults.models,function(a){__p+="\n\t\t\t\t",a.get("bundle")==="note"?__p+="\n\t\t\t\t\t<li>\n\t\t\t\t\t\t"+a.get("bundle_name")+" \n\t\t\t\t\t\tsec."+a.get("im_field_section")[0]+" p."+a.get("is_paragraph_id")+" - \n\t\t\t\t\t\t"+a.get("ss_body")+"\n\t\t\t\t\t</li>\n\t\t\t\t":__p+="\n\t\t\t\t\t<li>"+a.get("bundle_name")+" - "+a.get("ss_body")+"</li>\n\t\t\t\t",__p+="\n\t\t\t"}),__p+="\n\t\t</ul>\n\t</div>\n"),__p+="";return __p},OsciTk.templates.toc=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+="<h2>Table of Contents</h2>\n<ul>\n\t",_.each(items,function(a){__p+='\n\t\t<li class="toc-item">\n\t\t\t<a data-section-id="'+a.id+'" href="#">\n\t\t\t\t<div class="toc-item-thumbnail">\n\t\t\t\t\t',a.get("thumbnail")&&(__p+='\n\t\t\t\t\t\t<img src="'+a.get("thumbnail")+'">\n\t\t\t\t\t'),__p+='\n\t\t\t\t</div>\n\t\t\t\t<div class="toc-item-text">\n\t\t\t\t\t<h4>'+a.get("title")+"</h4>\n\t\t\t\t\t",a.get("subtitle")&&(__p+="\n\t\t\t\t\t\t<h5>"+a.get("subtitle")+"</h5>\n\t\t\t\t\t"),__p+="\n\t\t\t\t</div>\n\t\t\t</a>\n\t\t\t<hr>\n\t\t</li>\n\t"}),__p+="\n</ul>";return __p},OsciTk.templates["toolbar-item"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+=""+text+"";return __p},OsciTk.templates.toolbar=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<div id="toolbar-close">Close</div>\n<div id="toolbar-content"></div>\n<div id="toolbar-handle"></div>';return __p},typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.models=="undefined"&&(OsciTk.models={}),OsciTk.models.Account=OsciTk.models.BaseModel.extend({defaults:{username:"anonymous",id:0},initialize:function(){this.getSessionState()},sync:function(a,b,c){console.log(a,"account sync")},getSessionState:function(){var a=this;$.ajax({url:app.config.get("endpoints").OsciTkAccount,data:{action:"status"},type:"POST",dataType:"json",success:function(b){b.success===!0&&a.set(b.user)}})}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.models=="undefined"&&(OsciTk.models={}),OsciTk.models.Config=OsciTk.models.BaseModel.extend({}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.models=="undefined"&&(OsciTk.models={}),OsciTk.models.Figure=OsciTk.models.BaseModel.extend({defaults:function(){return{section_id:null,delta:null,caption:null,position:null,columns:null,aspect:1,body:null,options:{}}},initialize:function(){this.parsePositionData()},parsePositionData:function(){var a=this.get("position"),b;return a.length>1?b={vertical:a[0],horizontal:a[1]}:a==="n"||a==="p"?b={vertical:a,horizontal:a}:b={vertical:a,horizontal:"na"},this.set("position",b),this}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.models=="undefined"&&(OsciTk.models={}),OsciTk.models.Footnote=OsciTk.models.BaseModel.extend({defaults:function(){return{body:"",section_id:"",delta:""}},sync:function(a,b,c){console.log("Footnote.sync: "+a)}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.models=="undefined"&&(OsciTk.models={}),OsciTk.models.NavigationItem=OsciTk.models.BaseModel.extend({defaults:function(){return{title:null,subtitle:null,uri:null,parent:null,next:null,previous:null,depth:0,thumbnail:null,timestamp:null}},initialize:function(){}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.models=="undefined"&&(OsciTk.models={}),OsciTk.models.Note=OsciTk.models.BaseModel.extend({defaults:function(){return{id:null,note:null,section_id:null,paragraph_id:null,tags:[]}},initialize:function(a,b){this.bind("error",function(a,b){console.log([a,b],"error fired")})},sync:function(a,b,c){var d=app.config.get("endpoints").OsciTkNote;console.log("Note.sync: "+a),console.log(b,"model"),console.log(c,"options"),a=="create"&&(c.data=this.urlFormEncode(b),c.success=function(a,d,e){var f=JSON.parse(a);f.success||c.error(b,e)},c.type="POST",$.ajax(d,c)),a=="update"&&(c.data=this.urlFormEncode(b),c.success=function(a,d,e){var f=JSON.parse(a);console.log(f,"update response"),f.success||c.error(b,e)},c.type="POST",$.ajax(d,c)),a=="delete"&&(c.data=this.urlFormEncode(b),c.data=c.data+"delete=1",c.type="POST",c.success=function(a,d,e){var f=JSON.parse(a);console.log(f,"delete response"),f.success||c.error(b,e)},$.ajax(d,c))},urlFormEncode:function(a){var b="";for(var c in a.attributes)if($.isArray(a.attributes[c]))for(var d in a.attributes[c])b=b+c+"[]="+a.attributes[c][d]+"&";else b=b+c+"="+a.attributes[c]+"&";return b}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.models=="undefined"&&(OsciTk.models={}),OsciTk.models.Package=OsciTk.models.BaseModel.extend({defaults:function(){return{url:null,lang:null,spine:null,manifest:null,metadata:null,id:null,version:null,xmlns:null}},initialize:function(){var a=xmlToJson(loadXMLDoc(this.get("url")));this.set("lang",a["package"].lang),this.set("spine",a["package"].spine),this.set("manifest",a["package"].manifest),this.set("metadata",a["package"].metadata),this.set("id",a["package"]["unique-identifier"]),this.set("version",a["package"].version),this.set("xmlns",a["package"].xmlns),app.dispatcher.trigger("packageLoaded",this)},sync:function(a,b,c){console.log("Package.sync: "+a)}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.models=="undefined"&&(OsciTk.models={}),OsciTk.models.Page=OsciTk.models.BaseModel.extend({defaults:function(){return{content:[]}},addContent:function(a){var b=this.get("content");return b.push(a),this},removeContentAt:function(a){var b=this.get("content");return b.splice(a,1),this},removeAllContent:function(){this.set("content",[])},contentLength:function(){return this.get("content").length}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.models=="undefined"&&(OsciTk.models={}),OsciTk.models.SearchResult=OsciTk.models.BaseModel.extend({}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.models=="undefined"&&(OsciTk.models={}),OsciTk.models.Section=OsciTk.models.BaseModel.extend({defaults:function(){return{title:null,content:null,uri:null,media_type:"application/xhtml+xml",contentLoaded:!1,pages:new OsciTk.collections.Pages}},sync:function(a,b,c){},parse:function(a){console.log("parse section")},loadContent:function(){var a=null;if(this.get("contentLoaded")===!1){var b=loadXMLDoc(this.get("uri"));a=$(b),this.set("title",b.title),this.set("content",a),this.set("contentLoaded",!0)}a===null&&(a=$(this.get("content")));var c=a.find("section#footnotes"),d=a.find("figure");app.dispatcher.trigger("footnotesAvailable",c),app.dispatcher.trigger("figuresAvailable",d),app.dispatcher.trigger("sectionLoaded",this)},removeAllPages:function(){this.set("pages",new OsciTk.collections.Pages)}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.collections=="undefined"&&(OsciTk.collections={}),OsciTk.collections.Figures=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.Figure,initialize:function(){app.dispatcher.bind("figuresAvailable",function(a){this.populateFromMarkup(a)},this)},comparator:function(a){return a.get("delta")},populateFromMarkup:function(a){_.each(a,function(a){var b=a.id.match(/\w+-(\d+)-(\d+)/),c=$(a),d={id:a.id,rawData:a,body:a.innerHTML,section_id:b[1],delta:b[2],title:c.attr("title"),caption:c.find("figcaption").html(),content:c.find(".figure_content").html(),position:c.data("position"),columns:c.data("columns"),options:c.data("options"),thumbnail_url:undefined,type:c.data("figure_type"),aspect:c.data("aspect")},e=$(a).children("img.thumbnail");if(e.length)d.thumbnail_url=e.attr("src"),d.preview_url=e.attr("src");else{var f=$(".figure_content img",a);f.length&&(d.thumbnail_url=f.attr("src"),d.preview_url=f.attr("src"))}this.add(d)},this)}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.collections=="undefined"&&(OsciTk.collections={}),OsciTk.collections.Footnotes=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.Footnote,initialize:function(){app.dispatcher.bind("footnotesAvailable",function(a){this.populateFromMarkup(a)},this)},populateFromMarkup:function(a){_.each($("aside",a),function(a){var b=a.id.match(/\w+-(\d+)-(\d+)/),c={id:a.id,rawData:a,body:a.innerHTML,section_id:b[1],delta:b[2]};this.add(c)},this)}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.collections=="undefined"&&(OsciTk.collections={}),OsciTk.collections.NavigationItems=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.NavigationItem,currentNavigationItem:null,initialize:function(){app.dispatcher.on("packageLoaded",function(a){var b=_.find(a.get("manifest").item,function(a){return a.properties=="nav"});if(b){var c=xmlToJson(loadXMLDoc(b.href)),d=c.html[1].body.nav;for(var e in d)if(d[e].type=="toc"){_.each(d[e].ol.li,function(a){this.parseChildren(a,null,0)},this);break}app.dispatcher.trigger("navigationLoaded",this)}},this)},parseChildren:function(a,b,c){var d={id:a.a["data-section_id"],parent:b,depth:c,previous:this.at(this.length-1),next:undefined,length:a.a["data-length"],title:a.a.value,subtitle:a.a["data-subtitle"],thumbnail:a.a["data-thumbnail"],timestamp:a.a["data-timestamp"],uri:a.a.href};this.add(d);var e=this.at(this.length-1);e.get("previous")!==undefined&&e.get("previous").set("next",e);if(a.ol&&a.ol.li){var f;typeof a.ol.li.length!="undefined"?f=a.ol.li:f=[a.ol.li],_.each(f,function(a){this.parseChildren(a,e,++c)},this)}}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.collections=="undefined"&&(OsciTk.collections={}),OsciTk.collections.Notes=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.Note,initialize:function(){this.on("change",function(){app.dispatcher.trigger("notesChanged")}),app.dispatcher.on("currentNavigationItemChanged",function(a){a.id&&app.collections.notes.getNotesForSection(a.id)},this)},parse:function(a){return a.success?a.notes:!1},getNotesForSection:function(a){$.ajax({url:app.config.get("endpoints").OsciTkNotes,data:{section_id:a},type:"GET",dataType:"json",success:function(a){a.success===!0&&app.collections.notes.reset(a.notes)}})}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.collections=="undefined"&&(OsciTk.collections={}),OsciTk.collections.Pages=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.Page,initialize:function(){}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.collections=="undefined"&&(OsciTk.collections={}),OsciTk.collections.SearchResults=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.SearchResult}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.collections=="undefined"&&(OsciTk.collections={}),OsciTk.collections.Pages=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.Page}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.views=="undefined"&&(OsciTk.views={}),OsciTk.views.Page=OsciTk.views.BaseView.extend({template:OsciTk.templateManager.get("page"),className:"page",initialize:function(){this.processingData={complete:!1},this.$el.addClass("page-num-"+this.model.collection.length).attr("data-page_num",this.model.collection.length)},events:{"click figure .figure_content":"onFigureContentClicked","click a.figure_reference":"onFigureReferenceClicked"},onFigureContentClicked:function(a){return app.dispatcher.trigger("showFigureFullscreen",$(a.currentTarget).parent("figure").attr("id")),!1},onFigureReferenceClicked:function(a){return app.dispatcher.trigger("showFigureFullscreen",a.currentTarget.hash.substring(1)),!1},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},processingComplete:function(){return this.processingData.complete=!0,this},addContent:function(a){return this.model.addContent(a),this},hasContent:function(a){return this.model.get("content").length?!0:!1},isPageComplete:function(){return this.processingData.complete},removeAllContent:function(){return this.model.removeAllContent(),this},containsElementId:function(a){return this.$el.find("#"+a).length!==0}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.views=="undefined"&&(OsciTk.views={}),OsciTk.views.Section=OsciTk.views.BaseView.extend({id:"section",initialize:function(){_.defaults(this.options,{pageView:"Page"}),app.dispatcher.on("currentNavigationItemChanged",function(a){a&&(app.models.section=new OsciTk.models.Section({uri:a.get("uri"),id:a.get("id")}),app.models.section.loadContent(),this.changeModel(app.models.section),this.removeAllChildViews(),this.render())},this)},rerender:function(){this.model.removeAllPages(),this.removeAllChildViews(),this.render()},render:function(){return app.dispatcher.trigger("layoutStart"),this.renderContent(),app.dispatcher.trigger("layoutComplete",{numPages:this.model.get("pages").length}),this},onClose:function(){this.model.removeAllPages()},getPageForElementId:function(a){var b=this.getChildViews(),c=_.find(b,function(b){return b.containsElementId(a)});return c!==undefined&&c!==-1?_.indexOf(b,c)+1:null},getPageForProcessing:function(a,b){var c;return a!==undefined?c=this.getChildViewById(a):(c=_.filter(this.getChildViews(),function(a){return a.isPageComplete()===!1}),c.length===0?(this.model.get("pages").add({}),c=new OsciTk.views[this.options.pageView]({model:this.model.get("pages").at(this.model.get("pages").length-1),pageNumber:this.model.get("pages").length}),this.addView(c,b)):c=c.pop()),c},renderContent:function(){var a=this.getPageForProcessing();a.addContent(this.model.get("content").find("body").html()),a.render(),a.processingComplete()}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.views=="undefined"&&(OsciTk.views={}),OsciTk.views.MultiColumnFigure=OsciTk.views.BaseView.extend({tagName:"figure",template:OsciTk.templateManager.get("multi-column-figure"),layoutComplete:!1,contentRendered:!1,sizeCalculated:!1,calculatedHeight:0,calculatedWidth:0,position:{x:[0,0],y:[0,0]},initialize:function(){this.$el.css("visibility","hidden").attr("id",this.model.get("id")),app.dispatcher.on("pageChanged",function(a){this.parent.options.pageNumber===a.page?(this.contentRendered||this.renderContent(),this.$el.css("visibility","visible")):this.$el.css("visibility","hidden")},this)},render:function(){this.$el.html(this.template(this.model.toJSON())),this.sizeElement();var a=this.positionElement();return a&&(this.layoutComplete=!0),this},renderContent:function(){this.$el.find(".figure_content").html(this.model.get("content")),this.contentRendered=!0},positionElement:function(){var a=this.model.toJSON(),b=this.options.sectionDimensions;if(a.position.vertical==="n")return this.$el.hide(),!0;var c;switch(a.position.horizontal){case"r":c=b.columnsPerPage-1;break;case"l":case"p":c=0;break;default:c=this.parent.processingData.currentColumn}var d=!1,e=this.model.get("columns"),f=0,g=0,h=e,j=0;k:while(!d&&j<=h){j++,c+e>b.columnsPerPage&&(c-=c+e-b.columnsPerPage);var l=b.columnWidth*e+(e-1)*b.gutterWidth,m=0;this.calculatedWidth<l&&(m=Math.floor((l-this.calculatedWidth)/2)),f=c*b.columnWidth+c*b.gutterWidth+m,this.$el.css("left",f+"px");switch(a.position.vertical){case"t":case"p":g=0;break;case"b":g=b.innerSectionHeight-this.calculatedHeight}this.$el.css("top",g+"px");var n=[f,f+this.calculatedWidth],o=[g,g+this.calculatedHeight];this.position={x:n,y:o},d=!0;if(f<0||n[1]>b.innerSectionWidth)d=!1;var p=this.parent.getChildViewsByType("figure"),q=p.length;if(d&&q&&q>1)for(i=0;i<q;i++){if(p[i].cid===this.cid)continue;var r=p[i].position.x,s=p[i].position.y;if(n[0]<r[1]&&n[1]>r[0]&&o[0]<s[1]&&o[1]>s[0]){d=!1;break}}if(!d)switch(a.position.horizontal){case"r":c--;if(c<0)break k;break;case"l":case"p":c++;if(c>=b.columnsPerPage)break k;break;default:c++,c>b.columnsPerPage&&(c=0)}}return d},sizeElement:function(){var a,b,c=this.options.sectionDimensions,d=this.model.toJSON();if(d.position==="n")return this.calculatedHeight=this.$el.height(),this.calculatedWidth=this.$el.width(),this;typeof d.columns=="string"&&d.columns.indexOf("%")>0&&(d.columns=Math.ceil(parseInt(d.columns,10)/100*c.columnsPerPage)),d.columns>c.columnsPerPage||d.position==="p"?(a=c.innerSectionWidth,d.columns=c.columnsPerPage):a=d.columns*c.columnWidth+c.gutterWidth*(d.columns-1),this.$el.css("width",a+"px");var e=this.$el.find("figcaption").outerHeight(!0);return b=a/d.aspect+e,b>c.innerSectionHeight&&(b=c.innerSectionHeight,a=(b-e)*d.aspect,this.$el.css("width",a+"px"),e=this.$el.find("figcaption").outerHeight(!0),d.columns=Math.ceil((a+c.gutterWidth)/(c.gutterWidth+c.columnWidth))),a=roundNumber(a,2),b=roundNumber(b,2),this.$el.css({height:b+"px",width:a+"px"}),this.calculatedHeight=b,this.calculatedWidth=a,this.model.set("columns",d.columns),this.$el.find(".figure_content").css({width:a,height:b-e}),this.sizeCalculated=!0,this}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.views=="undefined"&&(OsciTk.views={}),OsciTk.views.Account=OsciTk.views.BaseView.extend({className:"account-view",template:null,initialize:function(){this.model=app.account},render:function(){this.model.get("id")>0?this.showProfile():this.showLoginForm()},events:{"click button.login":"login","click button.register":"register","click a.register":"showRegistrationForm","click a.login":"showLoginForm","click a.logout":"logout"},login:function(){var a=this,b=this.$el.find("#username").val(),c=this.$el.find("#password").val();$.ajax({url:app.config.get("endpoints").OsciTkAccount,data:{action:"login",username:b,password:c},type:"POST",dataType:"json",success:function(b){b.success===!0?(a.model.set(b.user),a.showProfile()):a.$el.find("div.form-error").html(b.error)}})},logout:function(){var a=this;$.ajax({url:app.config.get("endpoints").OsciTkAccount,data:{action:"logout"},type:"POST",dataType:"json",success:function(b){a.model.set(b.user),a.showLoginForm()}})},register:function(){var a=this,b=this.$el.find("#username").val(),c=this.$el.find("#password").val(),d=this.$el.find("#email").val();$.ajax({url:app.config.get("endpoints").OsciTkAccount,data:{action:"register",username:b,password:c,email:d},type:"POST",dataType:"json",success:function(b){b.success===!0?(a.model.set(b.user),a.showProfile()):a.$el.find("div.form-error").html(b.error)}})},showRegistrationForm:function(){this.template=OsciTk.templateManager.get("account-register"),this.$el.html(this.template())},showLoginForm:function(){this.template=OsciTk.templateManager.get("account-login"),this.$el.html(this.template())},showProfile:function(){this.template=OsciTk.templateManager.get("account-profile"),this.$el.html(this.template(this.model.toJSON()))}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.views=="undefined"&&(OsciTk.views={}),OsciTk.views.App=OsciTk.views.BaseView.extend({id:"reader",initialize:function(){$("body").append(this.el),app.views.toolbarView=new OsciTk.views.Toolbar,this.addView(app.views.toolbarView);var a=OsciTk.views.Section;app.config.get("sectionView")&&OsciTk.views[app.config.get("sectionView")]&&(a=OsciTk.views[app.config.get("sectionView")]);var b={};app.config.get("sectionViewOptions")&&(b=app.config.get("sectionViewOptions")),app.views.sectionView=new a(b),this.addView(app.views.sectionView),app.views.navigationView=new OsciTk.views.Navigation,this.addView(app.views.navigationView),app.views.footnotesView=new OsciTk.views.Footnotes,app.views.fsFigureView=new OsciTk.views.FullscreenFigureView}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.views=="undefined"&&(OsciTk.views={}),OsciTk.views.Figures=OsciTk.views.BaseView.extend({className:"figures-view",template:OsciTk.templateManager.get("figures"),initialize:function(){app.collections.figures.bind("add remove",function(){this.render()},this)},events:{"click .figure-preview":"onFigurePreviewClicked","click a.view-in-context":"onViewInContextClicked"},onFigurePreviewClicked:function(a){return app.dispatcher.trigger("showFigureFullscreen",$(a.target).parent("figure").attr("data-figure-id")),!1},onViewInContextClicked:function(a){return app.dispatcher.trigger("navigate",{identifier:$(a.target).parent("figure").attr("data-figure-id")}),app.views.toolbarView.contentClose(),!1},render:function(){this.$el.show();var a=app.collections.figures.toJSON();this.$el.html(this.template({figures:a}));if(a.length>1){var b=$("#toolbar figure.thumbnail");$("#toolbar .figure-browser .figure-reel").width(b.length*b.outerWidth(!0))}return $("#toolbar figure.thumbnail").click(function(){$("#toolbar .figure-browser").hide(),$("#toolbar .figure-previews figure.active").hide().removeClass("active");var a=$("#toolbar figure.preview[data-figure-id='"+$(this).attr("data-figure-id")+"']");a.show().addClass("active"),OsciTk.views.Figures.prototype.displayTitle(),$("#toolbar .figure-previews").show(),$("#toolbar").animate({height:$("#toolbar-content").height()+$("#toolbar-handle").height()},"fast")}),$(".back-to-grid").click(function(){$("#toolbar").animate({height:$(".figure-browser").height()+$("#toolbar-handle").height()},"fast",function(){$("#toolbar .figure-previews").hide(),$("#toolbar .figure-browser").show()})}),$("#toolbar .figure-nav.next").click(function(){var a=$("#toolbar figure.preview.active").hide().removeClass("active").next("figure.preview");a.length===0&&(a=$("#toolbar figure.preview").first()),a.show().addClass("active"),OsciTk.views.Figures.prototype.displayTitle()}),$("#toolbar .figure-nav.prev").click(function(){var a=$("#toolbar figure.preview.active").hide().removeClass("active").prev("figure.preview");a.length===0&&(a=$("#toolbar figure.preview").last()),a.show().addClass("active"),OsciTk.views.Figures.prototype.displayTitle()}),this},displayTitle:function(){var a=$("#toolbar figure.preview.active").attr("data-figure-id"),b=app.collections.figures.get(a);$("#toolbar h2 span.title").html(b.get("title"))}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.views=="undefined"&&(OsciTk.views={}),OsciTk.views.Font=OsciTk.views.BaseView.extend({className:"font-view",template:OsciTk.templateManager.get("font"),currentFontSize:100,initialize:function(){this.render()},render:function(){return this.$el.html(this.template()),this},events:{"click .font-button":"changeFontSize","click .theme-button":"changeTheme"},changeFontSize:function(a){a.preventDefault();var b=app.views.sectionView,c=$(a.target);c.attr("href")==="#font-larger"?this.currentFontSize+=25:this.currentFontSize-=25,b.$el.css({"font-size":this.currentFontSize+"%"}),app.dispatcher.trigger("windowResized")},changeTheme:function(a){a.preventDefault();var b=$(a.target),c=b.attr("href").substr(1),d=$("body");d.removeClass("normal sepia night"),d.addClass(c)}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.views=="undefined"&&(OsciTk.views={}),OsciTk.views.Footnotes=OsciTk.views.BaseView.extend({id:"footnote",initialize:function(){app.dispatcher.on("layoutComplete",function(a){var b=app.views.sectionView.$el.find("a.footnote-reference");_.each(b,function(a){a=$(a);var b=a.attr("href").slice(1),c=app.collections.footnotes.get(b);c&&a.qtip({content:c.get("body")})})},this)}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.views=="undefined"&&(OsciTk.views={}),OsciTk.views.FullscreenFigureView=OsciTk.views.BaseView.extend({id:"fsFigureView",initialize:function(){app.dispatcher.on("showFigureFullscreen",this.showFigureFullscreen)},showFigureFullscreen:function(a){var b=app.collections.figures.get(a);if(b==undefined){alert("Error: Figure "+a+" not found");return}var c=null;switch(b.get("type")){case"image_asset":$.fancybox.open({href:$(b.get("content")).attr("src")});return;case"html_asset":var c=new OsciTk.views.FullscreenHTMLFigureView({id:a,model:b});break;default:console.log("Unsupported figure type",b);return}$.fancybox.open({content:c.$el.html()})}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.views=="undefined"&&(OsciTk.views={}),OsciTk.views.FullscreenHTMLFigureView=OsciTk.views.BaseView.extend({className:"fullscreen-html-figure",initialize:function(){this.render()},render:function(){return this.$el.html(this.model.get("content")),this}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.views=="undefined"&&(OsciTk.views={}),OsciTk.views.MultiColumnFigureImage=OsciTk.views.MultiColumnFigure.extend({renderContent:function(){var a=this.$el.find(".figure_content"),b=a.height(),c=a.width();a.html(this.model.get("content")),a.children("img").css({height:b+"px",width:c+"px"}),this.contentRendered=!0}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.views=="undefined"&&(OsciTk.views={}),OsciTk.views.MultiColumnPage=OsciTk.views.Page.extend({columnTemplate:OsciTk.templateManager.get("multi-column-column"),visible:!0,onClose:function(){this.model=undefined},hide:function(){this.$el.css("visibility","hidden"),this.visible=!1},show:function(){this.$el.css("visibility","visible"),this.visible=!0},resetPage:function(){this.removeAllContent(),this.$el.children(":not(figure)").remove(),this.initializeColumns()},render:function(){if(this.processingData.rendered)return this;this.hide(),this.$el.css({width:this.parent.dimensions.innerSectionWidth,height:this.parent.dimensions.innerSectionHeight});var a=this.parent.unplacedFigures,b=a.length;for(var c=0;c<b;c++){var d=this.addFigure(a[c]);d&&this.parent.unplacedFigures.splice(c,1)}return this.initializeColumns(),this.processingData.rendered=!0,this},layoutContent:function(){var a="none",b=this.getCurrentColumn();if(b===null)return this.processingComplete(),a="contentOverflow",a;var c=$(this.model.get("content")[this.model.get("content").length-1]);b.$el.append(c);var d=parseFloat(c.css("line-height"));if(b.height-c.position().top<d)return c.remove(),b.heightRemain=0,a="contentOverflow",a;var e=c.outerHeight(!0),f=0;b.offset<0&&(f=e+b.offset,c.css("margin-top","-"+f+"px"),b.offset=0);var g=c.find("a.figure_reference");c.hasClass("figure_reference")&&g.push(c);var h=g.length;if(h)for(var i=0;i<h;i++){var j=$(g[i]),k=j.attr("href").substring(1),l=app.collections.figures.get(k),m=j.position().top;if(m<=0||m>=b.height)break;var n=l.get("type"),o=app.config.get("figureViewTypeMap"),p=o[n]?o[n]:o["default"],q=this.parent.getFigureView(l.get("id"));q||(q=new OsciTk.views[p]({model:l,sectionDimensions:this.parent.dimensions}));if(!q.layoutComplete&&this.addFigure(q))return a="figurePlaced",a}var r={top:parseInt(c.css("margin-top"),10),bottom:parseInt(c.css("margin-bottom"),10)},s=b.heightRemain-c.outerHeight(!0);s>0&&s<d?s=0:s<0&&s>=r.bottom*-1&&(s=0);if(s<0){var t=s,u=Math.ceil(t/d),v=c.position().top+c.outerHeight()+u*d;b.height=v,b.$el.height(v+"px"),u===0?(s=0,a="none"):(s=u*d-r.bottom,a="contentOverflow"),this.processingData.currentColumn===this.parent.dimensions.columnsPerPage-1&&this.processingComplete()}return s===0&&this.processingData.currentColumn===this.parent.dimensions.columnsPerPage-1&&this.processingComplete(),b.heightRemain=s,a},getCurrentColumn:function(){var a=null,b=parseInt(this.$el.css("line-height"),10)*this.parent.dimensions.minLinesPerColumn;if(this.processingData.columns[this.processingData.currentColumn]&&this.processingData.columns[this.processingData.currentColumn].height>=b&&this.processingData.columns[this.processingData.currentColumn].heightRemain>0)a=this.processingData.columns[this.processingData.currentColumn];else for(var c=0;c<this.parent.dimensions.columnsPerPage;c++)if(this.processingData.columns[c].height>=b&&this.processingData.columns[c].heightRemain>0){a=this.processingData.columns[c],this.processingData.currentColumn=c;break}if(a!==null&&a.$el===null){if(this.processingData.currentColumn>0)a.offset=this.processingData.columns[this.processingData.currentColumn-1].heightRemain;else{var d=this.parent.getChildViewByIndex(this.parent.getChildViews().length-2);d&&(a.offset=d.processingData.columns[d.processingData.columns.length-1].heightRemain)}var e={width:this.parent.dimensions.columnWidth+"px",height:a.height+"px",left:this.processingData.columns[this.processingData.currentColumn].position.left,top:this.processingData.columns[this.processingData.currentColumn].position.top};a.$el=$(this.columnTemplate()).appendTo(this.$el).addClass("column-"+this.processingData.currentColumn).css(e)}return a},initializeColumns:function(){this.processingData.columns=[];var a=this.getChildViewsByType("figure"),b=a.length;for(var c=0;c<this.parent.dimensions.columnsPerPage;c++){var d=c*this.parent.dimensions.columnWidth+this.parent.dimensions.gutterWidth*c,e=this.parent.dimensions.innerSectionHeight,f=0,g={x:[d,d+this.parent.dimensions.columnWidth],y:[f,f+e]};if(b)for(var h=0;h<b;h++){var i=a[h].position.x,j=a[h].position.y;if(g.x[0]<i[1]&&g.x[1]>i[0]&&g.y[0]<j[1]&&g.y[1]>j[0]){e=e-a[h].calculatedHeight-this.parent.dimensions.gutterWidth;switch(a[h].model.get("position").vertical){case"t":case"p":f=f+a[h].calculatedHeight+this.parent.dimensions.gutterWidth;break;case"b":f=f}g.y=[f,f+e]}}this.processingData.columns[c]={height:e,heightRemain:e>0?e:0,$el:null,offset:0,position:{left:g.x[0],top:g.y[0]}}}this.processingData.currentColumn=0},addFigure:function(a){var b=!1;return this.addView(a),a.layoutComplete||(a.render(),a.layoutComplete?b=!0:(b=!1,this.removeView(a,!1),a.$el.detach(),this.parent.unplacedFigures.push(a))),b}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.views=="undefined"&&(OsciTk.views={}),OsciTk.views.MultiColumnSection=OsciTk.views.Section.extend({template:OsciTk.templateManager.get("multi-column-section"),initialize:function(){this.options.pageView="MultiColumnPage",app.dispatcher.on("windowResized",function(){var a,b=this.getChildViewByIndex(app.views.navigationView.page-1),c=b.$el.find("[id]:first");c.length&&(a=c.attr("id")),a&&(app.views.navigationView.identifier=a),this.rerender()},this),app.dispatcher.on("navigate",function(a){var b=1;if(a.page)b=a.page;else if(a.identifier)switch(a.identifier){case"end":b=this.model.get("pages").length;break;case"start":b=1;break;default:var c=this.getPageForElementId(a.identifier);c!==null?b=c:(b=1,console.log("id",a.identifier,"not found in any page"))}this.getChildViewByIndex(b-1).show();var d=(b-1)*this.dimensions.innerSectionHeight*-1,e=this.getChildViews(),f=e.length;for(var g=0;g<f;g++)g!==b-1&&e[g].hide();this.$el.find("#pages").css("-webkit-transform","translate3d(0, "+d+"px, 0)"),app.dispatcher.trigger("pageChanged",{page:b})},this),this.$el.addClass("oscitk_multi_column"),_.defaults(this.options,{minColumnWidth:200,maxColumnWidth:300,gutterWidth:40,minLinesPerColumn:5}),this.dimensions={},OsciTk.views.MultiColumnSection.__super__.initialize.call(this)},renderContent:function(){this.$el.html(this.template()),this.calculateDimensions(),this.layoutData={data:this.model.get("content"),items:null},this.cleanData(),this.unplacedFigures=[],this.layoutData.items=this.layoutData.data.length;var a=0,b=!0,c=0;while(this.layoutData.items>0){var d=this.getPageForProcessing(undefined,"#pages");d.processingData.rendered||(c=0,d.render());var e=$(this.layoutData.data[a]).clone();b&&e.attr("id","osci-content-"+a);var f=d.addContent(e).layoutContent();switch(f){case"contentOverflow":b=!1;break;case"figurePlaced":d.resetPage(),this.layoutData.items+=c,a-=c,c=0;break;default:a++,this.layoutData.items--,c++,b=!0}}},calculateDimensions:function(){var a=this.dimensions,b=$(window).width(),c=$(window).height();if(a.windowWidth&&a.windowWidth===b&&a.windowHeight&&a.windowHeight===c)return;a.windowHeight=c,a.windowWidth=b,a.gutterWidth=this.options.gutterWidth,a.minLinesPerColumn=this.options.minLinesPerColumn,a.sectionMargin={left:parseInt(this.$el.css("margin-left"),10),top:parseInt(this.$el.css("margin-top"),10),right:parseInt(this.$el.css("margin-right"),10),bottom:parseInt(this.$el.css("margin-bottom"),10)},a.sectionPadding={left:parseInt(this.$el.css("padding-left"),10),top:parseInt(this.$el.css("padding-top"),10),right:parseInt(this.$el.css("padding-right"),10),bottom:parseInt(this.$el.css("padding-bottom"),10)},a.outerSectionHeight=c-a.sectionMargin.top-a.sectionMargin.bottom,a.innerSectionHeight=a.outerSectionHeight-a.sectionPadding.top-a.sectionPadding.bottom,a.outerSectionWidth=this.$el.outerWidth(),a.innerSectionWidth=a.outerSectionWidth-a.sectionPadding.left-a.sectionPadding.right,a.innerSectionWidth<this.options.maxColumnWidth?a.columnWidth=a.innerSectionWidth:a.columnWidth=this.options.maxColumnWidth,a.columnsPerPage=Math.floor(a.innerSectionWidth/a.columnWidth),a.innerSectionWidth<a.columnsPerPage*a.columnWidth+(a.columnsPerPage-1)*this.options.gutterWidth&&(a.columnsPerPage=a.columnsPerPage-1);var d=(a.innerSectionWidth-a.columnsPerPage*a.columnWidth)/(a.columnsPerPage-1);d>this.options.gutterWidth&&(a.columnWidth=(a.innerSectionWidth-this.options.gutterWidth*(a.columnsPerPage-1))/a.columnsPerPage),this.dimensions=a},cleanData:function(){this.layoutData.data.find("#figures").remove(),this.layoutData.data.find("#footnotes").remove();var a=OsciTk.templateManager.get("figure-reference"),b=this.layoutData.data.find("figure").replaceWith(function(){var b=$(this),c={id:b.attr("id"),title:b.attr("title")};return $(a(c))});this.layoutData.data=this.layoutData.data.find("section").children()},getFigureView:function(a){var b=this.getChildViews(),c,d=b.length;for(var e=0;e<d;e++){var f=b[e].getChildViewsByType("figure"),g=f.length;for(var h=0;h<g;h++)if(a===f[h].$el.attr("id")){c=f[h];break}if(c)break}return c}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.views=="undefined"&&(OsciTk.views={}),OsciTk.views.Navigation=OsciTk.views.BaseView.extend({id:"navigation",numPages:null,identifier:null,currentNavigationItem:null,page:null,template:OsciTk.templateManager.get("navigation"),initialize:function(){app.dispatcher.on("layoutComplete",function(a){this.identifier?(app.dispatcher.trigger("navigate",{identifier:this.identifier}),this.identifier=null):app.dispatcher.trigger("navigate",{page:1}),this.numPages=a.numPages,this.render()},this),app.dispatcher.on("pageChanged",function(a){this.page=a.page,this.update(a.page)},this),app.dispatcher.on("routedToSection",function(a){this.identifier=a.identifier,a.section_id?this.setCurrentNavigationItem(a.section_id):this.setCurrentNavigationItem(app.collections.navigationItems.at(0).id)},this),$(document).keydown(function(a){switch(a.which){case 39:var b=app.views.navigationView.page+1;if(b>app.views.navigationView.numPages){var c=app.views.navigationView.currentNavigationItem.get("next");c&&app.router.navigate("section/"+c.id,{trigger:!0})}else app.dispatcher.trigger("navigate",{page:b});break;case 37:var b=app.views.navigationView.page-1;if(b<1){var d=app.views.navigationView.currentNavigationItem.get("previous");d&&app.router.navigate("section/"+d.id+"/end",{trigger:!0})}else app.dispatcher.trigger("navigate",{page:b})}})},render:function(){this.$el.html(this.template({numPages:this.numPages,chapter:this.currentNavigationItem.get("title")})),this.numPages==1?$(".pager").hide():$(".pager").show();var a=100/this.numPages;$(".pager .head",this.$el).css("width",a+"%"),$(".pager").mousedown(function(a){var b=parseInt(app.views.navigationView.numPages*a.offsetX/$(this).width(),10);app.dispatcher.trigger("navigate",{page:b+1})}),this.update(this.page)},getCurrentNavigationItem:function(){return this.currentNavigationItem},setCurrentNavigationItem:function(a){this.currentNavigationItem=app.collections.navigationItems.get(a),app.dispatcher.trigger("currentNavigationItemChanged",this.currentNavigationItem)},update:function(a){var b=100/this.numPages;$(".pager .head",this.$el).css("left",b*(a-1)+"%"),this.$el.find(".prev-page").unbind("click"),this.$el.find(".next-page").unbind("click");if(a==1){var c=this.currentNavigationItem.get("previous");c?(this.$el.find(".prev-page .label").html("Previous Section"),this.$el.find(".prev-page").removeClass("inactive").click(function(){app.router.navigate("section/"+c.id+"/end",{trigger:!0})})):$(".prev-page",this.$el).addClass("inactive").unbind("click")}else if(this.numPages>1){var d=this;this.$el.find(".prev-page .label").html("Previous"),this.$el.find(".prev-page").removeClass("inactive").click(function(){app.router.navigate("section/"+d.currentNavigationItem.id),app.dispatcher.trigger("navigate",{page:a-1})})}if(a==this.numPages){var e=this.currentNavigationItem.get("next");e?(this.$el.find(".next-page .label").html("Next Section"),this.$el.find(".next-page").removeClass("inactive").click(function(){app.router.navigate("section/"+e.id,{trigger:!0})})):this.$el.find(".next-page").addClass("inactive").unbind("click")}else this.numPages>1&&(this.$el.find(".next-page .label").html("Next"),this.$el.find(".next-page").removeClass("inactive").click(function(){app.dispatcher.trigger("navigate",{page:a+1})}))}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.views=="undefined"&&(OsciTk.views={}),OsciTk.views.Notes=OsciTk.views.BaseView.extend({className:"notes-view",template:OsciTk.templateManager.get("notes"),initialize:function(){app.collections.notes.bind("add remove",function(){this.render()},this)},render:function(){return this.$el.html(this.template({notes:app.collections.notes.toJSON()})),this}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.views=="undefined"&&(OsciTk.views={}),OsciTk.views.SearchResults=OsciTk.views.BaseView.extend({id:"search-results-container",template:OsciTk.templateManager.get("search-results"),initialize:function(a){console.log(a),this.searchResults=new OsciTk.collections.SearchResults({docs:a.docs}),this.render()},render:function(){this.$el.html(this.template())}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.views=="undefined"&&(OsciTk.views={}),OsciTk.views.SearchResult=OsciTk.views.BaseView.extend({id:"search-results-container",template:OsciTk.templateManager.get("search-result"),initialize:function(a){this.render()},render:function(){this.$el.html(this.template())}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.views=="undefined"&&(OsciTk.views={}),OsciTk.views.Search=OsciTk.views.BaseView.extend({id:"search-view",className:"toolbar-item-view",template:OsciTk.templateManager.get("search"),searchResults:new OsciTk.collections.SearchResults,page:0,query:"",filters:null,sort:null,initialize:function(){app&&app.collections&&(app.collections.searchResults=this.searchResults)},events:{"submit #search-form":"search"},render:function(){this.$el.html(this.template(this))},search:function(a){a.preventDefault();var b=this.query=this.$el.find("#search-keyword").val(),c=this;$.ajax({url:app.config.get("endpoints").OsciTkSearch+"?key="+b+"&filters=type:note",type:"POST",success:function(a){var d=JSON.parse(a);_.each(d.docs,function(a){c.searchResults.add(a)}),c.searchResults.keyword=b,c.render(),c.parent.contentOpen()}})}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.views=="undefined"&&(OsciTk.views={}),OsciTk.views.Toc=OsciTk.views.BaseView.extend({className:"toc-view",template:OsciTk.templateManager.get("toc"),events:{"click li a":"itemClick"},initialize:function(){this.parent=this.options.parent},render:function(){this.$el.html(this.template({items:app.collections.navigationItems.where({depth:0})}))},itemClick:function(a){a.preventDefault();var b=$(a.currentTarget).attr("data-section-id");app.router.navigate("section/"+b,{trigger:!0}),this.parent.contentClose()}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.views=="undefined"&&(OsciTk.views={}),OsciTk.views.ToolbarItem=OsciTk.views.BaseView.extend({className:"toolbar-item",template:OsciTk.templateManager.get("toolbar-item"),initialize:function(){this.$el.addClass(this.options.toolbarItem.view+"-toolbar-item"),this.contentView=null,this.contentViewRendered=!1},events:{click:"itemClicked",touch:"itemClicked"},render:function(){this.contentView=new OsciTk.views[this.options.toolbarItem.view]({parent:this}),this.parent.addView(this.contentView,"#toolbar-content"),this.$el.html(this.template({text:this.options.toolbarItem.text}))},itemClicked:function(){this.contentViewRendered||(this.contentView.render(),this.contentViewRendered=!0);var a;this.parent.isContentOpen===!1?(this.parent.activeContentView=this.options.toolbarItem.view,a=this.parent.$el.find("#toolbar-content").children().not("#"+this.contentView.id),_.each(a,function(a){$(a).hide()},this),this.contentView.$el.show(),this.parent.contentOpen()):this.parent.activeContentView==this.options.toolbarItem.view?(this.parent.activeContentView=null,this.parent.contentClose()):(this.parent.activeContentView=this.options.toolbarItem.view,a=this.parent.$el.find("#toolbar-content").children().not("#"+this.contentView.id),_.each(a,function(a){$(a).hide()},this),this.contentView.$el.show(),this.parent.contentOpen())}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.views=="undefined"&&(OsciTk.views={}),OsciTk.views.Toolbar=OsciTk.views.BaseView.extend({id:"toolbar",template:OsciTk.templateManager.get("toolbar"),initialize:function(){this.toolbarItems=app.config.get("toolbarItems")?app.config.get("toolbarItems"):[],this.toolbarItemViews=[],this.isContentOpen=!1,this.render()},events:{"click #toolbar-close":"contentClose"},render:function(){this.$el.html(this.template()),_.each(this.toolbarItems,function(a){var b=new OsciTk.views.ToolbarItem({toolbarItem:a});this.addView(b,"#toolbar-handle"),b.render()},this)},contentOpen:function(){var a=this.$el.find("#toolbar-content"),b=this.$el.find("#toolbar-handle").outerHeight(),c=a.outerHeight()+b,d=parseInt(this.$el.css("max-height"),10),e=$(window).height()*(d/100);c>e&&a.height(e-b),this.$el.animate({height:c+"px"},"fast"),$("#toolbar-close").animate({top:"10px"},"fast"),this.isContentOpen=!0},contentClose:function(){$("#toolbar-close").animate({top:"-"+$("#toolbar-close").height()+"px"},"fast"),this.$el.animate({height:this.$el.find("#toolbar-handle").outerHeight()+"px",width:"100%"},"fast"),this.isContentOpen=!1}}),app={dispatcher:undefined,router:undefined,config:undefined,views:{},models:{},collections:{},bootstrap:function(a){this.dispatcher=_.extend({},Backbone.Events),this.config=new OsciTk.models.Config(a),this.router=new OsciTk.router,this.account=new OsciTk.models.Account,this.collections.notes=new OsciTk.collections.Notes,this.collections.figures=new OsciTk.collections.Figures,this.collections.footnotes=new OsciTk.collections.Footnotes,this.collections.navigationItems=new OsciTk.collections.NavigationItems,window.onresize=function(){window.resizeTimer&&clearTimeout(window.resizeTimer);var a=function(){app.dispatcher.trigger("windowResized")};window.resizeTimer=setTimeout(a,200)},this.views.app=new OsciTk.views.App,this.models.docPackage=new OsciTk.models.Package({url:this.config.get("packageUrl")})},run:function(){Backbone.history.start()}};